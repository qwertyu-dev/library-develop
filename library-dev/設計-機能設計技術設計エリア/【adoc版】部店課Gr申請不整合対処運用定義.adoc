= 申請不整合チェック機能 設計書

== 背景と目的

=== 現状の課題

現行の部署情報管理システムにおいては、以下の課題が存在する：

* 部店申請と配下組織の申請の不整合
* 申請タイミングのずれによる一時的なデータ不整合
* 人手による確認作業の負荷と人為的ミスのリスク
* 複雑な組織変更に対する柔軟な対応の困難さ

これらの課題により、データの正確性低下、業務効率の悪化、関連システムへの影響が懸念される。

=== 本機能の目的

申請不整合チェック機能を導入することで、以下の目的を達成する：

* 申請データの整合性向上
* 人手による確認作業の負荷軽減
* システムによる自動チェックと人間の判断の適切な組み合わせ
* 複雑な組織変更にも対応可能な柔軟なチェック機構の実現

=== 期待される効果

* データ品質の向上：不整合の早期発見と修正
* 業務効率の改善：自動チェックによる作業時間の短縮
* リスク低減：人為的ミスの減少
* 柔軟性の向上：様々な申請パターンへの対応力強化

== 申請不整合チェック機能の概要

=== 機能の位置づけ

[plantuml]
----
@startuml
rectangle "一括申請" {
  rectangle "申請不整合チェック(運用整合性)" as check
  rectangle "受付〜" as existing
}
rectangle "人事部" as hr
rectangle "国企" as international
rectangle "関連" as affiliate
rectangle "連携システム" as related

hr --> check : 申請(部店)
international --> check : 申請(部配下組織)
affiliate --> check : 申請(部配下組織)
check --> existing : 整合性判定
existing --> related : データ連携
@enduml
----

=== 主要な機能項目

* 申請データの整合性チェック
* エラー・警告の検出と通知
* 人間の判断支援
* 例外的なケースの処理

== システムチェッカーの設計

=== チェック項目の定義

[options="header", cols="1,2,6,1,1"]
|===
|ID   |チェック項目     |説明                                                             |重要度 |分類
|C001 |部店コード整合性 |親部店コードと子部店コードの関連性を確認                         |高     |エラー
|C002 |課Grコード整合性 |部店コードと課Grコードの関連性を確認                             |高     |エラー
|C003 |申請種類整合性   |新設・変更・廃止の申請種類の論理的整合性を確認                   |高     |エラー
|C004 |申請日付妥当性   |申請日付が有効範囲内であることを確認                             |中     |警告
|C005 |既存データ整合性 |申請内容と既存の組織データとの整合性を確認                       |高     |エラー
|C006 |名称変更整合性   |部店名称や課Gr名称の変更の妥当性を確認                           |中     |警告
|C007 |階層構造整合性   |組織の階層構造が正しく維持されていることを確認                   |高     |エラー
|C008 |廃止整合性       |廃止申請に関連する全ての部署情報が適切に処理されていることを確認 |高     |エラー
|C009 |重複申請チェック |同一部署に対する重複申請がないことを確認                         |中     |警告
|C010 |反映日整合性     |申請された反映日が業務カレンダーと整合していることを確認         |中     |警告
|===

=== エラー・警告の分類

[options="header", cols="1,4,3"]
|===
|分類   |定義                                       |対応
|エラー |データの整合性を著しく損なう重大な問題     |修正必須。申請プロセスを停止
|警告   |データの品質に影響を与える可能性がある問題 |確認推奨。申請者に通知し、必要に応じて修正
|===

== 人間による判断とシステムチェッカーの連携

=== 役割分担

[options="header", cols="1,1,1 ", width="75%"]
|===
|項目 |システムチェッカー責務 |人間判断（申請者/承認者）
|基本的な整合性チェック |○ 自動実行 |－
|数値・コードの妥当性確認 |○ 自動実行 |－
|エラー・警告の検出 |○ 自動実行 |－
|検出結果の通知 |○ 自動実行 |－
|エラー・警告の初期判断 |○ 自動分類 |－
|複雑なケースの判断 |△ 判断材料の提供 |○ 最終判断
|例外的なケースの処理 |△ 事前定義ルールの適用 |○ 最終判断
|申請内容の妥当性確認 |－ |○ 確認・承認
|システム判断の妥当性確認 |－ |○ 必要に応じて確認
|最終承認 |－ |○ 承認処理の実行
|===

=== エスカレーションプロセス

[plantuml]
----
@startuml
start
:システムチェッカーがエラーまたは警告を検出;
:エラー・警告の重要度と種類を判定;
if (自動判断可能?) then (yes)
  :自動処理を実行;
else (no)
  :担当者に通知;
  :担当者が問題を確認;
  if (申請部署に確認必要?) then (yes)
    :検出エラーから状況を申請部署と共有;
    :申請を再提出依頼;
    :再申請を受領;
    :再処理実施;
  else (no)
    :上位承認者に割り切り続行判断を依頼;
    if (承認?) then (yes)
      :申請処理後続を実行;
    else (no)
      :処理中断;
      :検出エラーから状況を申請部署と共有;
      :申請を再提出依頼;
      :再申請を受領;
      :再処理実施;
    endif
  endif
endif
:判断/処理結果を申請部署と共有;
stop
@enduml
----

=== 判断基準と運用ガイドライン

.判断基準
[options="header", cols="1, 3"]
|===
| 区分              |ガイドライン
|エラーレベルの問題 |原則として、システムが検出したエラーは全て対応が必要
|エラーレベルの問題 |例外的に承認する場合は、その理由を明確に記録すること
|警告レベルの問題   |警告の内容を精査し、業務上の影響を評価すること
|警告レベルの問題   |軽微な警告で、説明可能な理由がある場合は、承認して良い
|例外的なケース     |事前に定義された例外ルールに合致するか確認
|例外的なケース     |前例がある場合は、過去の判断結果を参照
|例外的なケース     |新規の例外ケースの場合、関係部署と協議の上で判断
|===

.運用ガイドライン
[options="header", cols="1, 3"]
|===
|タスク            |ガイドライン
|確認手順          |システムチェッカーの結果を必ず確認すること
|確認手順          |エラー・警告の内容を理解し、必要に応じて関連データを参照すること
|確認手順          |判断に迷う場合は、必ず上位承認者や関係部署に相談すること
|修正・再申請      |軽微な修正の場合、申請者に修正を依頼し、再チェックを実施
|修正・再申請      |大幅な修正が必要な場合、申請を差し戻し、再申請を要請
|承認・否認        |承認する場合、その判断理由を明確に記録すること
|承認・否認        |否認する場合、詳細な理由と今後の対応方針を申請者に通知すること
|記録と報告        |全ての判断プロセスと結果をシステム上に記録すること
|記録と報告        |重要な判断や新規の例外ケースについては、定期報告の対象とすること
|継続的改善        |頻出する問題や判断が困難なケースについて、定期的に見直しを行うこと
|継続的改善        |必要に応じて、チェックロジックの改善や新たな例外ルールの追加を検討すること
|===

== 運用制約と例外処理

=== 5営業日前処理期間の制約

* 制約の概要
** 反映日の5営業日前から、原則として新規の申請処理を制限する
** この期間での再修正処理は緊急対応のみを許可する(すでに反映済範囲を確認の上判断)

* 制約期間の判定方法 +
いくつかの手段があり詳細設計フェーズで手法選択する +
** 銀行営業日カレンダーを参照し、反映日から遡って5営業日を自動的に計算する
** リファレンステーブルデータ状況から判断する 
** ５営業日処理期間に入ったことをシステム担当者に通知する

* 制約期間中の処理
** 原則として受け付けない。緊急性の高い申請は特別承認プロセスを経る
** ５営業日前処理からリファレンステーブル反映まで完了後、新たに申請処理を開始する

=== 例外的な処理の方針

[options="header", cols="1,2,2"]
|===
|例外ケース   |説明 |対応方針
|緊急組織変更 |経営判断による急な組織変更 
a| * 特別承認プロセスを経て受付 
* チェック項目の一部を緩和 +
* 事後的な整合性確保を必須とする
|システム障害時の処理 |チェッカーが利用不能な場合 
a| * 手動チェックリストを使用 
* 障害復旧後に再チェックを実施
|大規模組織再編 |通常より大量の申請が発生 
a| * 事前に専用の処理計画を策定 
* チェック処理の分散実行を検討
|遡及的な組織変更 |過去に遡って組織を変更 
a| * 影響範囲の詳細分析を必須
* 関連システムとの整合性確認を強化
|特殊な組織形態 |通常のルールに適合しない組織 
a| * 個別にチェックルールを定義
* 定期的に妥当性を再確認
|===

=== Stop範囲の定義
### TODO(Suzuki)
データ申請不整合を検出した際、問題のある部店申請及び課Gr申請のみにStopをかけて他のデータは通過させるのか、申請断面(申請タイミングは同時期が必要)単位でデータをStopするのか判断が必要となる。 +
詳細設計フェーズで運用シナリオ検証を行い両Stop基準の適用妥当性を検証し決定する。

* 部分的停止
** 対象：特定の部店や課に関連する申請のみ
** 条件：検出された問題が局所的で、他の申請に影響しない場合
** 処理：問題のある申請のみを停止し、他の申請は通常通り進行

* 全体停止
** 対象：当該申請グループ全体
** 条件：以下のいずれかに該当する場合
*** 複数の部店や課にまたがる重大な整合性エラーを検出
*** システム全体に影響を与える可能性がある問題を検出
*** 大規模な組織再編など、全体的な確認が必要な場合
** 処理：全ての申請処理を一時停止し、問題の影響範囲を詳細に分析

* Stop範囲の判断基準

[options="header",cols="2,1,1" width="60%"]
|===
|判断基準             |部分的停止 |全体停止
|エラーの重大度       |低～中     |高
|影響範囲             |局所的     |広範囲
|他申請との関連性     |低い       |高い
|システム全体への影響 |なし       |あり
|人的判断の必要性     |一部必要   |全体的に必要
|===

* Stop後のプロセス
. 問題の詳細分析
. 影響範囲の特定
. 修正方針の決定
. 必要に応じた申請の差し戻しまたは修正
. 再チェックの実施
. 問題解決の確認
. 処理再開の判断と承認

== 問題検出詳細定義

=== 検出パターン構成

問題検出詳細は、以下の要素で構成される：

1. 問題ID：一意の識別子
2. 問題カテゴリ：問題の種類や性質による分類
3. 問題の詳細説明：具体的な問題内容
4. 影響度：問題が与える影響の大きさ（高・中・低）
5. 検出方法：システムによる自動検出か人間による確認か
6. 対応策：問題解決のための具体的なアクション
7. 担当部署：問題対応の主担当となる部署

=== 主要な問題パターンと対応策

#### TODO(suzuki) 西川さんまとめチェックパターンふまえて再編予定

[options="header", cols="1,2,4,1,2,4,2"]
|===
|問題ID |問題カテゴリ |問題の詳細説明 |影響度 |検出方法 |対応策 |担当部署
|P008 |反映日不整合 |関連する申請間で反映日に乖離がある |中 |システム自動 
a| * 反映日の調整 
* 申請者間の調整 |人事部、国企、関連
|P009 |反映タイミン反映タイミング不整合 | 部店/課Gr明細の反映順不備によるデータ矛盾 |高 |システム自動 
a| * 申請部門の望む反映状態を確認
* 認識確認後の追加申請状態、理由確認
* 割り切り前提での制約合意 |システム部,人事及び国企・関連
|===


== 決定事項と未決事項

=== 決定事項一覧

* システム全体の構成
* チェック項目
* エスカレーションプロセス
* 5営業日前処理期間の制約
* 問題検出詳細マトリックス
* 段階的実装計画

=== 未決事項と決定スケジュール

[options="header"]
|===
|項目                                    |内容                                           |決定時期              |担当
|チェック項目の範囲                      |FP/FNのリスク・バランスをふまえた検出事項定義  | TODO(suzuki)計画策定 |システム部
|チェックロジックの詳細仕様              |各チェック項目の具体的なロジックとアルゴリズム | TODO(suzuki)計画策定 |システム部
|パフォーマンスチューニングの具体的手法  |処理時間短縮のための最適化手法の選定           | TODO(suzuki)計画策定 |システム部
|例外処理の詳細ルール                    |各例外ケースに対する具体的な処理ルール         | TODO(suzuki)計画策定 |人事部、システム部
|運用体制の詳細                          |新システム導入後の具体的な運用体制と役割分担   | TODO(suzuki)計画策定 |システム部
|===
