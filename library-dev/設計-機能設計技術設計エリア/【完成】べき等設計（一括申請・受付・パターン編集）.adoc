= 銀行部署情報管理システム 冪等性設計書
:toc:
:toc-title: 目次
:sectnums:
:icons: font

== はじめに

=== 本文書の目的

本文書は、銀行の部署情報管理システムにおける冪等性の確保とリラン運用の設計を記述することを目的としています。

=== システム概要

本システムは、銀行の部署情報のデータを管理し、変更申請を処理します。主に以下の3つのフェーズで構成されています：

. 一括申請フェーズ
. 受付フェーズ
. パターン編集フェーズ

=== 冪等性の定義と重要性

==== 本システムにおける冪等性の定義

本システムにおける冪等性は以下のように定義します：

* 同一の入力データに対して、処理を複数回実行しても、最終的なシステムの状態が常に同一になること
* 一括申請からのやり直しにより、一貫性のあるデータ処理を保証すること
* 出力データの上書きリプレースにより、データの整合性を維持すること

==== 冪等性確保の意義

* データの一貫性維持
* エラーリカバリの容易化
* システムの信頼性向上
* 運用の簡素化

== 冪等性の基本方針

=== 一括申請からのやり直し

エラーや不整合が検出された場合、一括申請〜受付〜パターン編集においては、常に一括申請フェーズから処理をやり直しを原則とします。

.利点
* データの一貫性確保
* 処理の単純化
* デバッグの容易さ

=== 出力データの上書きリプレース

リラン時には、既存の出力データを新しい処理結果で完全に上書きします。

.利点
* データの一貫性確保

== リラン運用設計

.リラン運用設計の主要項目
[cols="1,2", options="header"]
|===
|項目 |内容
|リラン判断基準
a|
* システム障害時（処理の異常終了、タイムアウト、システムクラッシュ）
* データ不整合検出時（バリデーションエラー、予期せぬデータ状態）

|リラン実行手順
a|
. 入力データの再検証
. 一括申請フェーズから処理を再開
. 全フェーズを通じて処理を実行
. 最終的な整合性チェック

|データ整合性確保
a|
* 新しい処理結果で既存データを完全に上書きリプレース
* 置換前のデータのバックアップ作成はしない
|===


== 使用技術

=== ULID

* 各処理のユニーク識別子生成に使用
* 処理の追跡性向上と冪等性確保に貢献

=== ロギング

* 各処理フェーズの詳細情報を記録
* 問題分析と冪等性の検証に使用

=== JOB分割

* 各処理フェーズを独立したJOBとして実装
* フェーズの独立性確保と部分的な再実行を可能に

[plantuml, format=png]
....
@startuml
component "一括申請JOB" as Job1
component "受付JOB" as Job2
component "パターン編集JOB" as Job3
database "リファレンスDB" as DB

Job1 -> Job2 : ULID付きデータ
Job2 -> Job3 : ULID付きデータ
Job3 -> DB : 処理結果反映

note right of Job1 : ULID生成
note bottom of Job2 : ロギング
note bottom of Job3 : ロギング
@enduml
....
