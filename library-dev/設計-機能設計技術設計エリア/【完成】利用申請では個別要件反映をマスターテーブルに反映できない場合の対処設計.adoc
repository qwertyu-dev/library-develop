= 申請明細では個別対処要件が反映されないColumnへの対応策設計

== はじめに

=== 目的
本文書は、リファレンステーブルに関する保守設計を詳述することを目的としています。 +

組織変更や個別要件によりパターン編集定義更新だけでなく、リファレンステーブル既存明細に対しても個別要件適用の更新が必要になります。一部のColumnは申請明細になく、システム判断で編集されるものもあります。利用者からの申請により個別要件適用後の新ルールで更新するトリガーとなる場合もありますが、申請側からすると「何を更新するよう申請するのか？」自明でない状態であり、個別要件をリファレンステーブル既存明細に適用するための申請明細は起票されない運用となります。

従って該当するColumnに対しては、システム管理者側で個別の対象が必要になるものとし、その対応定義を行います。 

== 改修アプローチ

=== 改修案の概要
以下の3つのアプローチを準備します

* 案1: パターン編集向け明細作成
* 案2: リクエストテーブル向けの更新明細作成
* 案3: テーブル更新パッチ作成


[plantuml]
----
@startuml
skinparam componentStyle rectangle
skinparam noteLinkStyle dashed
left to right direction

[一括申請] --> [受付]
[受付] --> [パターン編集]
[パターン編集] --> [反映]

database "リクエスト明細"
database "マスターテーブル"

[パターン編集] --> リクエスト明細
リクエスト明細 --> マスターテーブル
[反映] --> マスターテーブル

note left of [パターン編集] : 案1 パターン編集インプット
note right of [パターン編集] : 案2 パターン編集アウトプット
note bottom of [マスターテーブル] : 案3 直接更新パッチ発行
@enduml
----


=== 実施手段判定基準

[options="header"]
|===
|判定基準 |案1: パターン編集向け明細作成 |案2: リクエストテーブル向けの更新明細作成 |案3: テーブル更新パッチ作成
|時間猶予 |1週間以上 |3日〜1週間 | 緊急対処
|パターン編集反映ステータス |新要件編集ルール適用完了が必須 | 新要件編集ルール適用未済でも対応可能 | 依存しない
|データ量 |大量も可能（100件以上） |大量も可能（100件以上） |少量（10件未満）
|緊急度 |低（計画的に対応可能） |中（迅速な対応が望ましい） |高（即時対応が必要）
|===

== 案1: パターン編集向け明細作成

=== 概要
Excel入力テンプレートとPythonによるバリデーションチェックを組み合わせたアプローチを採用します。

=== パッチ作成工程

[options="header", cols="1, 2, 2, 2"]
|===
|コンポーネント |詳細 |利点 |注意点
|Excel入力テンプレート
|- 構造化されたデータ入力シート
- 基本的な入力規則適用
- ドロップダウンリスト活用
|- ユーザーフレンドリー
- 基本的なエラー防止
- 統一されたデータ形式
|- シート構造の厳密な管理が必要
- バージョン管理の重要性

|Pythonバリデーションスクリプト
|- Excel読み取り機能
- 詳細なチェックロジック実装
- DB整合性確認
- エラーレポート生成
|- 高度なバリデーション
- 再利用可能なロジック
- 柔軟な拡張性
|- Excelとの入力形式の一致が必要
- 定期的な更新と保守が必要

|Validation部品
|- 既存部品の再利用
- カラム別にカスタマイズ
|- 開発効率の向上
- 信頼性の高いチェック
|- 部品の適切な選択と調整が必要

|統合プロセス
|- Excel入力→Python検証→結果確認→修正
|- 段階的なエラーチェック
- 人的ミスの最小化
|- プロセスの明確な文書化が必要
- ユーザートレーニングの重要性
|===

=== 主要コンポーネント
* Excel入力テンプレート
* Pythonバリデーションスクリプト
* Validation部品
* 統合プロセス

=== 実装手順
1. Excel入力テンプレートの設計と作成
2. 必要なValidation部品の特定と抽出
3. Pythonバリデーションスクリプトの開発
4. ExcelテンプレートとPythonスクリプトの統合テスト
5. ユーザーガイドとトレーニング資料の作成
6. 実環境での試験運用と調整

=== フロー図

[plantuml]
----
@startuml
title 案1: パッチ作成工程フロー

start

:Excel入力テンプレート作成;
note right: 構造化されたシート\n基本的な入力規則適用

:データ入力;

:Pythonバリデーションスクリプト実行;
note right: 既存Validation部品を再利用\nカラム別にカスタマイズ

if (バリデーション成功?) then (yes)
    :データを次のステップへ;
else (no)
    :エラーレポート生成;
    :データ修正;
    goto データ入力;
endif

:パターン編集処理;
:本番適用;
:反映・一括処理・送信;

stop

@enduml
----

== 案2: リクエストテーブル向けの更新明細作成

=== 概要
パターン編集処理後のデータレイアウトを前提に、Excel形式で作成されたデータをDataFrame形式に変換し、切り出したValidationセットを適用します。

=== パッチ作成工程

[options="header", cols="1, 2, 2, 2"]
|===
|コンポーネント |詳細 |利点 |注意点
|Excel入力テンプレート
|- パターン編集後レイアウトに準拠
- 基本的な入力規則適用
- ドロップダウンリスト活用
|- ユーザーフレンドリー
- パターン編集後データ構造の可視化
- 入力ミスの低減
|- パターン編集後レイアウトの正確な反映が必要
- 頻繁な更新の可能性

|データ変換スクリプト
|- Excel→DataFrame変換機能
- データ型の自動調整
|- データ形式の標準化
- 後続処理との互換性確保
|- Excel構造とDataFrame構造の厳密なマッピングが必要

|切り出しValidationセット
|- パターン編集後Validation処理の再利用
- DataFrame形式データに対応
|- 既存ロジックの活用
- 高度なバリデーション
|- 元のValidation処理からの適切な切り出しが必要
- パターン編集ロジックとの整合性確認

|統合プロセス
|- Excel入力→DataFrame変換→Validation適用→結果確認→修正
|- パターン編集後データの直接検証
- 効率的なエラー検出
|- プロセスの厳密な管理が必要
- エラー時のフィードバックループの確立
|===

=== 主要コンポーネント
* Excel入力テンプレート
* データ変換スクリプト
* 切り出しValidationセット
* 統合プロセス

=== 実装手順
1. パターン編集後レイアウトに基づくExcel入力テンプレートの設計と作成
2. Excel→DataFrame変換スクリプトの開発
3. パターン編集後Validation処理からの必要部品の切り出し
4. 切り出したValidationセットのDataFrame対応化
5. 統合プロセスの実装とテスト
6. ユーザーガイドとトレーニング資料の作成

=== フロー図

[plantuml]
----
@startuml
title 案2: パッチ作成工程フロー

start

:パターン編集後レイアウトに基づく\nExcel入力テンプレート作成;
note right: パターン編集後データ構造を反映

:データ入力;

:Excel→DataFrame変換;
note right: データ型の自動調整

:切り出しValidationセット適用;
note right: パターン編集後Validation\n処理の再利用

if (バリデーション成功?) then (yes)
    :データを後続フェーズへ引き渡し;
else (no)
    :エラーレポート生成;
    :データ修正;
    goto データ入力;
endif

:本番適用;
:反映・一括処理・送信;

stop

@enduml
----

== 案3: テーブル更新パッチ作成

=== 概要
テーブルを直接更新するPythonパッチコードを作成します。柔軟性が高い一方で、即時のValidationが効かないリスクがあります。

=== パッチ作成工程

[options="header", cols="1, 2, 2, 2"]
|===
|コンポーネント |詳細 |利点 |注意点
|Pythonパッチコード
|- テーブル直接更新ロジック
- 状況に応じた柔軟な実装
|- 高い柔軟性
- 迅速な対応が可能
|- 即時Validationの欠如
- 人的ミスのリスク増大

|コード作成ガイドライン
|- コーディング規約
- 推奨パターンの提示
|- コードの一貫性確保
- 品質維持の補助
|- 定期的な更新が必要
- 遵守の徹底が課題

|テスト用データセット
|- 代表的なケースを網羅
- エッジケースの包含
|- テストの効率化
- 潜在的問題の早期発見
|- データセットの維持管理
- 網羅性の確保

|コードレビュープロセス
|- 複数人によるレビュー
- チェックリストの使用
|- ミスの減少
- 知識の共有
|- レビュー時間の確保
- レビュアーのスキル依存

|送信フェーズValidation
|- 既存のValidation処理利用
- エラー検出と報告
|- 最終的な安全網
- 一貫性のある検証
|- 問題発見が遅れる
- 修正コストが高くなる可能性
|===

=== 主要コンポーネント
* Pythonパッチコード
* コード作成ガイドライン
* テスト用データセット
* コードレビュープロセス
* 送信フェーズValidation

=== 実装手順
1. 修正要件の詳細分析
2. Pythonパッチコードの設計と実装
3. テスト用データセットの準備
4. コードレビューの実施
5. テスト環境での動作確認
6. 本番環境への適用
7. 送信フェーズでのValidation結果確認

=== フロー図

[plantuml]
----
@startuml
title 案3: パッチ作成工程フロー

start

:修正要件の分析;

:Pythonパッチコード作成;
note right: テーブル直接更新ロジック実装

:コードレビュー実施;

if (レビュー通過?) then (yes)
    :テスト環境での動作確認;
else (no)
    :コード修正;
    goto コードレビュー実施;
endif

if (テスト成功?) then (yes)
    :本番環境へ適用;
else (no)
    :問題箇所の特定と修正;
    goto テスト環境での動作確認;
endif

:送信フェーズでのValidation;

if (Validation通過?) then (yes)
    :プロセス完了;
else (no)
    :エラー報告と分析;
    :修正計画立案;
    goto 修正要件の分析;
endif

stop

@enduml
----

== 比較評価

=== 各案の評価

[options="header", cols="1, 2, 2, 2"]
|===
|評価軸 |案1: 申請からの投入 |案2: リクエストテーブルへの明細作成パッチ/投入 |案3: パッチ作成
|制御の精度 |◎実運用コードでの対応、制御に問題はない |◎実運用コードでの対応、制御に問題はない |◎直接改修の制御下可能
|対応までの時間猶予 |局面による、時間余力あればパターン編集への新ルール反映も完了している |○時間的余力中程度、まずはデータの修正を前提に後からパターン編集定義追いつき |緊急対応
|トレーサビリティ |○フェーズを介しての確認、各フェーズ結果のチェック必要 |○フェーズを介しての確認、各フェーズ結果のチェック必要 |直接的、確認容易
|テスト性 |○フェーズを介しての確認、各フェーズ結果のチェック必要 |○フェーズを介しての確認、各フェーズ結果のチェック必要 |直接的、確認容易
|柔軟性 |○ルール前提、必要なルール下での作業 |○ルール前提、必要なルール下での作業 |どうとでもなる、ただし誤データ作成とトレードオフ
|開発コスト |○開発部門向けデータ生成シートなど工夫すれば |○開発部門向けデータ生成シートなど工夫すれば |○コードを書くスキルは必要、部品の再利用なども視野に入れる必要はある
|人的ミスのリスク |◎混入するリスクはあるがパターン編集のValidationで検出可能 |◎パターン編集のValidation相当を適用するコードを作ることでことで検出可能 |△人が気づけない可能性残る  送信フェーズで検出できる可能性はあるが検出が遅れる
|実装時間 |○レイアウト、整合性など確認しつつマニュアルでデータ作成  パターン編集定義更新前提 |○レイアウト、整合性など確認しつつマニュアルでデータ作成 + パターン編集定義更新異存なし |直接のゴールが見えてのパッチ作成作業,ただし対応明細量が大量だと実装時間急増懸念あり
|既存プロセスとの統合 |○フロー途中からの投入だがフェーズ制御に準拠と考えられる |○フロー途中からの投入だがフェーズ制御に準拠と考えられる |☓独自対応
|運用の簡素さ |○リグレからの投入 本番持ち上げの作業が発生 |○リグレからの投入 本番持ち上げの作業が発生 |◎本番実行のみ
|ロールバック |△リファレンス2世代前からのリラン、ただし不備のあったリクエスト明細の扱いの決め事が必要 |△リファレンス2世代前からのリラン、ただし不備のあったリクエスト明細の扱いの決め事が必要 |○2世代前からパッチ再投入
|データ整合性 |◎パターン編集後のValidationチェック利用が可能 |◎パターン編集後のValidationチェック利用が可能 |△送信フェーズで判明する可能性はあるが検出が遅れる
|修正用コード/明細作成の複雑度 |○人によるデータ作成に課題あり、データ整合性など仕組みでカバー |○人によるデータ作成に課題あり、データ整合性など仕組みでカバー |◎直接コードの改修、実装ルールの制定、難易度低いがコードを書ける要員維持が必要
|===



== 対応決定アプローチ
状況に応じて適切なアプローチを選択する必要があります。

* 案1: 時間的余裕があり、大規模な変更が必要な場合
* 案2: 中程度の緊急性で、既存プロセスとの整合性を保ちたい場合
* 案3: 緊急性が高く、限定的な変更が必要な場合

== 結論と推奨事項
* 3つの異なるアプローチを定義し、それぞれの特徴と適用条件を明記しています。
* 状況に応じて適切なアプローチを選択する運営とします。
* 対応の仕組み構築を予め行う必要があり、開発対応します。
* 定期的なレビューと更新を行い、システムの効率と信頼性を維持する運営が必要になります。