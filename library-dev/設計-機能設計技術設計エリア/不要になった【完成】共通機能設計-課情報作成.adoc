

= 課情報作成機能 機能設計書

== はじめに

=== 目的

本文書は、組織情報申請システムにおける課情報作成機能の詳細設計を記述することを目的としています。この文書は、システム開発者、テスト担当者、および将来的な保守担当者が参照することを想定しています。

=== 適用範囲

本設計書は、組織情報申請システムの一部である課情報作成機能に適用されます。具体的には、管理部署が「関連」に属する申請に対して、課情報を抽出し、pickle形式のファイルとして出力する機能を対象としています。

=== 参照ドキュメント

本設計書の作成にあたり、以下のドキュメントを参照しています。

1. 組織情報申請システム 要件定義書
2. 組織情報申請システム 基本設計書 

これらの文書は、本機能設計の背景となる要件や、システム全体の設計方針、関連するデータ構造の詳細を提供しています。本設計書を読む際には、必要に応じてこれらの文書も参照してください。

== システム概要

=== システムの目的

課情報作成機能は、組織情報申請システムの一部として、管理部署が「関連」に属する申請から課情報を抽出し、構造化されたデータとして保存することを目的としています。この機能により、関連部署の課情報を効率的に管理し、他のシステムやプロセスでの利用を容易にします。

=== システムの位置づけ

課情報作成機能は、組織情報申請システムの中で以下のように位置づけられます：

. 申請受付機能の後段で動作し、受付完了した申請データを入力として使用します。
. 抽出された課情報は、pickle形式のファイルとして出力され、他のシステムやプロセスでの利用に供されます。
. この機能は、組織情報マスター管理の一部として、最新の課情報を維持するために重要な役割を果たします。

== 機能要件

=== 課情報作成機能の概要

課情報作成機能は、以下の主要な処理を行います：

. 申請データからの管理部署の確認
.「関連」部署の申請に対する課情報の抽出
. 抽出した情報の構造化
. 構造化された課情報のpickle形式でのファイル保存

=== 対象データ

本機能が対象とするデータは以下の通りです：

. 入力データ: 組織情報申請システムで受け付けた申請データ
. 処理対象: 管理部署が「関連」に属する申請データのみ
. 出力データ: 課情報を構造化したpickleファイル

=== 処理タイミング

課情報作成機能は、以下のタイミングで実行されます：

. 申請の受付処理が完了した直後
. バッチ処理として、1日1回の頻度で全ての未処理申請に対して実行

== データ定義

=== 課情報データ構造

課情報は以下の構造で定義されます：

[cols="1,1, 2, 1"]
|===
| フィールド名 | データ型 | 説明 | 例 
| 種類 | 文字列 | 申請の種類 | "新規", "更新" 
| 部店コード | 文字列 | 部店を識別するコード | "D001"
| 課Grコード | 文字列 | 課グループを識別するコード | "KG001" 
| 課Gr名称 | 文字列 | 課グループの正式名称 | "営業第一グループ" 
| 課名称（英字） | 文字列 | 課の英語名称 | "Sales Division 1" 
| 課名称（かな） | 文字列 | 課の名称（かな表記） | "えいぎょうだいいちか" 
| 課略称 | 文字列 | 課の略称 | "営一" 
|===

=== 入力データ（申請データ）

申請データは、組織情報申請システムで受け付けたデータを使用します。本機能で使用する主要なフィールドは以下の通りです：

* 申請データ（統合レイアウト）を参照

=== 出力データ（pickleファイル）

出力されるpickleファイルは、以下の命名規則に従います：

- ファイル名形式: `ka_info_[部店コード]_[課Grコード].pickle`
- 例: `ka_info_D001_KG001.pickle`

ファイルの内容は、4.1で定義した課情報データ構造に基づいたPythonオブジェクトをシリアライズしたものです。

== 処理フロー

=== 全体フロー

以下のPlantUMLダイアグラムは、課情報作成機能の全体的な処理フローを示しています

[plantuml]
----
@startuml
start
:申請データ受信;
if (管理部署が「関連」?) then (はい)
  :課情報抽出;
  :課情報構造化;
  :ファイル名生成;
  :pickleファイル作成;
  :処理完了記録;
else (いいえ)
  :処理スキップ;
endif
stop
@enduml
----

===  詳細フロー

各処理ステップの詳細は以下の通りです：

==== 申請受付

. 一括申請処理でValidation確認済データに対して前処理を実施します。

==== 管理部署の確認

. 申請データから管理部署の情報を取得します。
. 管理部署が「関連」であるかを確認します。

==== 課情報の抽出

. 申請データから課情報に必要なフィールドを抽出します。
. 抽出したデータの妥当性をチェックします。

==== 課情報の構造化

. 抽出したデータを課情報データ構造に合わせてColumn選択します
. データ型の変換や整形を行います。

==== ファイル名の生成

. 部店コードと課Grコードを使用して、ファイル名を生成します。
. ファイル名の一意性を確認します。

====j 課情報の保存

. 構造化された課情報をpickle形式でシリアライズします。
. 生成したファイル名を使用して、指定された場所にファイルを保存します。

==== 処理完了の記録

. 課情報の作成と保存が完了したことをシステムログに記録します。
. 処理結果（成功/失敗）と関連する情報（申請ID、ファイル名など）を記録します。

== エラー処理

=== エラーの種類

本機能で想定されるエラーの種類は以下の通りです：

[cols="1, 4"]
|===
| エラー種類説明         | 対処方法 
| データ不整合       | 入力データの形式が不正、または必須項目が欠落しているエラーログを記録し、管理者に通知  
| ファイル書き込みエラー | pickleファイルの作成または書き込みに失敗。再試行後、失敗が続く場合は管理者に通知 
| 重複ファイル名エラー     | 同名のpickleファイルが既に存在する。タイムスタンプを付加して一意のファイル名を生成 
| システムエラー           | 予期せぬシステム例外が発生。エラーログを記録し、管理者に緊急通知
|===

=== エラー処理方法
. エラー発生時は、エラーの種類、発生時刻、関連する申請IDなどの情報をログに記録します。
. データ不整合エラーの場合、その申請データをスキップし、次の申請データの処理を続行します。
. ファイル書き込みエラーの場合、最大3回まで再試行を行います。
. 重大なシステムエラーが発生した場合、処理を中断し、即時に管理者へ通知します。
. エラーが発生した申請データは、エラー情報とともに別途保存し、後で管理者が確認できるようにします。
