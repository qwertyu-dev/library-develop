= 部署名解析パターンの正規表現設計補足資料 (改訂版)

== 修正の背景と目的
* より厳密な解析制御の必要性
* デバッグ性の向上
* エラーケースの適切な処理

== 修正内容サマリー
=== 営業部署パターン
==== 変更前
[source]
----
r"(.+?支店|.+?営業部)(営業部|(?:(?!営業部).)+営業部|営業第[一二三四五六七八九十]+部)$"
----

==== 変更後
[source]
----
r"^(.+?支店|.+?営業部)(営業部|(?:(?!営業部).)+営業部|営業第.*部)$"
----

=== エリアグループパターン
==== 変更前
[source]
----
r"(\w{5})[ \u3000](\w+Gr)\s*(\(.*?\))?"
----

==== 変更後
[source]
----
r"^(\w{5})[ \u3000]([^\s]+?Gr)\s*(\(.*?\))?$"
----

== 主要な変更点と理由
=== 1. 完全一致制御の導入
* 変更内容：両パターンに`^`と`$`を追加
* 理由：
** 部分マッチを防止
** より厳密なバリデーション
** エラーケースの確実な検出

=== 2. グループ名の柔軟化
* 変更内容：
** エリア：`\w+Gr` → `[^\s]+?Gr`
** 営業：漢数字パターンの簡素化
* 理由：
** 日本語や特殊文字の許容
** メンテナンス性の向上

=== 3. デバッグログの強化
* 変更内容：詳細なログ出力の追加
* 実装例：
[source,python]
----
log_msg(f"Processing line: '{line}'", LogLevel.DEBUG)
log_msg(f"Using pattern: {pattern}", LogLevel.DEBUG)

if match:
    log_msg("Regex match details:", LogLevel.DEBUG)
    log_msg(f"  Full match  : '{match.group(0)}'", LogLevel.DEBUG)
    log_msg(f"  Group 1     : '{match.group(1)}'", LogLevel.DEBUG)
    log_msg(f"  Group 2     : '{match.group(2)}'", LogLevel.DEBUG)
    # 必要に応じてGroup 3も出力
----

== パターン別詳細設計
=== 営業部署パターン
==== 構造解説
[source]
----
^                          # 行頭
(.+?支店|.+?営業部)       # 拠点名称（最短マッチ）
(                         # 部署名称
  営業部|                 # シンプルパターン
  (?:(?!営業部).)+営業部| # 中間パターン
  営業第.*部              # 番号付きパターン
)
$                         # 行末
----

==== 検証パターン例
[cols="3,2,2", options="header"]
|===
|入力文字列|branch_name|department_name
|大阪営業部営業部|大阪営業部|営業部
|東京営業部営業第一部|東京営業部|営業第一部
|笹島支店営業第一部|笹島支店|営業第一部
|===

=== エリアグループパターン
==== 構造解説
[source]
----
^                    # 行頭
(\w{5})             # 5桁の英数字コード
[ \u3000]           # 半角/全角スペース
([^\s]+?Gr)         # グループ名（非空白文字列）
\s*(\(.*?\))?       # オプションの設立日
$                   # 行末
----

==== 検証パターン例
[cols="4,2,2,2", options="header"]
|===
|入力文字列|group_code|group_name|established_date
|41002 東日本第一Gr|41002|東日本第一Gr|
|41012 グローバル財務戦略Gr (4/1新設)|41012|グローバル財務戦略Gr|4/1新設
|A1B2C Test-1Gr|A1B2C|Test-1Gr|
|===

== テスト戦略の強化
=== カバレッジの拡充
* C0（基本機能）テスト
* C1（分岐）テスト
* C2（条件組み合わせ）テスト
* BVT（境界値）テスト

=== エラーケースの体系化
* 不正なフォーマット
* 部分的なパターンマッチ
* 文字種の制約違反

=== デバッグ性の向上
* マッチング過程の可視化
* エラー原因の特定支援
* パフォーマンス分析の容易化

== 実装上の注意点
=== パターン変数の外部化
[source,python]
----
SALES_DEPT_PATTERN = r"^(.+?支店|.+?営業部)(営業部|(?:(?!営業部).)+営業部|営業第.*部)$"
AREA_GROUP_PATTERN = r"^(\w{5})[ \u3000]([^\s]+?Gr)\s*(\(.*?\))?$"
----

=== エラー処理の統一
* マッチ失敗時の初期化処理
* ログレベルの適切な設定
* エラーメッセージの標準化

=== パフォーマンス考慮
* 正規表現のコンパイル
* 最適なマッチング方式の選択
* ログ出力の制御