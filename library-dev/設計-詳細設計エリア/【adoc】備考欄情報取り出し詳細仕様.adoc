= 営業部署名パターンの正規表現設計補足資料

== 要件変更の概要
=== 従来仕様
* パターン: `(.+支店)(?:営業部|第[一二三四五六七八九十]+営業部)`
* 対応形式：
** 「～支店営業部」形式のみ対応
** 「～支店第X営業部」形式のみ対応

=== 変更後仕様
* パターン: `(.+?支店|.+?営業部)(営業部|営業第[一二三四五六七八九十]+営業部)$`
* 追加対応形式：
** 「～営業部営業部」形式
** 「～営業部営業第X部」形式
* 特記：従来の支店形式も継続サポート

== 正規表現の設計ポイント
=== 第1グループ（組織名）
==== 基本構造
[source]
----
(.+?支店|.+?営業部)
----

==== マッチ例
[cols="2,2,2", options="header"]
|===
|入力文字列|マッチ部分|説明
|大阪営業部営業部|大阪営業部|最短マッチにより最初の「営業部」まで
|東京支店営業部|東京支店|支店パターンにマッチ
|名古屋営業部営業第一部|名古屋営業部|最短マッチにより最初の「営業部」まで
|===

=== 第2グループ（部署名）
==== 基本構造
[source]
----
(営業部|営業第[一二三四五六七八九十]+部)$
----

==== マッチ例
[cols="2,2,2", options="header"]
|===
|入力文字列|マッチ部分|説明
|大阪営業部営業部|営業部|末尾の「営業部」にマッチ
|東京営業部営業第一部|営業第一部|末尾の「営業第一部」にマッチ
|大阪営業部営業部営業部|営業部|末尾の「営業部」にマッチ
|===

== 重要な設計判断とその理由
=== 最短マッチ（?）の採用
==== 課題
* 「大阪営業部営業部」のような文字列で、第1グループが「大阪営業部営業」までマッチしてしまう可能性

==== 対策
* `.+?` による最短マッチを採用
* 例：
** 入力：「大阪営業部営業部」
** 望ましい動作：「大阪営業部」で第1グループが終了
** 望ましくない動作：「大阪営業部営業」まで第1グループが継続

=== 末尾マッチ（$）の採用
==== 課題
* 「大阪営業部営業部営業第一部」のような文字列で、 `中間の「営業部」` にマッチしてしまう可能性

==== 対策
* `$` による末尾マッチを採用
* 例：
** 入力：「大阪営業部営業部営業第一部」
** 望ましい動作：最後の「営業第一部」が第2グループとしてマッチ
** 望ましくない動作：中間の「営業部」で第2グループのマッチが終了

== 検証パターン網羅
=== 基本パターン

==== シンプルな営業部パターン
[source]
----
入力：「大阪営業部営業部」
group(1) => "大阪営業部"
group(2) => "営業部"
----

==== 営業第X部パターン
[source]
----
入力：「東京営業部営業第一部」
group(1) => "東京営業部"
group(2) => "営業第一部"
----

==== 従来の支店パターン
[source]
----
入力：「八重洲通支店営業部」
group(1) => "八重洲通支店"
group(2) => "営業部"
----

=== 複雑パターン

==== 中間営業部パターン
[source]
----
入力：「大阪営業部営業部営業部」
group(1) => "大阪営業部"
group(2) => "営業部"
----

==== 中間営業部＋営業第X部パターン
[source]
----
入力：「大阪営業部営業部営業第二部」
group(1) => "大阪営業部"
group(2) => "営業第二部"
----

== 実装コードとテストケース
=== テストケース実装例
[source,python]
----
@pytest.mark.parametrize(
    ("remarks_text", "expected_result"),
    [
        # シンプルな営業部パターン
        (
            "大阪営業部営業部",
            {
                "request_type": "営業部傘下",
                "sales_department": {
                    "department_name": "大阪営業部営業部",
                    "branch_name": "大阪営業部",
                },
                "area_group": {
                    "group_code": "",
                    "group_name": "",
                    "established_date": "",
                },
                "other_info": "",
            },
        ),
        # 営業第X部パターン
        (
            "東京営業部営業第一部",
            {
                "request_type": "営業部傘下",
                "sales_department": {
                    "department_name": "東京営業部営業第一部",
                    "branch_name": "東京営業部",
                },
                "area_group": {
                    "group_code": "",
                    "group_name": "",
                    "established_date": "",
                },
                "other_info": "",
            },
        ),
        # ... 他のテストケース
    ]
)
----

== 付録：検討過程で却下された案
=== 非キャプチャグループの検討
[source]
----
r"(.+?支店|.+?営業部)(?:営業部|営業第[一二三四五六七八九十]+営業部)$"
----
* 却下理由：
** department_nameにline全体を設定する仕様のため、第2グループのキャプチャは不要
** ただし、可読性と将来の仕様変更への対応を考慮し、キャプチャグループを維持

=== 中間営業部の明示的スキップ
[source]
----
r"(.+?支店|.+?営業部)(?:営業部)*?(営業部|営業第[一二三四五六七八九十]+営業部)$"
----
* 却下理由：
** 現状の実装でも要件を満たせている
** パターンが複雑化する
** バックトラックの最適化は現状の優先度としては低い