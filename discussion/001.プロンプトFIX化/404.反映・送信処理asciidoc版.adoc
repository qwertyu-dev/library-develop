= 反映・送信処理 設計書

== 1. 要件定義

=== 1.1. 要求分析
反映・送信処理は、パターン処理後のデータを利用してリファレンスDBを更新し、リファレンスDBから送信用ファイルを出力して共通認証システムへ送信する機能を提供する。この処理は、反映処理と送信処理に大きく分類される。反映処理では、DB更新情報テーブルからリファレンスDBへのデータ反映、リファレンスDB反映前の断面の履歴DBへの格納、データ反映処理、部店削除処理、ダミー課Gr申請情報のダミー課Gr専用のDBへの反映が行われる。一括処理では、部店休職・本部詰めデータの更新が行われる。送信処理では、CSVファイルの書き出し、ファイル送信前のバリデーション、リファレンスDB規則の検証、共通認証システムへのファイル送信が行われる。

=== 1.2. 移植での改善方針

==== 1.2.1. 単一責務化
反映処理、一括処理、送信処理をそれぞれ独立したコンポーネントとして設計し、各コンポーネントが単一の責務を持つようにする。

==== 1.2.2. データ反映制御
DB更新情報テーブルからリファレンスDBへのデータ反映を制御し、リファレンスDB反映前の断面を履歴DBに格納する。

==== 1.2.3. 一括処理
部店休職・本部詰めデータの更新を一括処理として実装する。

==== 1.2.4. データ送信
CSVファイルの書き出し、ファイル送信前のバリデーション、リファレンスDB規則の検証、共通認証システムへのファイル送信を独立したコンポーネントとして実装する。

== 2. 機能定義

=== 2.1. 機能概要

==== 2.1.1. 機能の目的
反映・送信処理は、パターン処理後のデータを利用してリファレンスDBを更新し、リファレンスDBから送信用ファイルを出力して共通認証システムへ送信することを目的とする。

==== 2.1.2. 機能の範囲
反映・送信処理は、反映処理、一括処理、送信処理の3つの主要な機能で構成される。反映処理では、DB更新情報テーブルからリファレンスDBへのデータ反映、リファレンスDB反映前の断面の履歴DBへの格納、データ反映処理、部店削除処理、ダミー課Gr申請情報のダミー課Gr専用のDBへの反映が行われる。一括処理では、部店休職・本部詰めデータの更新が行われる。送信処理では、CSVファイルの書き出し、ファイル送信前のバリデーション、リファレンスDB規則の検証、共通認証システムへのファイル送信が行われる。

=== 2.2. 処理フロー

==== 2.2.1. 反映処理

===== 2.2.1.1. DB更新情報テーブルからリファレンスDBへのデータ反映
DB更新情報テーブルに格納されたパターン編集後のデータを利用して、リファレンスDBのデータを更新する。

===== 2.2.1.2. リファレンスDB反映前の断面を履歴DBに格納
リファレンスDBへのデータ反映前の断面を取得し、リファレンス履歴DBに格納する。

===== 2.2.1.3. データ反映処理
データ反映処理の種類に応じて、リファレンスDBのデータの追加、削除、変更を実行する。

===== 2.2.1.4. 部店削除処理
部店削除時には、BPR ドメインコントローラと連携して残ユーザの調査を実行する。

===== 2.2.1.5. ダミー課Gr申請情報をダミー課Gr専用のDBに反映
ダミー課Grの申請情報をダミー課Gr専用のDBに反映する。

==== 2.2.2. 一括処理

===== 2.2.2.1. 部店休職・本部詰めデータ更新
リファレンスDBの部店に対する一律的なデータ更新を行い、休職・本部詰め対象部店があるべき部店構成となるように、休職・本部詰めデータを生成・削除する。

==== 2.2.3. 送信処理

===== 2.2.3.1. CSVファイル書き出し
データ反映処理後のDBからフォーマット指定のフィールドを抽出し、CSVファイルを作成する。

===== 2.2.3.2. ファイル送信前バリデーション
CSVファイルの各フィールドの入力形式が正しいことと、レコード重複のようなDB規則の違反がないことを確認する。

===== 2.2.3.3. リファレンスDB規則検証
部店の親子構成、休職本部詰めの有無といったリファレンスDBの規則に違反がないことを確認する。

===== 2.2.3.4. 共通認証システムへのファイル送信
書き出したCSVファイルをSFTPで共通認証システムへ送信する。

=== 2.3. 外部インターフェース

==== 2.3.1. 入力インターフェース

[cols="1,3", options="header"]
|===
|インターフェース名 |説明
|DB更新情報テーブル |パターン編集後のデータ群を格納し、リファレンスDBのレコード情報とリファレンスDB更新用のデータ(更新種別・更新日)を保持する
|リファレンスDB |リファレンスDBのデータを他システムへ連携する
|ダミー課GrDB |特定の関連部店のみが利用し、リファレンスDBが持たない課Grの英語情報を持つ
|受け渡し前処理のスケジュール定義ファイル |共通認証受け渡し日から逆算した日付を定義し、反映処理時に利用して処理対象を抽出する
|ファイル書き出し用のフォーマット定義ファイル |送信ファイル生成の為、リファレンスDB、ダミー課GrDBから抽出するフィールドを定義する
|===

==== 2.3.2. 出力インターフェース

[cols="1,3", options="header"]
|===
|インターフェース名 |説明
|リファレンス履歴DB |リファレンスDB更新前の断面を取得し、前回との更新差分を出力する
|ファイルサーバ |共通認証への受け渡し前処理で利用し、リファレンスDBの部店が利用するファイルサーバ情報をメール連携する
|共通認証システム |リファレンスDBのデータ連携先
|===

== 3. システムデザイン

=== 3.1. 処理フロー図（PlantUML形式）
[plantuml, process-flow, svg]
----
@startuml
start
:DB更新情報テーブルからリファレンスDBへのデータ反映;
:リファレンスDB反映前の断面を履歴DBに格納;
:データ反映処理;
:部店削除処理;
:ダミー課Gr申請情報をダミー課Gr専用のDBに反映;
:部店休職・本部詰めデータ更新;
:CSVファイル書き出し;
:ファイル送信前バリデーション;
:リファレンスDB規則検証;
:共通認証システムへのファイル送信;
stop
@enduml
----

=== 3.2. コンポーネント図
[plantuml, component-diagram, svg]
----
@startuml
package "反映・送信" {
  component "反映処理" {
    component "DB更新情報テーブル"
    component "リファレンスDB"
    component "リファレンス履歴DB"
    component "BPR ドメインコントローラ"
    component "ダミー課GrDB"
  }
  component "一括処理" {
    component "休職・本部詰めデータ生成・削除"
  }
  component "送信処理" {
    component "CSVファイル書き出し"
    component "ファイル送信前バリデーション"
    component "リファレンスDB規則検証"
    component "共通認証システムへのファイル送信"
  }
  component "ファイルサーバ"
  component "共通認証システム"
  component "受け渡し前処理のスケジュール定義ファイル"
  component "ファイル書き出し用のフォーマット定義ファイル"
}
@enduml
----

=== 3.3. シーケンス図
[plantuml, sequence-diagram, svg]
----
@startuml
participant "反映処理" as Reflection
participant "一括処理" as Batch
participant "送信処理" as Transmission

Reflection -> Reflection: DB更新情報テーブルからリファレンスDBへのデータ反映
Reflection -> Reflection: リファレンスDB反映前の断面を履歴DBに格納
Reflection -> Reflection: データ反映処理
Reflection -> Reflection: 部店削除処理
Reflection -> Reflection: ダミー課Gr申請情報をダミー課Gr専用のDBに反映
Batch -> Batch: 部店休職・本部詰めデータ更新
Transmission -> Transmission: CSVファイル書き出し
Transmission -> Transmission: ファイル送信前バリデーション
Transmission -> Transmission: リファレンスDB規則検証
Transmission -> "共通認証システム": 共通認証システムへのファイル送信
@enduml
----

=== 3.4. アクティビティ図
[plantuml, activity-diagram, svg]
----
@startuml
start
:DB更新情報テーブルからリファレンスDBへのデータ反映;
:リファレンスDB反映前の断面を履歴DBに格納;
:データ反映処理;
:部店削除処理;
:ダミー課Gr申請情報をダミー課Gr専用のDBに反映;
:部店休職・本部詰めデータ更新;
:CSVファイル書き出し;
:ファイル送信前バリデーション;
:リファレンスDB規則検証;
:共通認証システムへのファイル送信;
stop
@enduml
----

=== 3.5. クラス図
[plantuml, class-diagram, svg]
----
@startuml
class ReflectionProcessor {
  + processDataReflection()
  + storeSnapshotInHistoryDB()
  + processDataReflection()
  + processDepartmentDeletion()
  + reflectDummySectionGrApplicationData()
}

class BatchProcessor {
  + updateDepartmentSuspensionAndTransferData()
}

class TransmissionProcessor {
  + exportCSVFile()
  + validateBeforeFileTransmission()
  + verifyReferenceDatabaseRules()
  + sendFileToCommonAuthenticationSystem()
}

class ReflectionException {
  + ReflectionException(message: String)
}

class BatchException {
  + BatchException(message: String)
}

class TransmissionException {
  + TransmissionException(message: String)
}

class LoggingManager {
  + logFileImport(fileName: String, importDateTime: Date, importResult: String)
  + logValidationError(csvFileName: String, rowNumber: int, columnNumber: int, errorValue: String, expectedType: String)
}

class SecurityManager {
  + authenticateUser(userId: String, password: String): boolean
  + authorizeUser(userId: String, operation: String): boolean
}

class OperationManager {
  + executeInProductionEnvironment()
  + backupPickleFileBeforeReflection()
  + deleteExpiredBackupFiles()
  + scheduleWithJP1()
  + executeDaily()
}

ReflectionProcessor --> ReflectionException: throws
BatchProcessor --> BatchException: throws
TransmissionProcessor --> TransmissionException: throws
ReflectionProcessor --> LoggingManager: uses
BatchProcessor --> LoggingManager: uses
TransmissionProcessor --> LoggingManager: uses
ReflectionProcessor --> SecurityManager: uses
BatchProcessor --> SecurityManager: uses
TransmissionProcessor --> SecurityManager: uses
OperationManager --> ReflectionProcessor: manages
OperationManager --> BatchProcessor: manages
OperationManager --> TransmissionProcessor: manages
@enduml
----

=== 3.6. 内部処理設計

==== 3.6.1. 反映処理

===== 3.6.1.1. DB更新情報テーブルからリファレンスDBへのデータ反映
DB更新情報テーブルに格納されたパターン編集後のデータを利用して、リファレンスDBのデータを更新する。更新対象のデータは、更新種別と更新日を参照して特定する。

===== 3.6.1.2. リファレンスDB反映前の断面を履歴DBに格納
リファレンスDBへのデータ反映前の断面を取得し、リファレンス履歴DBに格納する。これにより、更新前のデータを保持し、更新差分の確認を可能にする。

===== 3.6.1.3. データ反映処理
データ反映処理の種類に応じて、リファレンスDBのデータの追加、削除、変更を実行する。処理の種類は、共通認証受け渡しのタイミングに応じて決定される。

===== 3.6.1.4. 部店削除処理
部店削除時には、BPR ドメインコントローラと連携して残ユーザの調査を実行する。残ユーザが存在する場合は、削除処理を中断し、エラーを報告する。

===== 3.6.1.5. ダミー課Gr申請情報をダミー課Gr専用のDBに反映
ダミー課Grの申請情報をダミー課Gr専用のDBに反映する。反映処理は、リファレンス反映処理とは別のフローで実施され、最終的にはリファレンスDBのフィールドとマージしてファイル出力する。

==== 3.6.2. 一括処理

===== 3.6.2.1. 部店休職・本部詰めデータ更新
リファレンスDBの部店に対する一律的なデータ更新を行い、休職・本部詰め対象部店があるべき部店構成となるように、休職・本部詰めデータを生成・削除する。この処理は、データの条件に依存せず一律に実行できる。

==== 3.6.3. 送信処理

===== 3.6.3.1. CSVファイル書き出し
データ反映処理後のDBからフォーマット指定のフィールドを抽出し、CSVファイルを作成する。フォーマット定義ファイルに従って、リファレンスDBとダミー課GrDBから必要なデータを抽出する。

===== 3.6.3.2. ファイル送信前バリデーション
CSVファイルの各フィールドの入力形式が正しいことと、レコード重複のようなDB規則の違反がないことを確認する。エラーが発生した場合は、送信処理を中断し、エラーを報告する。

===== 3.6.3.3. リファレンスDB規則検証
部店の親子構成、休職本部詰めの有無といったリファレンスDBの規則に違反がないことを確認する。規則違反が発生した場合は、送信処理を中断し、エラーを報告する。

===== 3.6.3.4. 共通認証システムへのファイル送信
書き出したCSVファイルをSFTPで共通認証システムへ送信する。送信処理が成功した場合は、送信ログを記録する。

== 4. 入出力データ

=== 4.1. 入力
==== 4.1.1. pickleファイル（パターン処理後の永続化データ）
- パターン処理後のデータを格納したpickleファイルを入力として受け取る
- ファイル名、フォーマット、データ構造は別紙に記載

=== 4.2. 出力
==== 4.2.1. pickleファイル（反映処理前の永続化データ）
- 反映処理前のデータを格納したpickleファイルを出力する
- ファイル名、フォーマット、データ構造は別紙に記載

==== 4.2.2. pickleファイル（反映処理後の永続化データ）
- 反映処理後のデータを格納したpickleファイルを出力する
- ファイル名、フォーマット、データ構造は別紙に記載

==== 4.2.3. csvファイル
- 共通認証システムへ送信するためのCSVファイルを出力する
- ファイル名、フォーマット、データ構造は別紙に記載

==== 4.2.4. 制御ファイル
- 共通認証システムへ送信する際の制御情報を格納したファイルを出力する
- ファイル名、フォーマット、データ構造は別紙に記載

== 5. 例外設計

=== 5.1. 例外一覧

[cols="1,2,2,3", options="header"]
|===
|管理番号 |発生事象定義 |原因定義 |対処指針
|E-001 |DB更新情報テーブルからのデータ取得失敗 |DB接続エラー、SQLエラー |エラーログを出力し、管理者に通知する。処理を中断する。
|E-002 |リファレンスDBへのデータ反映失敗 |DB接続エラー、SQLエラー、整合性エラー |エラーログを出力し、管理者に通知する。処理を中断する。
|E-003 |リファレンス履歴DBへのデータ格納失敗 |DB接続エラー、SQLエラー |エラーログを出力し、管理者に通知する。処理を中断する。
|E-004 |部店削除処理失敗 |BPR-DCとの連携エラー、残ユーザ存在エラー |エラーログを出力し、管理者に通知する。処理を中断する。
|E-005 |ダミー課Gr専用DBへのデータ反映失敗 |DB接続エラー、SQLエラー |エラーログを出力し、管理者に通知する。処理を中断する。
|E-006 |CSVファイル書き出し失敗 |ディスク容量不足、書き込み権限エラー |エラーログを出力し、管理者に通知する。処理を中断する。
|E-007 |ファイル送信前バリデーションエラー |フォーマットエラー、整合性エラー |エラーログを出力し、管理者に通知する。処理を中断する。
|E-008 |リファレンスDB規則検証エラー |部店構成エラー、休職本部詰め設定エラー |エラーログを出力し、管理者に通知する。処理を中断する。
|E-009 |共通認証システムへのファイル送信失敗 |SFTP接続エラー、認証エラー |エラーログを出力し、管理者に通知する。リトライ処理を実行する。
|===

==== 5.1.1. 管理番号
例外の管理番号。プレフィックスとして"E-"を付与し、連番で割り当てる。

==== 5.1.2. 発生事象定義
例外が発生する事象を定義する。具体的なエラー内容や発生箇所を記述する。

==== 5.1.3. 原因定義
例外が発生する原因を定義する。考えられる原因を列挙する。

==== 5.1.4. 対処指針
例外発生時の対処方法を定義する。エラーログの出力、管理者への通知、処理の中断、リトライ処理などの対応を記述する。

== 6. ロギング設計

=== 6.1. ファイル取り込み記録
- 取り込んだファイルの名称、取り込み日時、取り込み結果（成功/失敗）をログに記録する
- ログのフォーマット、出力先は別紙に記載

=== 6.2. バリデーション/整合性チェックエラー位置特定情報
==== 6.2.1. CSVファイル、行・列位置、値、正しい型想定・値など
- バリデーションや整合性チェックでエラーが発生した場合、エラー発生箇所を特定するための情報をログに記録する
- CSVファイル名、エラー発生行番号、エラー発生列番号、エラー発生値、正しい型や値の想定をログに出力する
- ログのフォーマット、出力先は別紙に記載

== 7. セキュリティ要件

=== 7.1. アクセス制御
- 反映・送信処理の実行権限を持つユーザを限定し、適切なアクセス制御を行う
- 実行権限の設定方法は別紙に記載

=== 7.2. ログ管理
- 反映・送信処理のログを一定期間保管し、不正なアクセスや操作がないか定期的にチェックする
- ログの保管期間、チェック方法は別紙に記載

=== 7.3. 不正操作防止
- 反映・送信処理の実行前に、適切な認証と認可を行い、不正な操作を防止する
- 認証・認可の方法は別紙に記載

== 8. 運用記述

=== 8.1. 本番環境での実施
- 反映・送信処理は本番環境で実施する
- 本番環境のシステム構成、ネットワーク構成は別紙に記載

=== 8.2. データの取扱
==== 8.2.1. データ反映前のpickleファイル物理コピー保管
- データ反映前のpickleファイルは、物理的に別の場所にコピーを保管する
- コピー先、コピー方法は別紙に記載

==== 8.2.2. コピーファイルのリテンション
- コピーしたpickleファイルは、一定期間保管した後、削除する
- 保管期間、削除方法は別紙に記載

=== 8.3. 実行スケジュール
==== 8.3.1. JP1による自動スケジュール設定
- 反映・送信処理のスケジュールは、JP1を使用して自動設定する
- JP1の設定方法は別紙に記載

==== 8.3.2. 日次実行
- 反映・送信処理は日次で実行する
- 実行時刻、実行間隔は別紙に記載

== 9. 別紙
- pickleファイルのフォーマット、データ構造
- CSVファイルのフォーマット、データ構造
- 制御ファイルのフォーマット、データ構造
- ログのフォーマット、出力先
- 実行権限の設定方法
- ログの保管期間、チェック方法
- 認証・認可の方法
- 本番環境のシステム構成、ネットワーク構成
- pickleファイルのコピー先、コピー方法
- コピーファイルの保管期間、削除方法
- JP1の設定方法
- 反映・送信処理の実行時刻、実行間隔
----