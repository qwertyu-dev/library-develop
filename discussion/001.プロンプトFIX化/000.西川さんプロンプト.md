<業務要件>
# 前提

## 会社概要
- 通称：「銀行」、「当行」
- 社内の言い換え：「行内」
- 基本情報
  - 名称：株式会社三菱UFJ銀行
  - 英語表記：MUFG Bank, Ltd.
  - 株主： 株式会社三菱UFJフィナンシャル・グループ (MUFG) (100%)
  - 従業員数：32.786人(2023年3月末現在、単体)
  - 支店等：国内421、海外105 (2023年3月末現在)

## 組織構造
- 組織の構成単位(部、室、課など)を「部署」あるいは「部店」 「課Gr」と呼ぶ
- 以下ののような階層構造となっている
 - 「株主総会」が最上にある
 - 「株主総会」の配下に「取締役会」、「監査等委員会」がある
 - 「取締役会」の配下に「経営会議」がある
 - 「経営会議」の配下に「部門」がある
 - 「部門」の配下に「本部」がある
 - 「部門」の配下と「本部」の配下に「部」がある
 - 「部」の配下に「室」がある
 - 「室」の配下に「Gr(グループ)」がある
 - 「部門」の配下に「営業店」がある
 - 「営業店」の配下に「出張所」「営業部(拠点内営業部)」がある
 - 「営業店」の配下と「出張所」の配下と「営業部」の配下に「課」がある
 - 「室」と「営業店」は同じ階層
 - 「Gr」と「課」は同じ階層

### 部店コード・課Grコード
- 全ての部署は部店コードを持つ。一部の部署は課Grコードを持つ
  - 課Grコードを持たない部署は部・室・営業店
  - 課Grコードを持つ部署は部・室・営業店の配下の課・Gr
  - 任意の部・室・営業店とその配下の課・Grは部店コードの前方4桁が等しい
  - 一度割り当てられた部店コードと課Grコードは変更されない

### 部店コード帯域
- 部署は、部店コードの先頭1~2桁によって以下のように分類される
  - 部店コードの先頭1桁が0なら、営業店のうち国内の支店
  - 部店コードの先頭1桁が1なら、営業店のうち国内の法人営業拠点
  - 部店コードの先頭1桁が2なら、営業店のうちローン推進部
  - 部店コードの先頭1桁が3なら、営業店のうち海外の拠点
  - 部店コードの先頭1桁が6なら、銀行本部の組織
  - 部店コードの先頭1桁が7なら、関連会社の組織
  - 関連会社のうち、部店コードの先頭2桁が71または72なら、持株会社(MUFG)の組織
  - 部店コードの先頭1桁が9なら、寮

### 休職・本部詰
-以下の条件1または条件2に合致する部署は「休職・本部詰の親部店」であり、配下に「休職」部署と 「本部詰」 部署 を持つ
  - 条件1:「部店コードが9000番台以外」かつ「BPR課Grコードが "0"」
  - 条件2:「BPR部店コードが "0000" 以外&9000番台以外」 かつ 「BPR部店コードと人事部店コードの頭4桁が一致する が等しくない」かつ「人事課Grコードまたはエリア課 Grコードが空欄」 かつ 「業務コードと常駐店番が空欄」

#### 休職
- 課Grコードが93000の課
- 休職中の行員が所属する
- 「休職・本部詰の親部店」に該当する部署の配下に存在する

#### 本部詰
- 課Grコードが95000の課
- 本部詰中の行員が所属する
- 「休職・本部詰の親部店」 に該当する部署の配下に存在する


# 本システムの概要

## システムの呼称
- 「ユーザ管理」 「ユーザー管理」
- 「リファレンス」「リファレンスDB」

## 人事異動リファレンスデータベース
- 通称「リファレンスDB」
- 銀行の部署の情報を補遺している
- 保持している部署情報は以下
  - 部署のコード名称の情報(部店コード・部店名称課Grコード・課Gr名称など)
  - 行内BPRシステム (Microsoft製品)で使うための各種設定値
  - 行内共通認証システムで使うための各種設定値

## リファレンスDBに対する各種申請
-以下の3パターンの申請を受け付け、内容をリファレンスDBに反映する
  - 部署の新設
  - 部署情報の変更
  - 部署の廃止


## システムの構成要素（コンポーネント）

### 一括申請
- 人事部、国際事務企画室、関連会社からの異なるフォーマットによる申請を統一フォーマットにまとめる
- 申請内容のバリデーション・整合性チェックを行う

### 受付
- 申請情報に対し、リファレンスDBの情報を補記するなどして、後続パターン編集に適したフォーマットに整形する

### パターン編集
- 受付後データを元に、リファレンスDBに登録する各種設定値を計算する

### 反映・送信
- パターン編集後のデータに基づいてリファレンスDBを更新する
- リファレンスDBの全明細を対象とした一括処理を行う
- バリデーション・整合性チェック・アプトプットファイルの生成・後続システムに対するファイル送信を行う

## 人事異動リファレンスデータベース
- 通称「リファレンスDB」
- 銀行の部署の情報を保有している
- 保持している部署情報は以下
  - 部署コード・名称の情報（部店コード・部店名称・課Grコード・課Gr名称など）
  - 行内BPRシステム（Microsoft製品）で使うための各種設定値
  - 行内認証システムで使うための各種設定値

## リファレンスDBに対する各種申請
- 以下の３パターンの申請を受け付け、内容をリファレンスDBに反映する
  - 部署の新設
  - 部署情報の更新
  - 部署の廃止

## 周辺システムとの連携

### 上流
- 銀行内の3つの部署からの申請を受け付けている
- 受け付ける際のフォーム (Excelファイル) は申請元の部署毎に異なる

#### 人事部からの申請
- 銀行本部、 営業店、 寮に対する申請
- 「人事」 フォームで申請される

#### 国際事務企画部からの申請
- 海外の営業店に対する申請
- 「海外」 フォームで申請される

#### 関連会社からの申請
- 関連会社に対する申請
- 「関連」 フォームで申請される

### 下流
- 行内BPRシステム (Microsoft製品)、行内共通認証システムに対し、 部署情報と各種設定値の情報を連携している

#### 行内BPRシステム
-ユーザ(行員) に対して、 WindowsデスクトップをはじめとしたOA環境を提供するシステム
- 以下の製品で構成されている
  - Microsoft Windows Server
  - Microsoft Exchange Server
  - Microsoft Active Directory

#### 行内共通認証システム
-ユーザが各種業務システムをシングルサインオンで利用するための認証システム
</業務要件>



<システム機能要件>
# 概要
- 銀行の部署情報 (部店コード、 部店名、 各種設定値など) のデータを保持・メンテナンスし、それに対する変更申請 を処理するシステム
- 現行システムの更改 (新サーバへの移植)という形で開発を行う

# データライフサイクル
- 以下の4フェーズがある
## 一括申請
- 申請部署から、 申請フォーム (Excelファイル) による部署情報更新データの提供がある
- 申請部署によって申請時のフォームが異なる。 申請部署とフォームは以下の通り
  - 人事部 : 「人事」フォーム
  - 国際事務企画部: 「国企」 フォーム
  - 関連会社 : 「関連」 フォーム
- 申請データに対するValidaion/整合性チェックを行う
- 各種申請フォームから統一フォームへの転記を行う

## 受付
- 一括申請処理後のデータに対し、 編集 (整形や情報補填)を行う
- 明細毎に、申請の種類、 部店コード帯域、 各種フィールドの値の有無といった条件によって編集の内容が異なる
  - 条件制御で100パターン程度が見込まれている
  - 現行アプリは複雑なifネストや個別処理実装を行っているがシステム保守上のボトルネックとなっており、 リファクタリングが必須である

## パターン編集
- 受付処理後のデータを1明細ずつ処理する
  - 受付処理後の各フィールドの値を元に、後続システムに連携するための各種設定値を計算する
  - 後続フェーズにおいてCUDパターンで処理できる形に編集する
- 部店コード等の条件によって編集内容が異なる
  - 各フィールド毎の編集内容の組み合わせを定義したものを 「パターン」という
  - 各明細がどのパターンで処理されるかは部店コード等の条件によって制御する
  - パターンは全部で100種類程度ある

##反映 送信

### 反映
- パターン編集処理後のDB更新情報明細を元にリファレンス DBへの反映を行う
  - 明細が持つ反映日をキーとする
  - 運用パラメータ制御により、反映指定日前にデータ仮反映を行
  - カレンダーは銀行カレンダーを取得し、 営業日での制御を行う

### 一括処理
-データが保有する値に依存しない、共通の一括処理を行う
  - リファレンスDBに対し、休職・本部詰の部署情報を作成・削除する
    - 「休職・本部詰の親部店」 に該当する部署の配下に休職・本部詰部署がなければ作成する
    - 「休職・本部詰の親部店」に該当しない部署の配下に休職・本部詰部署があれば削除する

### 送信
- 後続システムに連携するためのCSVファイルと制御ファイルを作成する
- 更新日にCSVファイルと制御ファイルを関連システムへSFTP送信する 仮反映データ及び本反映データを送信する
- 仮反映データ及び本反映データを送信する

# 申請フォーム
- 申請元の部署によって異なる3種類のExcelファイルがある

## 「人事」フォーム
- 人事部からの申請に使われるフォーム
- 申請項目は以下
  - no
  - 有効日付
  - 種類
  - 対象
  - 部門コード
  - 親部店コード
  - 部店コード
  - 部店名称
  - 部店名称 (英語)
  - 課/エリアコード
  - 課/エリア名称
  - 課/エリア名称 (英語)
  - 常駐部店コード
  - 常駐部店名称
  - 純新規店の組織情報受渡し予定日 開店日基準) 共通認証受渡し予定日 (人事データ反映基準)
  - 備考
  
  
## 「国企」フォーム
- 国際事務企画部からの申請に使われるフォーム
- 申請項目は以下
  - no
  - 登録予定日(yyyy/mm/dd)
  - 新規変更廃止
  - 対象(課・エリア/中間階層)
  - 都店コード
  - 部店名称 日本語
  - 部店名称 英語
  - 中間階層コード
  - 中間階層名称:日本語
  - 中間階層名称:英語
  - 中間階層略称:日本語
  - 中間階層略称:英語
  - 課・エリアコード 
  - 課・エリア名称: 日本語
  - 課・エリア名称: 英語
  - 課・エリア略称: 日本語
  - 課・エリア略称: 英語
  - 共通認証受渡予定日
  - 変更種別・詳細旧名称・略語

## 「関連」フォーム
- 関連会社からの申請に使われるフォーム
- 申請項目は以下 (一括フォームから)
  - no
  - 種類
  - 部門コード
  - 親部店コード
  - 部店コード
  - 部店名称
  - 課コード
  - 課名称:
  - 部店カナ
  - 課名称(英字)
  - 課名称(カナ)
  - 課名称(略称)
  - シンクラ/NetPCが利用可能
  - 共通認証受渡し予定日


# 保有テーブルとカラム
## 申請一覧テーブル
-各種申請フォームで申請された情報に対して一括申請処理を行い、統一フォーマット化して格納したテーブル
- 保有するカラムは以下の通り
  - 更新情報明細を一意に区別するキー (複合キー)
  - 共通認証受渡予定日 後続の行内共通認証システムに情報が受け渡される予定の日付
  - 申請の種類 部署の新設・変更・廃止のどれにあたるか
  - 対象:どの階層の部署に対する申請か(部店/課/エリア/拠点内営業部)
  - 部門コード
  - 親部店コード
  - 部店コード
  - 部店名称
  - 課/エリアコード
  - 課/エリア名称
  - 常駐部店コード
  - 常駐部店名称
  - 有効日付
  - 備考
  - 部店カナ
  - 主部門コード
  - BPR AD対象フラグ

## 変更情報テーブル
- 申請一覧テーブルの情報に対し受付処理を行ったデータを格納したテーブル
- 保有するカラムは以下の通り
- 更新情報明細を一意に区別するキー (複合キー)・
  - 申請の種類: 部署の新設・変更・廃止のどれにあたるか
  - 部店コード
  - 部店名称
  - 課Grコード
  - 課Gr 名称
  - 親部店コード
  - 出張所コード
  - 出張所名称
  - エリアコード
  - エリア名称
  - 常駐部店コード
  - 常駐部店名称
  - 有効日付
  - 備考
  - 部店カナ
  - 部門コード
  - 主部門コード
  - BPR AD対象フラグ
  - 共通認証受渡予定日 後続の行内共通認証システムに情報が受け渡される予定の日付


## DB更新情報テーブル
- 変更情報テーブルの情報に対しパターン編集処理を行ったデータを格納したテーブル
- 保有するカラムは以下の通り
  - 更新情報明細を一意に区別するキー (複合キー)
  - 共通認証受渡予定日:後続の行内共通認証システムに情報が受け渡される予定の日付
  - 更新の種類: リファレンスDBに対する行の追加(create)・更新 (update)・削除 (delete) のどれにあたるか リファレンスDBに登録する各種設定値
  - リファレンスDBの持つカラムと同じ品揃え

## 人事異動リファレンスDB
-DB更新情報テーブルの内容の反映対象となる
- 保有するカラムは以下の通り
  - 行内BPRシステム用の設定値
  - 部店コード・部店名課Grコード・課Gr名を各3種類ずつ
    - BPR・人事・エリアの3種類がある
      - BPRは行内BPRシステムの設定に使用される
      - 人事・エリアは人事部での部署情報の管理に使用される
    - 3種類それぞれが部店コード・部店名・課Grコード・課Gr名を持つ
    - 以下の品揃え。 全部で12のカラムとなる
      - 部店コード (BPR) (別称:BPR部店コード)
      - 部店名 (BPR) (別称: BPR部店名)
      - 課Grコード (BPR) (別称: BPR課Gr コード)
      - 課Gr名 (BPR) (別称: BPR課Gr名)
      - 部店コード (人事) (別称: 人事部店コード)
      - 部店名(人事) (別称: 人事部店名)
      - 課Grコード (人事) (別称: 人事課 Grコード)
      - 課Gr 名 (人事) (別称: 人事課Gr名)
      - 部店コード (人事) (別称: 人事部店コード)
      - 部店名 (人事) (別称: 人事部店名)
      - 課Grコード (人事) (別称: 人事課 Grコード)
      - 課Gr 名 (人事) (別称: 人事課Gr名)
    - 親部店コード
    - 出張所コード・出張所名称
    - エリアコード・エリア名称
    - 常駐部店コード・常駐部店名称
   - Global Address List用の各種設定値
   - Exchange Server 用の各種設定値
   - ネットワークドライブ用の各種設定値


# 個別保有テーブル
- システム実装最適化のため、いくつかの固定値を持つテーブルを保有する
- 保有するテーブルの候補
  - BPR部門コード (部を上位のレイヤーで区分分類する)
  - 出向リカバリフラグ (個別の条件により権限付与制御する)
  - 銀行カレンダー (銀行特有の営業日・休業日カレンダーを保有)

# 申請の種類
- 申請の種類は、 明細 (Excelファイルの1行) 毎に「新設・変更・廃止」の3種類がある
  - 新設 : 部署の新設申請。 既存でない部店コードと課 Grコード、 既存でない部店名と課Gr名の情報を含む
  - 変更: 部署情報の変更申請。 既存の部店コードと課Grコード、既存でない部店名と課Gr名の情報を含む
  - 廃止: 部署の廃止申請。 既存の部店コードと課Grコード、 既存の部店名と課 Gr名の情報を含む

#申請明細の展開
- リファレンスDBはデータの正規化を行っていない
- そのため、 部店の情報に変更が入っても、その配下の課・ Grが保持している部店の情報は自動的には変更されない
- そこで本システムの受付フェーズには、部店に対する変更申請が行われた場合、 その配下の課Grのレコードが持つ部 店情報も最新化するという仕組みがある
  - 具体的には、 部店に対する変更申請明細から、配下の課Grの変更情報明細を作成する
- このとき、部店に対する申請と、配下の課Grに対する申請が同時に出された場合、一つの課Grに対する変更情報明細 が2行存在することになる
- そこで本システムの受付フェーズには、同一部署に対する変更明細をマージして1明細とする仕組みがある
</システム機能要件>



<データライフサイクル>
<一括申請>
#申請データの受領
- 申請フォーム (Excelファイル) から申請データを読み込む

#申請データに対するValidaion
- Excelデータに対するValidaionチェックを行う
  - 項目単体の型チェック
  - 設定値の範囲チェック

# 申請データに対する整合性チェック
- Excelデータに対する整合性チェックを行う
  - 申請データ内の別項目との連携チェック
  - 他テーブルの保有データとの整合性チェック

# 各種申請フォームから統一フォーマットへの変換
- ExcelデータをDataFrameへ変換する
- DataFrameを使用して異なるExcelフォーマットを統一フォーマットへ変換する
- 個々の申請明細に対して一意に識別可能なキーを付与する

# 変換後データの永続化
-統一フォーマット化後のデータは申請一覧テーブルとしてpickleで永続化する

</一括申請 >


<受付>
# 申請一覧データの受領
- 申請一覧テーブルのpickleファイルを読み込み、 DataFrame として処理する

# 申請明細の処理
- 申請一覧テーブルの各行について、 リファレンスDBからの情報補填・配下組織分の明細の生成を行う
  - 新設申請の場合、 申請明細の情報を変更情報テーブルへ格納する
  - 変更申請・廃止申請の場合、 部店コード・課GrコードをキーとしてリファレンスDBから部署情報を取得し、 申請情報に対して適宜補記した上で変更情報テーブルへ格納する
  - 変更申請・廃止申請の場合、 申請対象の部署の配下にある部署の情報をリファレンスDBから取得し、 配下の部署分 の明細を生成して変更情報テーブルへ格納する

# 重複明細のマージ
- 同じ部署に対する変更情報明細が複数作成された場合は、 情報をマージして1明細にまとめる。

# 編集後データの永続化
- 編集後データは変更情報テーブルとしてpickleで永続化する

</受付>



<パターン編集>

#変更情報一覧の受領
- 変更情報テーブルのpickleファイルを読み込み、 DataFrame として処理する

# 変更情報明細の処理
- 変更情報テーブルの各行について、各カラムの値を元に、リファレンスDBに設定する設定値を計算し、 DB更新情報テ ーブルに格納する
- 設定値の計算はパターンのマッチングに基づいて行う
- DB更新情報 テーブルは、後続の反映処理でCUDパターンで処理できるよう整形する

## パターンのマッチング
- リファレンスDB の各設定値を決定するための計算式は、変更情報明細の各カラムの値によって異なる
- リファレンスDBにおける1明細の設定値を決定する一式の計算式の組み合わせの定義をパターンと呼ぶ
- 変更情報の各明細に対して条件判定を行い、 条件に合致したパターンを適用する

# 編集後データの永続化
- 編集後データはDB更新情報テーブルとしてpickleで永続化する

# DB更新情報テーブルの修正
- 業務要件に応じて、 DB更新情報テーブルに対して任意の行を追加・削除する
</パターン編集〉
<

反映・送信>
# 反映
 - パターン編集処理後のDB更新情報明細を元にリファレンスDBへの反映を行う
 - 明細が持つ反映日をキーとする
 - 運用パラメータ制御により、反映指定日前にデータ仮反映を行う
 - カレンダーは銀行カレンダーを取得し、 営業日での制御を行う

#一括処理
- データが保有する値に依存しない、共通の一括処理を行う
 - リファレンスDBに対し、休職・本部詰の部署情報を作成・削除する
  - 「休職・本部詰の親部店」 に該当する部署の配下に休職・本部詰部署がなければ作成する
  - 「休職・本部詰の親部店」に該当しない部署の配下に休職・本部詰部署があれば削除する


# 送信
- 後続システムに連携するためのCSVファイルと制御ファイルを作成する
- 更新日にCSVファイルと制御ファイルを関連システムへSFTP送信する
- 仮反映データ及び本反映データを送信する

</反映・送信>

</データライフサイクル>


<システムデザイン要件>
<共通>
- Pythonによるリライトとする
- validaion及び整合性チェックは python のpydanticライブラリを使用する
- データの永続化にはPythonのpickle形式ファイルを使用する
- 共通ライブラリとしてシステム再利用可能処理を実装する
</共通>

<一括申請 >
- 申請フォーム (Excelファイル) に対するValidaion 整合性チェックを行う
- ExcelデータをDataFrame (統一フォーマット) へ変換する
- 個々の申請明細に対して一意に識別可能なキーを付与する
- 統一フォーマット化後のデータは申請一覧テーブルとしてpickleで永続化する
</一括申請>

<受付>
- 仕様変更や異例ケースを吸収しなるべく後続処理に変更が入らないような役割を担う
- 現行実装ではifネストが異様に深かったり、 異例ケースが突然ベタ書きされたりと、 保守効率化に問題がある
- main/Factory/Fadace/編集部品構成デザインに変更する
- Factory での if 条件 (and or の組み合わせ) は約6段階がある
- Facadeは約100パターンを想定する
  - Facadeでは項目に対する編集処理を呼び出す定義が記述される
  - Facadeでループ処理やif分岐は存在しない前提
- データ編集部品は50個程度を利用する
  - データ編集部品では単独編集を行うものがある
  - システム内のテーブルデータから取得した値を設定するパターンもある
  - 単独編集であるか?の判定は分岐制御には持たない、 呼び出した部品により確定している
    - 部品ごとに単独編集を定義する
    - 部品ごとにテーブルが持つデータに基づく編集を定義する
- Factory で、 異例ケースデータはアーリーリターンの考え方を導入する
  - Factoryで異例ケースであるかを判定し、 アーリーリターンとして異例ケース用のFacade を呼び出す
    - 異例ケース用のFacadeは個別に用意する
    - 異例ケース用のFacadeも他Facadeと同様に編集定義を持ち、 編集部品を定義に従い呼び出す
      - データ編集部品では単独編集を行うものがある
      - システム内のテーブルデータから取得した値を設定するパターンもある
- 入力データの受付処理後のデータは永続化 (pickle) する
- 編集部品で発生した例外はthrow し、 Facadeで例外処理を行うデザインとする
</受付>

<パターン編集>
- Factory パターンとFacadeパターンの組み合わせを採用する
- 構成要素は以下の4つとする
  - main
  - Factory
    - 変更情報明細毎に、どのパターンを適用するかを判定するための条件を定義
  - Facade
    - 編集情報明細に対して適用し、 リファレンスDBに登録するための設定値一式を算出するための編集部品の組み合わせ(パターン)の定義
    - 1つのFacadeが1つのパターンとなる
  - 編集部品
    - リファレンスDBの設定値1個を決めるための計算式の定義
- Factoryでの条件判定に使われる項目は以下
 - 部店コードの値
 - 部店コードの桁数
 - 拠点内営業部コードの有無
 - 課Grコードの有無
 - 親部店コードの有無
 - BPR AD対象フラグの値
 - 常駐部店コードの値

- Factoryで、 異例ケースデータはアーリーリターンの考え方を導入する
  - Factoryで異例ケースであるかを判定し、アーリーリターンとして異例ケース用のFacade を呼び出す
    - 異例ケース用のFacadeは個別に用意する
    - 異例ケース用のFacadeも他Facadeと同様に編集定義を持ち、編集部品を定義に従い呼び出す データ編集部品では単独編集を行うものがある
      - システム内のテーブルデータから取得した値を設定するパターンもある

- Facadeは約100パターンを想定する
- Facadeではループ処理やif分岐は行わない

- データ編集部品は50個程度を利用する
  - データ編集部品では単独編集を行うものがある
  - システム内のテーブルデータから取得した値を設定するパターンもある
  - 単独編集であるかの判定は分岐制御には持たず、呼び出した部品により確定している
    - 部品ごとに単独編集を定義する
    - 部品ごとにテーブルが持つデータに基づく編集を定義する
- 編集部品で発生した例外はthrow し、 Facadeで例外処理を行うデザインとする
- 入力データのパターン編集後のデータはpickleで永続化する
</パターン編集〉

<反映 送信>
- <パターン編集〉で生成した永続化データ (DB更新情報明細) を使用する
- DB更新情報明細によりリファレンステーブルを更新する
- DB更新情報明細に反映日付が定義されており、その日付に則りテーブル更新する
- ダミー課Gr情報を取得しダミー課テーブルを作成する
- 関連システムに渡すデータはリファレンステーブル及びダミー課テールレコードが対象となる

- 文書切替
  - 定義した事前提供日には受渡し側の要件に從いデータ加工しCSV化して送付する
  - 反映日5営業日前ケース
  - 反映日前日ケース
- 一括处理
  - データが保有する値に依存のない、 共通の一括処理を担当する
  - 送信するCSVファイルはバリデーションチェックを行う
- メール送信
  - 部店新規・廃止の場合に実行する
  - リファレンステーブル更新連絡とともに、 部店情報. txtを作成しメール添付する
- テーブル更新前にテーブルファイルを物理コピーを行い履歴保有する
</反映 送信>

</システムデザイン要件>






