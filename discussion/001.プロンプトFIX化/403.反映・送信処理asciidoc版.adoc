= 反映・送信サブセクション 機能設計書

== 1. 要件定義

=== 1.1. 要求分析
反映・送信サブセクションでは、パターン処理後のデータを受け取り、リファレンステーブルとダミー課テーブルへの更新、一括処理、CSVファイルの作成と送信、部店新規・廃止判定、テーブルファイルの履歴保有を行います。これらの処理を通じて、関連システムへのデータ提供と、システム内のデータ整合性維持を実現します。

=== 1.2. 移植での改善方針
==== 1.2.1. 単一責務化
反映処理、一括処理、送信処理をそれぞれ独立したモジュールとして設計することで、各処理の責務を明確化し、保守性と拡張性を向上させます。

==== 1.2.2. データ反映制御
リファレンステーブルとダミー課テーブルへのデータ反映は、事前提供日の判定に基づいて制御します。これにより、データ反映のタイミングを適切に管理できます。

==== 1.2.3. 一括処理
データが保有する値に依存しない共通の一括処理を独立したモジュールとして設計することで、処理の再利用性を高めます。

==== 1.2.4. データ送信
CSVファイルの作成とバリデーションチェック、関連システムへの送信を独立したモジュールとして設計することで、送信処理の独立性を確保します。

== 2. 機能定義

=== 2.1. 機能概要
==== 2.1.1. 目的
反映・送信サブセクションは、パターン処理後のデータを受け取り、リファレンステーブルとダミー課テーブルへの更新、一括処理、CSVファイルの作成と送信、部店新規・廃止判定、テーブルファイルの履歴保有を行うことを目的とします。

==== 2.1.2. 対象ユーザー
本サブセクションの対象ユーザーは、システム管理者および関連システムのユーザーです。

==== 2.1.3. 機能範囲
反映・送信サブセクションは、以下の機能を提供します。

* リファレンステーブルとダミー課テーブルへのデータ反映
* 一括処理の実行
* CSVファイルの作成とバリデーションチェック
* 関連システムへのCSVファイル送信
* 部店新規・廃止判定とメール送信
* テーブルファイルの履歴保有

=== 2.2. 処理フロー
==== 2.2.1. 全体フロー
[plantuml]
----
@startuml
start
:反映処理;
:一括処理;
:送信処理;
stop
@enduml
----

==== 2.2.2. 反映処理フロー
[plantuml]
----
@startuml
start
:リファレンステーブル更新;
:ダミー課テーブル更新;
:事前提供日判定;
if (反映日5営業日前?) then (yes)
  :反映日5営業日前の処理;
else (no)
  if (反映日前日?) then (yes)
    :反映日前日の処理;
  else (no)
    :通常の反映処理;
  endif
endif
stop
@enduml
----

==== 2.2.3. 一括処理フロー
[plantuml]
----
@startuml
start
:リファレンステーブル共通処理;
:ダミー課テーブル共通処理;
stop
@enduml
----

==== 2.2.4. 送信処理フロー
[plantuml]
----
@startuml
start
:CSVファイル作成;
:バリデーションチェック;
:関連システムへのCSVファイル送信;
:部店新規・廃止判定;
if (部店新規・廃止?) then (yes)
  :部店情報.txt作成;
  :メール送信;
else (no)
endif
:テーブルファイルの履歴保有;
stop
@enduml
----

=== 2.3. 機能詳細
==== 2.3.1. 反映処理
反映処理は、パターン処理後のデータを受け取り、リファレンステーブルとダミー課テーブルへのデータ反映を行います。事前提供日の判定に基づいて、反映日5営業日前の処理、反映日前日の処理、通常の反映処理を実行します。

[cols="1,3", options="header"]
|===
|処理名 |説明
|リファレンステーブル更新 |リファレンステーブルに対して、パターン処理後のデータに基づいて更新処理を行います。
|ダミー課テーブル更新 |ダミー課テーブルに対して、パターン処理後のデータに基づいて更新処理を行います。
|事前提供日判定 |事前提供日の判定を行い、反映日5営業日前の処理、反映日前日の処理、通常の反映処理を選択します。
|反映日5営業日前の処理 |反映日の5営業日前に実行する処理を定義します。
|反映日前日の処理 |反映日の前日に実行する処理を定義します。
|通常の反映処理 |通常の反映処理を定義します。
|===

==== 2.3.2. 一括処理
一括処理は、データが保有する値に依存しない共通の処理を実行します。

[cols="1,3", options="header"]
|===
|処理名 |説明
|リファレンステーブル共通処理 |リファレンステーブルに対する共通処理を定義します。
|ダミー課テーブル共通処理 |ダミー課テーブルに対する共通処理を定義します。
|===

==== 2.3.3. 送信処理
送信処理は、CSVファイルの作成とバリデーションチェック、関連システムへの送信、部店新規・廃止判定とメール送信、テーブルファイルの履歴保有を行います。

[cols="1,3", options="header"]
|===
|処理名 |説明
|CSVファイル作成 |リファレンステーブルとダミー課テーブルのデータをCSVファイルに出力します。
|バリデーションチェック |作成したCSVファイルに対してバリデーションチェックを行います。
|関連システムへのCSVファイル送信 |バリデーションチェックを通過したCSVファイルを関連システムへ送信します。
|部店新規・廃止判定 |部店の新規登録や廃止の判定を行います。
|部店情報.txt作成 |部店新規・廃止の場合、部店情報.txtを作成します。
|メール送信 |部店新規・廃止の場合、メールを送信します。
|テーブルファイルの履歴保有 |テーブルファイルの履歴を保有します。
|===

== 3. システムデザイン

=== 3.1. コンポーネント図
[plantuml]
----
@startuml
package "反映・送信" {
  [反映処理] as Reflection
  [一括処理] as Batch
  [送信処理] as Sending
  
  database "リファレンステーブル" as RefTable
  database "ダミー課テーブル" as DummyTable
  
  Reflection --> RefTable
  Reflection --> DummyTable
  Batch --> RefTable
  Batch --> DummyTable
  Sending --> RefTable
  Sending --> DummyTable
}
@enduml
----

=== 3.2. シーケンス図
[plantuml]
----
@startuml
actor User
participant "反映処理" as Reflection
participant "一括処理" as Batch
participant "送信処理" as Sending
database "リファレンステーブル" as RefTable
database "ダミー課テーブル" as DummyTable

User -> Reflection: 反映処理開始
Reflection -> RefTable: テーブル更新
Reflection -> DummyTable: テーブル更新
Reflection -> Batch: 一括処理開始

Batch -> RefTable: 共通処理
Batch -> DummyTable: 共通処理
Batch -> Sending: 送信処理開始

Sending -> RefTable: CSVファイル作成
Sending -> DummyTable: CSVファイル作成
Sending -> Sending: バリデーションチェック
Sending -> 関連システム: CSVファイル送信
Sending --> User: 処理完了通知
@enduml
----

=== 3.3. アクティビティ図
[plantuml]
----
@startuml
start
:反映処理;
:リファレンステーブル更新;
:ダミー課テーブル更新;
:事前提供日判定;
if (反映日5営業日前?) then (yes)
  :反映日5営業日前の処理;
else (no)
  if (反映日前日?) then (yes)
    :反映日前日の処理;
  else (no)
    :通常の反映処理;
  endif
endif

:一括処理;
:リファレンステーブル共通処理;
:ダミー課テーブル共通処理;

:送信処理;
:CSVファイル作成;
:バリデーションチェック;
:関連システムへのCSVファイル送信;

:部店新規・廃止判定;
if (部店新規・廃止?) then (yes)
  :部店情報.txt作成;
  :メール送信;
else (no)
endif

:テーブルファイルの履歴保有;
stop
@enduml
----

== 4. 入出力データ

=== 4.1. 入力インターフェース
==== 4.1.1. pickleファイル（パターン処理後の永続化データ）
パターン処理後の永続化データをpickleファイルから読み込みます。

=== 4.2. 出力インターフェース
==== 4.2.1. pickleファイル（反映処理前の永続化データ）
反映処理前の永続化データをpickleファイルに出力します。

==== 4.2.2. pickleファイル（反映処理後の永続化データ）
反映処理後の永続化データをpickleファイルに出力します。

==== 4.2.3. csvファイル
リファレンステーブルとダミー課テーブルのデータをCSVファイルに出力します。

==== 4.2.4. 制御ファイル
CSVファイルの送信に必要な制御ファイルを作成します。

== 5. エラー処理

=== 5.1. エラーパターン
反映・送信サブセクションで発生する可能性のあるエラーパターンを以下に示します。

[cols="1,3", options="header"]
|===
|エラーパターン |説明
|データ不整合エラー |リファレンステーブルとダミー課テーブルのデータに不整合がある場合に発生します。
|CSVファイル作成エラー |CSVファイルの作成に失敗した場合に発生します。
|バリデーションエラー |CSVファイルのバリデーションチェックに失敗した場合に発生します。
|送信エラー |関連システムへのCSVファイル送信に失敗した場合に発生します。
|===

=== 5.2. エラーメッセージ
各エラーパターンに対応するエラーメッセージを以下に示します。

[cols="1,3", options="header"]
|===
|エラーパターン |エラーメッセージ
|データ不整合エラー |"データに不整合があります。管理者に連絡してください。"
|CSVファイル作成エラー |"CSVファイルの作成に失敗しました。管理者に連絡してください。"
|バリデーションエラー |"CSVファイルのバリデーションに失敗しました。データを確認してください。"
|送信エラー |"関連システムへのCSVファイル送信に失敗しました。ネットワーク接続を確認してください。"
|===

== 6. ロギング設計
反映・送信サブセクションでは、以下のイベントに対してロギングを行います。

* pickleファイルの読み込み
* リファレンステーブルとダミー課テーブルの更新
* CSVファイルの作成
* バリデーションチェック
* 関連システムへのCSVファイル送信
* 部店新規・廃止判定とメール送信
* テーブルファイルの履歴保有

ログには、イベントの発生日時、処理内容、結果を記録します。エラー発生時には、エラーメッセージとスタックトレースを記録します。

== 7. セキュリティ要件
反映・送信サブセクションでは、以下のセキュリティ要件を満たす必要があります。

* pickleファイルやCSVファイルなどの入出力ファイルへのアクセス制御
* 関連システムとの通信の暗号化
* 認証・認可機能による不正アクセスの防止

== 8. 運用記述
反映・送信サブセクションの運用に関する情報を以下に示します。

* 本番環境で実行する
* データの取り扱い
** データ反映前にpickleファイルの物理コピーを作成する
** コピーしたファイルのリテンション期間はシステム設定に従う
* 実行スケジュール
** JP1で自動スケジュール設定
** 日次実行

== 9. 別紙
反映・送信サブセクションに関連する以下の資料は、別紙として提供します。

* 各種データレイアウト
* データ制御パターン
* 一括処理内容
* CSV出力後のValidaion／整合性チェック事項

<revision>
* 処理フローの説明順序を見直し、全体フロー、反映処理フロー、一括処理フロー、送信処理フローの順に修正しました。
* 機能詳細の説明をテーブル形式でまとめ、処理名と説明を明確にしました。
* エラー処理の章を「例外設計」から「エラー処理」に変更し、エラーパターンとエラーメッセージをテーブル形式でまとめました。
* 誤字脱字を修正し、文章表現を改善しました。
* プロジェクトステークホルダーや開発エンジニアにとってわかりやすい説明になるよう、全体的に記述を見直しました。
</revision>

以上が、反映・送信サブセクションの機能設計書のasciidoc形式での出力になります。この形式で出力することで、設計書の構造が明確になり、読みやすさが向上します。また、PlantUMLを用いた図の埋め込みも可能になるため、視覚的にわかりやすい設計書を作成することができます。

必要に応じて、このasciidoc形式の設計書をHTMLやPDFなどの他の形式に変換することも可能です。asciidocは、多くの出力形式に対応しているため、プロジェクトのニーズに合わせて最適な形式を選択できます。

機能設計書の作成は、開発プロセスにおける重要なステップの1つです。この設計書を基に、詳細設計や実装を進めていくことになります。設計書の内容を関係者で共有し、レビューを行うことで、プロジェクトの品質を高めていきましょう。
