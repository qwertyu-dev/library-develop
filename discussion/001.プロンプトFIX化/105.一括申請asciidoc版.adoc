= 一括申請機能設計書

== 1. 要件定義

=== 1.1. 要求分析
本サブセクションでは、一括申請機能における要求分析について記載する。一括申請機能は、会社の部署情報（部署コード、部署名など）が入っているデータを保持し、それに対する変更申請を管理するシステムの一部である。本機能では、Excelによる部署情報更新データの提供を受け付け、新設・変更・廃止の3パターンに対応する。申請データに対してはValidation／整合性チェックを行い、フォーマット統一変換を実施する。

一括申請機能の主な要求事項は以下の通りである。

* Excelデータの取り込み及び、統一フォーマットへの変換
* 申請データに対するValidationチェック及び整合性チェックの実施
* チェック結果に基づく、データの永続化（pickle化）

=== 1.2. 移植での改善方針
既存システムからの移植に際し、以下の改善を行う。

* 一括利用申請ファイルの項目見直し
* 一括利用申請ファイル取り込み後、統一レイアウトへ変換する
* 単一責務化を図り、編集処理を後続フェーズの受付処理やパターン処理に委譲する
* 受付処理で行われているValidation/整合性チェックを一括申請処理で引き受ける

== 2. 機能定義

=== 2.1. 機能概要
一括申請機能は、部署情報の一括更新を目的とした機能である。本機能では、人事、海外、関連の3部署から提供されるExcelファイルを取り込み、データのバリデーションチェック及び整合性チェックを行う。チェック結果OKのデータに対しては、DataFrameへの変換及び統合フォーマットへの変換を行い、pickle形式で永続化する。

主な機能は以下の通りである。

* Excelデータの取り込み
* データバリデーション（型チェック、整合性チェック）
* DataFrameへの変換
* 統合フォーマットへの変換
* pickle形式での永続化

=== 2.2. 機能詳細

==== 2.2.1. 入力データ

===== 2.2.1.1. Excelデータフォーマット
入力データのExcelファイルフォーマットは、「一括申請Excelフォーマット」（別紙1）の通りとする。

===== 2.2.1.2. 申請部署別のフォーマット差異
人事、海外、関連の3部署から提供されるExcelファイルのフォーマットには差異がある。各部署のフォーマット定義は「申請部署別Excelフォーマット」（別紙2）の通りとする。

==== 2.2.2. データバリデーション

===== 2.2.2.1. 項目単体の型、範囲チェック
入力データの各項目に対し、型及び値の範囲についてチェックを行う。チェック内容は「一括申請バリデーションルール」（別紙3）の通りとする。

===== 2.2.2.2. 別項目との連携チェック
複数の項目を組み合わせたチェック（整合性チェック）を行う。チェック内容は「一括申請整合性チェックルール」（別紙4）の通りとする。

===== 2.2.2.3. 他テーブルデータ保有値とのチェック
データベース内の他テーブルに保有されたデータとの整合性についてチェックを行う。チェック内容は「一括申請データベース整合性チェックルール」（別紙5）の通りとする。

==== 2.2.3. データ変換

===== 2.2.3.1. ExcelデータからDataFrameへの変換
バリデーションチェックOKのExcelデータに対し、DataFrameへの変換を行う。

===== 2.2.3.2. DataFrameの統合フォーマットへの変換
各部署のDataFrameを、統合フォーマットへ変換する。統合フォーマットは「一括申請統合フォーマット」（別紙6）の通りとする。

==== 2.2.4. データ永続化

===== 2.2.4.1. 統合フォーマット後のデータのpickle化
統合フォーマットに変換したデータをpickle形式で永続化する。

[plantuml]
----
@startuml
package "一括申請" {
  [ExcelデータのValidationチェック]
  [ExcelデータのDataFrameへの変換]
  [DataFrameの統合フォーマットへの変換]
  [統合フォーマット後のデータの永続化]
  [ExcelデータのValidationチェック] --> [ExcelデータのDataFrameへの変換]
  [ExcelデータのDataFrameへの変換] --> [DataFrameの統合フォーマットへの変換]
  [DataFrameの統合フォーマットへの変換] --> [統合フォーマット後のデータの永続化]
}
@enduml
----

=== 2.3. インターフェース

==== 2.3.1. 入力インターフェース

===== 2.3.1.1. Excelデータ受け取り方法
人事、海外、関連の3部署から、Excelファイルの提供を受ける。受け取り方法の詳細は「Excelデータ受け取り方法」（別紙7）の通りとする。

==== 2.3.2. 出力インターフェース

===== 2.3.2.1. 統合フォーマットデータの受け渡し方法
統合フォーマットに変換したデータの受け渡し方法は「統合フォーマットデータ受け渡し方法」（別紙8）の通りとする。

[plantuml]
----
@startuml
actor User
participant "ExcelデータのValidationチェック" as Validation
participant "ExcelデータのDataFrameへの変換" as DataFrame
participant "DataFrameの統合フォーマットへの変換" as FormatConversion
participant "統合フォーマット後のデータの永続化" as Persistence

User -> Validation: Excelデータの提示
Validation -> DataFrame: チェック結果OK
DataFrame -> FormatConversion: DataFrameの変換
FormatConversion -> Persistence: 統合フォーマットデータの永続化
@enduml
----

=== 2.4. エラー処理

==== 2.4.1. バリデーションエラー時の処理
バリデーションエラー発生時は、エラー内容をログに出力し、処理を中断する。エラー時の処理フローは「バリデーションエラー時処理フロー」（別紙9）の通りとする。

==== 2.4.2. データ変換エラー時の処理
データ変換処理でエラーが発生した場合、エラー内容をログに出力し、処理を中断する。エラー時の処理フローは「データ変換エラー時処理フロー」（別紙10）の通りとする。

==== 2.4.3. データ永続化エラー時の処理
データ永続化処理でエラーが発生した場合、エラー内容をログに出力し、処理を中断する。エラー時の処理フローは「データ永続化エラー時処理フロー」（別紙11）の通りとする。

[plantuml]
----
@startuml
start
:Excelデータの提示;
:ExcelデータのValidationチェック;
if (チェック結果OK?) then (yes)
  :ExcelデータのDataFrameへの変換;
  :DataFrameの統合フォーマットへの変換;
  :統合フォーマット後のデータの永続化;
else (no)
  :エラー処理;
endif
stop
@enduml
----

=== 2.5. 使用ライブラリ

==== 2.5.1. pydanticを用いたバリデーション
データバリデーションにはpydanticライブラリを使用する。

==== 2.5.2. pandasを用いたDataFrame変換
ExcelデータのDataFrameへの変換にはpandasライブラリを使用する。

==== 2.5.3. pickleを用いたデータ永続化
データ永続化にはpickleライブラリを使用する。

== 3. 入出力データ

=== 3.1. 入力: Excelファイル(3部署からの申請データ)
入力は、人事、海外、関連の3部署から提供されるExcelファイルとなる。

=== 3.2. 出力: pickleファイル（処理後の永続化データ）
出力は、統合フォーマットに変換後のデータをpickle形式で永続化したファイルとなる。

== 4. 例外設計

=== 4.1. 例外一覧を定義
本機能で発生しうる例外は以下の通りとする。

[cols="1,1,2,2"]
|===
| 管理番号 | 発生事象 | 原因 | 対処方針

| E-0001
| ファイル読み込みエラー
| 指定フォーマットと異なるファイルの読み込み
| ログ出力し、処理中断

| E-0002
| バリデーションエラー
| 型不正、必須項目欠落等
| ログ出力し、処理中断

| E-0003
| 整合性チェックエラー
| 関連項目間の不整合
| ログ出力し、処理中断

| E-0004
| 変換エラー
| DataFrameへの変換失敗
| ログ出力し、処理中断

| E-0005
| 永続化エラー
| pickle形式での永続化失敗
| ログ出力し、処理中断

|===

== 5. ロギング設計

=== 5.1. どのファイルをいつ取り込みしたかの記録
処理対象のファイル名、処理開始日時、処理完了日時をログに出力する。

=== 5.2. Validation/整合性チェックエラーでのエラー位置特定情報

==== 5.2.1. Excelファイル、シート名、行・列位置、値、正しい型想定・値など
エラー発生箇所を特定するため、以下の情報をログに出力する。

* Excelファイル名
* シート名
* エラー発生セルの行番号、列番号
* エラー発生セルの値
* 想定する型・値

== 6. セキュリティ要件
本機能におけるセキュリティ要件は特に定義しない。

== 7. 運用記述

=== 7.1. データの取扱

==== 7.1.1. 申請データは保管しない
入力された申請データ（Excelファイル）は、取り込み処理完了後に削除する。

==== 7.1.2. 処理結果となるデータはリポジトリ管理する
出力されたpickleファイルは、システムで定義されたリポジトリに保存し、バージョン管理する。

=== 7.2. 実行スケジュール

==== 7.2.1. Jenkinsで自動スケジュール設定
一括申請処理の実行スケジュールは、Jenkins上で定義する。

==== 7.2.2. 日次実行
一括申請処理は日次で実行する。

==== 7.2.3. マニュアル対応でJenkins実行を行うことを想定する
通常運用では日次自動実行とするが、再実行等の場合はJenkinsのジョブ実行によりマニュアル実行する。

== 8. 別紙
* 別紙1. 一括申請Excelフォーマット
* 別紙2. 申請部署別Excelフォーマット
* 別紙3. 一括申請バリデーションルール
* 別紙4. 一括申請整合性チェックルール
* 別紙5. 一括申請データベース整合性チェックルール
* 別紙6. 一括申請統合フォーマット
* 別紙7. Excelデータ受け取り方法
* 別紙8. 統合フォーマットデータ受け渡し方法
* 別紙9. バリデーションエラー時処理フロー
* 別紙10. データ変換エラー時処理フロー
* 別紙11. データ永続化エラー時処理フロー
