= システム設計書

== 1. はじめに

=== 1.1. 目的
本文書は、組織変更リファレンスデータ管理システムの機能設計について記述したものである。
本文書では、システムの全体像、機能要件、データ設計、非機能要件、運用設計、移行設計、リグレ運用設計、および各種定義一覧について詳細に説明する。

=== 1.2. 適用範囲
本文書は、組織変更リファレンスデータ管理システムの開発・運用・保守に関わる全ての関係者を対象とする。

== 2. システム概要
組織変更リファレンスデータ管理システムは、銀行における部署情報の一元管理と、組織変更に伴う部署情報の更新を効率的に行うことを目的としたシステムです。本システムは、各部署からの申請に基づいて、部署情報の新設・変更・廃止を行い、反映スケジュールに基づき組織情報を維持することを目指しています。

本システムは、大きく分けて4つのサブシステムで構成されています。

[cols="1,3"]
|===
| 1. 一括申請 | 各部署からのExcelファイルによる申請を受け付け、データの検証と統一フォーマットへの変換を行います。
| 2. 受付 | 申請データの編集や整形、情報補填を行います。
| 3. パターン編集 | 受付済みデータを元に、リファレンステーブルに登録するための各種設定値を計算します。
| 4. 反映・送信 | 編集済みデータをリファレンステーブルに反映し、関連システムへのデータ連携を行います。
|===

これらのサブシステムは、それぞれ独立した機能を持ちながら、連携して動作することで、申請データの処理からリファレンス テーブルの更新、関連システムへのデータ連携までの一連の流れを実現しています。

本システムでは、データの永続化にpickleファイルを使用し、効率的なデータの保存と読み込みを可能にしています。また、pandas、pydanticといったPythonのライブラリを活用することで、データの検証や変換、編集といった処理を柔軟かつ効率的に行うことができます。

さらに、本システムでは、ログ出力、設定ファイルの読み込み、データベース接続、SFTP接続、メール送信といった共通機能を提供しています。これにより、各サブシステムでの処理を簡潔に記述でき、システム全体の保守性と拡張性を高めています。
本システムの利用者は、主に人事部門、国際事務部門、関連会社の3つの部署となります。これらの部署は、それぞれ国内拠点、海外拠点、関連会社に関する申請データを提供し、処理結果としてリファレンステーブルの情報を利用します。また、システム管理者は、リファレンステーブルの運用・保守を担当します。

本システムは、各部署からの申請データを適切に処理し、リファレンステーブルを常に最新の状態に保つことで、銀行全体の組織情報の一元管理を実現します。また、関連システムとのデータ連携により、他のシステムでも最新の組織情報を利用できるようにします。これにより、組織変更に伴う情報更新の効率化と、業務の正確性・迅速性の向上を図ります。

=== 2.1. システムの目的
組織変更リファレンスデータ管理システムは、銀行における部署情報の一元管理と、組織変更に伴う部署情報の更新を効率的に行うことを主な目的としています。銀行では、組織変更に伴って部署情報の新設・変更・廃止が頻繁に発生します。これらの情報を各システムで個別に管理していると、情報の不整合が生じる可能性があり、業務の効率性や正確性が損なわれる恐れがあります。そこで、本システムでは、部署情報を一元的に管理するためのシステム構築し、各部署からの申請に基づいて、リファレンステーブルの情報を更新していきます。

本システムにおける部署情報の一元管理には、以下のような利点があります。

[cols="1,3"]
|===
| 1. 情報の整合性の確保 | リファレンステーブルを中心に部署情報を管理することで、全社的に情報の整合性を保つことができます。
| 2. 業務効率の向上 | 部署情報の更新作業を本システムに集約することで、各部署での個別の更新作業を削減し、業務効率を向上させることができます。
| 3. 情報の再利用性の向上 | リファレンステーブルの情報を他のシステムでも利用できるようにすることで、情報の再利用性を高め、システム間の連携を円滑に行うことができます。
|===

また、本システムでは、申請データの処理を自動化することで、組織変更に伴う部署情報の更新を迅速かつ正確に行うことを目指しています。具体的には、以下のような点に注力しています。

[cols="1,3"]
|===
| 1. 申請データの検証 | 申請データの形式や内容を自動的にチェックし、不備がある場合はエラーを返すことで、データの品質を維持します。
| 2. 設定値の自動計算 | 部署情報に関する各種設定値を、あらかじめ定義されたルールに従って自動的に計算することで、手作業によるミスを防止します。
| 3. 関連システムとの連携 | 更新された部署情報を、関連するシステムに自動的に連携することで、情報の同期を確保します。
|===

本システムの目的は、銀行全体の組織情報の管理を効率化し、業務の正確性と迅速性を向上させることにあります。これにより、組織変更に伴う様々な業務の円滑化を図り、銀行業務全体の生産性の向上に寄与することを目指しています。

=== 2.2. システムの全体像
組織変更リファレンスデータ管理システムの全体像は、4つの主要なサブシステムと、それらを支える共通機能から構成されています。 まず、4つの主要なサブシステムは以下の通りです。

[cols="1,3"]
|===
| 1. 一括申請 | 各部署からのExcelファイルによる申請を受け付け、データの検証と統一フォーマットへの変換を行います。このサブシステムでは、pandas、pydanticといったPythonのライブラリを活用し、効率的なデータ処理を実現しています。
| 2. 受付 | 一括申請からデータを受け取り、申請内容に応じたデータの編集、整形、情報の補填を行います。ここでは、主にpandasを用いたデータ処理が行われます。
| 3. パターン編集 | 受付済みのデータを元に、リファレンステーブルに登録するための各種設定値を計算します。計算ルールは、申請内容に応じて複数のパターンが用意されており、適切なパターンを選択して処理が行われます。
| 4. 反映・一括処理・送信 | パターン編集の結果を受け取り、リファレンステーブルへのデータ反映と、関連システムへのデータ連携を行います。リファレンステーブルへの反映は、pickleファイルを介して行われ、関連システムへはCSVファイルを作成してSFTP経由で送信されます。
|===

これらのサブシステムは、それぞれが独立した機能を持ちながら、データをシーケンシャルに受け渡すことで、全体としての処理の流れを形成しています。

次に、これらのサブシステムを支える共通機能は以下の通りです。

[cols="1,3"]
|===
| 1. ログ出力 | 各サブシステムでの処理の経過や結果を、ログファイルに出力する機能です。これにより、システムの動作状況を把握し、問題が発生した際の原因特定を容易にします。
| 2. 設定ファイルの読み込み | システムの動作に必要な各種設定情報を、設定ファイルから読み込む機能です。これにより、システムの設定変更を容易に行うことができます。
| 3. データロード | リファレンステーブル他、データをロードする機能です。この機能を共通化することで、各サブシステムでのデータ取得処理を簡略ができます。
| 4. SFTP接続 | 関連システムへのCSVファイルの送信を行うためのSFTP接続を管理する機能です。この機能を共通化することで、各サブシステムでのSFTP接続処理を簡略化できます。
| 5. メール送信 | システムの運用に関する通知などを行うためのメール送信機能です。この機能を共通化することで、各サブシステムでのメール送信処理を簡略化できます。
|===

これらの共通機能は、各サブシステムから呼び出されて利用されます。共通機能を集約することで、システム全体の保守性と拡張性を高めることができます。
以上が、組織変更リファレンスデータ管理システムの全体像です。4つの主要なサブシステムが、共通機能を活用しながら連携することで、部署情報の一元管理と更新を実現しています。このようなアーキテクチャにより、システムの柔軟性、効率性、保守性を確保しながら、業務要件を満たすことを目指しています。

=== 2.3. システムのコンポーネント構成
組織変更リファレンスデータ管理システムは、機能と役割に基づいて複数のコンポーネントに分割されています。各コンポーネントは、独立した責務を持ち、相互に連携することでシステム全体の機能を実現しています。
本システムのコンポーネント構成は、大きく分けて4つの主要コンポーネントと1つの共通コンポーネントから成ります。主要コンポーネントは、一括申請、受付、パターン編集、反映・送信の4つで、それぞれが独立したプロセスとして動作します。これらのコンポーネントは、システムの中核をなす機能を担当し、データの流れに沿って順次処理を行います。
一方、共通コンポーネントは、主要コンポーネントから呼び出されて利用される共通機能を提供します。これには、ログ出力、設定ファイルの読み込み、データベース接続、SFTP接続、メール送信などが含まれます。共通コンポーネントを利用することで、主要コンポーネントでの処理を簡略化し、コードの重複を避けることができます。

以下の表は、各コンポーネントの概要を示しています。
[cols="1,3"]
|===
| コンポーネント名 | 説明
| 一括申請コンポーネント | 各部署からのExcelファイルによる申請を受け付け、データの検証と統一フォーマットへの変換を行います。pandas、pydanticなどのライブラリを活用し、効率的なデータ処理を実現します。
| 受付コンポーネント | 一括申請からデータを受け取り、申請内容に応じたデータの編集、整形、情報の補填を行います。主にpandasを用いたデータ処理が行われます。
| パターン編集コンポーネント | 受付済みのデータを元に、リファレンステーブルに登録するための各種設定値を計算します。申請内容に応じて複数のパターンが用意されており、適切なパターンを選択して処理を行います。
| 反映・一括処理・送信コンポーネント | パターン編集の結果を受け取り、リファレンステーブルへのデータ反映と、関連システムへのデータ連携を行います。リファレンステーブルへの反映はpickleファイルを介して行われ、関連システムへはCSVファイルを作成してSFTP経由で送信されます。
| 共通ライブラリ | 主要コンポーネントから呼び出されて利用される共通機能を提供します。ログ出力、設定ファイルの読み込み、データベース接続、SFTP接続、メール送信などの機能が含まれます。
|===

これらのコンポーネントは、それぞれ独立したプロセスとして実装されます。各コンポーネントは、入力データを受け取り、処理を行い、結果を次のコンポーネントに引き渡します。コンポーネント間のデータの受け渡しには、主にpickleファイルが使用されます。これにより、コンポーネント間の結合を疎にし、システムの保守性と拡張性を高めています。
また、各コンポーネントは、必要に応じて共通ライブラリを呼び出して利用します。共通ライブラリは、コンポーネント間で共有される機能を提供するため、コードの重複を避け、システムの保守性を向上させます。
このようなコンポーネント構成により、組織変更リファレンスデータ管理システムは、柔軟性と拡張性を維持しながら、効率的なデータ処理と管理を実現しています。各コンポーネントの役割と責務を明確に分離することで、システムの開発と保守を容易にし、さらなる機能追加や変更にも対応しやすい構造となっています。

=== 2.4. データフロー
データフローは以下の通りである。

. 各部署からのExcelファイルによる申請が一括申請コンポーネントに届く。
. 一括申請コンポーネントでデータの検証と統一フォーマットへの変換が行われ、結果が受付コンポーネントに渡される。
. 受付コンポーネントで申請データの編集や整形、情報補填が行われ、結果がパターン編集コンポーネントに渡される。
. パターン編集コンポーネントで各種設定値の計算が行われ、結果が反映・送信コンポーネントに渡される。
. 反映・送信コンポーネントで編集済みデータがリファレンステーブルに反映され、関連システムへのデータ連携が行われる。

[plantuml]
----
@startuml
skinparam componentStyle rectangle

actor "各部署" as departments
actor "関連システム" as related_systems
database "リファレンステーブル" as reference_db

rectangle "組織変更リファレンスデータベースシステム" {
    component "一括申請" as bulk_application
    component "受付" as reception
    component "パターン編集" as pattern_editing
    component "反映・送信" as reflection_transmission
}

departments --> bulk_application : Excelファイル
bulk_application --> reception : pickleファイル
reception --> pattern_editing : pickleファイル
pattern_editing --> reflection_transmission : pickleファイル
reflection_transmission --> reference_db : データ反映
reflection_transmission --> related_systems : CSVファイル
@enduml
----

=== 2.5. 内部インターフェース
本システムは、以下の内部インターフェースを持つ。

# TODO 詳細化
# TODO 一覧のみにして別紙へ誘導

* 一括申請Excelファイル(人事、国際、関連)
* 一括申請統合レイアウト
* リファレンステーブル
* 課情報テーブル
* 部門テーブル
* .etc

=== 2.6. 外部インターフェース
本システムは、以下の外部システムとインターフェースを持つ。

# TODO 詳細化
# TODO 一覧のみにして別紙へ誘導

* 人事部門システム: 人事部からの申請データ (Excelファイル) を受け取る。
* 国際事務部門システム: 国際事務部からの申請データ (Excelファイル) を受け取る。
* 関連会社システム: 関連会社からの申請データ (Excelファイル) を受け取る。
* 行内BPRシステム: リファレンスデータを連携する。
* 行内共通認証システム: リファレンスデータを連携する。

== 3. 機能要件

=== 3.1. 機能一覧
本システムが提供する機能は以下の通りである。

* 一括申請機能: 各部署からのExcelファイルによる申請を受け付け、データの検証と統一フォーマットへの変換を行う。
* 受付機能: 申請データの編集や整形、情報補填を行う。
* パターン編集機能: 受付済みデータを元に、リファレンステーブルに登録するための各種設定値を計算する。
* 反映・送信機能: 編集済みデータをリファレンステーブルに反映し、関連システムへのデータ連携を行う。
* 共通機能: 各機能で共通的に使用される処理を提供する。
* データ管理機能: リファレンステーブルのデータ管理に関する機能を提供する。

=== 3.2. 機能詳細

==== 3.2.1. 一括申請機能
一括申請機能は、各部署からのExcelファイルによる申請を受け付け、データの検証と統一フォーマットへの変換を行う機能である。
本機能では、人事部門、国際事務部門、関連会社の3つの部署から申請データを受け取る。
受け取ったデータはpydanticライブラリを使用してバリデーションを行い、不正なデータがある場合はエラーを返す。
バリデーションを通過したデータは、pandasライブラリを使用して統一フォーマットに変換される。
変換後のデータはpickleファイルとして保存され、受付機能に引き渡される。

===== 3.2.1.1. 入力データ
入力データは、人事部門、国際事務部門、関連会社の3つの部署から提供されるExcelファイルである。
各Excelファイルには、部署情報の新設・変更・廃止に関する申請データが含まれる。
Excelファイルのフォーマットは部署ごとに異なるため、本機能では各フォーマットに合わせたデータ読み込み処理を行う。

===== 3.2.1.2. 処理フロー
一括申請機能の処理フローは以下の通りである。

. 各部署からのExcelファイルを読み込む。
. pydanticライブラリを使用してデータのバリデーションを行う。
. バリデーションエラーがある場合はエラーを返す。
. pandasライブラリを使用してデータを統一フォーマットに変換する。
. 変換後のデータをpickleファイルとして保存する。
. 保存したpickleファイルのパスを受付機能に引き渡す。

===== 3.2.1.3. 出力データ
出力データは、統一フォーマットに変換された申請データのpickleファイルである。
pickleファイルには、以下の情報が含まれる。

* 申請ID
* 申請日時
* 申請種別 (新設・変更・廃止)
* 部署コード
* 部署名
* 上位部署コード
* 有効日
* その他の部署情報

===== 3.2.1.4. エラー処理
一括申請機能では、以下のエラー処理を行う。

* Excelファイルの読み込みエラー: Excelファイルが読み込めない場合はエラーを返す。
* バリデーションエラー: pydanticライブラリによるバリデーションでエラーが発生した場合はエラーを返す。
* データ変換エラー: pandasライブラリによるデータ変換でエラーが発生した場合はエラーを返す。
* ファイル保存エラー: pickleファイルの保存でエラーが発生した場合はエラーを返す。

==== 3.2.2. 受付機能
受付機能は、一括申請機能から引き渡された申請データに対して、編集や整形、情報補填を行う機能である。
本機能では、申請データの各項目に対して、リファレンステーブルから必要な情報を取得し、設定値の計算や不足情報の補填を行う。
処理後のデータはpickleファイルとして保存され、パターン編集機能に引き渡される。

===== 3.2.2.1. 入力データ
入力データは、一括申請機能から引き渡された申請データのpickleファイルである。

===== 3.2.2.2. 処理フロー
受付機能の処理フローは以下の通りである。

. 一括申請機能から引き渡されたpickleファイルを読み込む。
. pickleファイルから申請データをDataFrameとして取得する。
. 申請データの各レコードに対して以下の処理を行う。
.. リファレンステーブルから必要な情報を取得する。
.. ディシジョンテーブルにより編集パターンセットを確定する。
.. 取得した情報を元に、設定値の計算や不足情報の補填を行う。
.. 編集済みのレコードをDataFrameに追加する。
. 編集済みのDataFrameをpickleファイルとして保存する。
. 保存したpickleファイルのパスをパターン編集機能に引き渡す。

===== 3.2.2.3. 出力データ
出力データは、編集済みの申請データのpickleファイルである。
pickleファイルには、以下の情報が含まれる。

* 申請ID
* 申請種別 (新設・変更・廃止)
* 部署コード
* 部署名
* 上位部署コード
* 有効日
* その他の部署情報
* リファレンステーブルから取得した情報
* 計算された設定値

===== 3.2.2.4. エラー処理
受付機能では、以下のエラー処理を行う。

* pickleファイルの読み込みエラー: pickleファイルが読み込めない場合はエラーを返す。
* リファレンステーブルからの情報取得エラー: リファレンステーブルから情報が取得できない場合はエラーを返す。
* 設定値の計算エラー: 設定値の計算でエラーが発生した場合はエラーを返す。
* ファイル保存エラー: pickleファイルの保存でエラーが発生した場合はエラーを返す。

==== 3.2.3. パターン編集機能
パターン編集機能は、受付機能から引き渡された申請データを元に、リファレンステーブルに登録するための各種設定値を計算する機能である。
本機能では、申請データの内容に応じて、適切な計算パターンを選択し、設定値の計算を行う。
計算後のデータはpickleファイルとして保存され、反映・送信機能に引き渡される。

===== 3.2.3.1. 入力データ
入力データは、受付機能から引き渡された申請データのpickleファイルである。

===== 3.2.3.2. 処理フロー
パターン編集機能の処理フローは以下の通りである。

. 受付機能から引き渡されたpickleファイルを読み込む。
. pickleファイルから申請データをDataFrameとして取得する。
. 申請データの各レコードに対して以下の処理を行う。
.. ディシジョンテーブルにより編集パターンセットを確定する。
.. 選択した編集パターンに基づいて、設定値の計算を行う。
.. 計算結果をDataFrameに追加する。
. 計算済みのDataFrameをpickleファイルとして保存する。
. 保存したpickleファイルのパスを反映・送信機能に引き渡す。

===== 3.2.3.3. 出力データ
出力データは、計算済みの申請データのpickleファイルである。
pickleファイルには、以下の情報が含まれる。

# TODO 一覧を定義、項目は別紙参照構成にする

* 申請ID
* 申請種別 (新設・変更・廃止)
* 部署コード
* 部署名
* 上位部署コード
* 有効日
* その他の部署情報
* リファレンステーブルから取得した情報
* 受付機能で計算された設定値
* パターン編集機能で計算された設定値

===== 3.2.3.4. エラー処理
パターン編集機能では、以下のエラー処理を行う。

* pickleファイルの読み込みエラー: pickleファイルが読み込めない場合はエラーを返す。
* 計算パターンの選択エラー: 申請内容に適した計算パターンが選択できない場合はエラーを返す。
* 設定値の計算エラー: 設定値の計算でエラーが発生した場合はエラーを返す。
* ファイル保存エラー: pickleファイルの保存でエラーが発生した場合はエラーを返す。

==== 3.2.4. 反映・送信機能
反映・送信機能は、パターン編集機能から引き渡された計算済みデータをリファレンステーブルに反映し、関連システムへのデータ連携を行う機能である。
本機能では、計算済みデータをリファレンステーブルのテーブルに応じたフォーマットに変換し、リファレンステーブルに反映する。
また、関連システム向けのデータをCSV形式/CNTファイルを出力し、SFTP経由で送信する。

===== 3.2.4.1. 入力データ
入力データは、パターン編集機能から引き渡された計算済みデータのpickleファイルである。

===== 3.2.4.2. 処理フロー
反映・送信機能の処理フローは以下の通りである。

. パターン編集機能から引き渡されたpickleファイルを読み込む。
. pickleファイルから更新明細データをDataFrameとして取得する。
. 変換した更新明細データをリファレンステーブルに反映する。
. 一括変換処理を実施する。
. リファレンステーブルから関連システム向けのデータを取得する。
. 取得したデータをCSV形式/CNTファイルで出力する。
. 出力したCSVファイルをSFTP経由で関連システムに送信する。
. 処理結果をログに出力する。

===== 3.2.4.3. 出力データ
反映・送信機能の出力データは以下の通りである。

* リファレンステーブル: 計算済みデータの反映結果
* 関連システム: 部署情報を含むCSVファイル

===== 3.2.4.4. エラー処理
反映・送信機能では、以下のエラー処理を行う。

* pickleファイルの読み込みエラー: pickleファイルが読み込めない場合はエラーを返す。
* データ変換エラー: DataFrameからリファレンステーブルのフォーマットへの変換でエラーが発生した場合はエラーを返す。
* リファレンステーブル反映エラー: リファレンステーブルへのデータ反映でエラーが発生した場合はエラーを返す。
* データ取得エラー: リファレンステーブルからのデータ取得でエラーが発生した場合はエラーを返す。
* ファイル出力エラー: CSVファイルの出力でエラーが発生した場合はエラーを返す。
* SFTP送信エラー: CSVファイルのSFTP送信でエラーが発生した場合はエラーを返す。

==== 3.2.5. 共通機能
本システムでは、各機能で共通的に使用される処理を共通機能として提供する。
共通機能には以下のような処理が含まれる。

* ログ出力処理
* 設定ファイルの読み込み処理
* データベース接続処理
* SFTP接続処理
* メール送信処理

各機能では、これらの共通処理を必要に応じて呼び出して使用する。

==== 3.2.6. データ管理機能
本システムでは、リファレンステーブル等のデータ管理に関する管理機能を提供する。
データ管理機能には以下のようなものがある。


これらの機能は、定期的に実行されるバッチ処理や、システム管理者による手動実行によって使用される。

== 4. データ設計

=== 4.1. データ構造
本システムで使用するデータの構造は以下の通りである。

* 申請データ: 各部署から提供されるExcelファイルに含まれる申請情報
* 統一フォーマットデータ: 申請データを統一フォーマットに変換したデータ
* リファレンステーブルデータ: リファレンステーブルに登録されている部署情報
* 関連システム連携データ: リファレンステーブルから抽出した関連システム向けの部署情報

=== 4.2. ER図
リファレンステーブル他のER図は別紙 xref:er_diagram[リファレンステーブルER図] を参照。

=== 4.3. テーブル定義
リファレンステーブルのテーブル定義は以下の通りである。

#TODO テーブル一覧のみ記載に修正、テーブルレイアウトは別紙構成に改修する
#TODO テーブルに限らずレイアウトを持つものは記載する
#TODO ER図を記載する

[options="header", cols="1,1,1,1"]
|===
| テーブル名 | カラム名 | データ型 | 説明
| 申請一覧 | id | integer | 申請ID
|  | request_type | string | 申請種別 (新設・変更・廃止)
|  | request_date | datetime | 申請日時
|  | department_code | string | 部署コード
|  | department_name | string | 部署名
|  | parent_department_code | string | 上位部署コード
|  | start_date | date | 有効日
|  | ... | ... | ...
| 変更情報 | id | integer | 変更ID
|  | request_id | integer | 申請ID
|  | department_code | string | 部署コード
|  | department_name | string | 部署名
|  | parent_department_code | string | 上位部署コード
|  | start_date | date | 有効日
|  | ... | ... | ...
| テーブル更新情報 | id | integer | 更新ID
|  | change_id | integer | 変更ID
|  | department_code | string | 部署コード
|  | department_name | string | 部署名
|  | parent_department_code | string | 上位部署コード
|  | start_date | date | 有効日
|  | ... | ... | ...
| 部署マスタ | department_code | string | 部署コード
|  | department_name | string | 部署名
|  | parent_department_code | string | 上位部署コード
|  | start_date | date | 有効日
|  | end_date | date | 失効日
|  | ... | ... | ...
|===

=== 4.4. コード定義
本システムで使用するコードの定義は以下の通りである。

* 部店コード: 別紙 xref:store_code_list[部店コード一覧] を参照。
* 課Grコード: 別紙 xref:division_code_list[課Grコード一覧] を参照。
* その他のコード: 別紙 xref:other_code_list[その他のコード一覧] を参照。

== 5. 非機能要件

=== 5.1. セキュリティ要件

* システム利用者はIDとパスワードによる認証を行う。
* システム管理者は専用の管理者IDとパスワードを使用する。
* パスワードは定期的に変更する。
* システムへのアクセスはIPアドレス制限を行う。
* 重要なデータはアクセス制御を行う。
* データの暗号化は行わない。

=== 5.2. パフォーマンス要件

* 大量データの一括処理が可能であること。
* 処理の並列化により、処理時間を短縮できること。
* 処理のピーク時でもレスポンスタイムが悪化しないこと。
* 夜間バッチ処理は翌営業日の業務開始に間に合うこと。

=== 5.3. 信頼性要件

* システムの稼働率は99.9%以上とする。
* 障害発生時の復旧時間は30分以内とする。
* データの整合性を常に保つこと。
* 処理の重複実行や欠落が発生しないこと。

=== 5.4. 拡張性要件

* 将来的な部署数の増加に対応できること。
* 新しい申請様式や計算ロジックの追加が容易であること。
* システム機能の修正や追加が容易であること。
* 関連システムとの連携が容易であること。

== 6. 運用設計

=== 6.1. バックアップ・リカバリ方式

* リファレンステーブルのフルバックアップを毎日深夜に取得する。
* フルバックアップは1週間分保持する。
* 障害発生時は、最新のフルバックアップからリカバリを行う。
* リカバリ手順は別紙 xref:recovery_procedure[リファレンステーブルリカバリ手順書] を参照。

=== 6.2. 運用監視方式

* システムの稼働状況を24時間365日監視する。
* 監視項目は別紙 xref:monitoring_item_list[システム監視項目一覧] を参照。
* 監視はJP1を使用して行う。
* 障害発生時はメールとSlackで通知する。
* 障害対応手順は別紙 xref:trouble_procedure[障害対応手順書] を参照。

== 7. 移行設計

=== 7.1. 移行対象データ

* 移行対象は現行のリファレンステーブルとする。
* 移行対象テーブルは以下の通り。
** 部署マスタ
** 部店コードマスタ
** 課Grコードマスタ
** システム設定マスタ
* 移行データ量は約1.1万件を想定。

=== 7.2. 移行手順

j%4行は日次の夜間バッチ処理として実行する。
* 移行手順は以下の通り。
. 現行NotesDBから移行対象データを抽出する。
. 抽出データをCSV形式で出力する。
. CSVデータを本番テーブルにロードする(pickle化)
. ロード結果を確認する。
. エラーが無ければ移行完了とする。
* 詳細な移行手順は別紙 xref:migration_procedure[移行手順書] を参照。

== 8. リグレ運用設計

=== 8.1. リグレ実行処理定義
リグレ処理の実行スケジュールは以下の通りである。

# TODO 見直し必要

[options="header", cols="1,1,1"]
|===
| 処理名 | 実行タイミング | 実行方法
| 一括申請 | 毎日業務時間帯 | Jenkins
| 受付 | 毎日業務時間帯 | Jenkins
| パターン編集 | 毎日業務時間帯 | Jenkins
| 反映・一括処理・送信 | 毎日業務時間帯 | JP1
| ファイルリテンション管理 | 毎日業務時間帯 | JP1
|===

=== 8.2. Validation/整合性チェック運用定義

* validation/整合性チェックでエラーが発生した場合は、システム管理者に通知する。
* システム管理者は、エラーの原因を調査し、必要な対応を行う。
* エラー対応が完了したら、再度データ整合性チェックを実行する。
* エラーが解消されたことを確認してから、処理を再開する。
* 申請データ内容に基づき意図的に処理停止を行うケースがある。検出次第、承認部署及び申請部署に確認を取る。

=== 8.3. 本番実行データのリグレ環境反映

* VCON操作により本番リファレンスデータ群をリグレ環境へ搬送する。
* 本番から取得したデータはリポジトリ管理／Tag付与して管理する。
* バージョン管理下のデータを使用し、リグレでのシミュレーション及びリファレンス更新明細を生成する。

=== 8.4. リグレ実行データの本番反映定義

* リグレ処理で作成されたリファレンス更新明細データを本番環境に反映する。
* リグれ処理で作成したリファレンス更新明細データはリポジトリによるバージョン管理を行う。
* 本番反映は、リグレ処理が完了した後にリリース登録により対応する。
* 本番反映処理が失敗した場合は、システム管理者に通知する。
* システム管理者は、失敗の原因を調査し、必要な対応を行う。

== 9. 定義一覧

=== 9.1. Validation定義一覧
Validation定義の一覧は別紙 xref:validation_list[Validation定義一覧] を参照。

=== 9.2. 整合性チェック定義一覧
整合性チェック定義の一覧は別紙 xref:consistency_check_list[整合性チェック定義一覧] を参照。

=== 9.3. 編集処理定義一覧
編集処理定義の一覧は別紙 xref:edit_process_list[編集処理定義一覧] を参照。

=== 9.4. 受付処理分岐制御／Facade一覧
受付処理分岐制御およびFacadeの一覧は別紙 xref:reception_facade_list[受付処理分岐制御／Facade一覧] を参照。

=== 9.5. パターン処理分岐制御／パターン一覧
パターン処理分岐制御およびパターンの一覧は別紙 xref:pattern_list[パターン処理分岐制御／パターン一覧] を参照。

=== 9.6. 一括変換処理／一括変換処理一覧
一括変換処理分岐制御および一括変換処理一覧は別紙 xref:pattern_list[一括変換処理分岐制御／一括変換一覧] を参照。


== 10. 付録
=== 10.1. 現行仕様からの機能変更点一覧
現行仕様からの機能変更点の一覧は別紙 xref:func_change_list[現行仕様からの機能変更点一覧] を参照。