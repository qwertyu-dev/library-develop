= 受付処理 機能設計書

== 1. 要件定義
=== 1.1. 要求分析
サブセクションの要件概略::
本サブセクションでは、会社の部署情報（部署コード、部署名など）が入っているデータを保持し、それに対する変更申請を管理するシステムの受付部分の要件について記載する。受付では、一括申請で処理済みのデータを受け取り、Factoryによる条件制御とFacadeによるデータ編集を行う。また、編集部品を定義し、データの前処理を実施する。

=== 1.2. 移植での改善方針
深すぎるifネストや個別要件定義にある保守性低下問題を改善するために、以下の方針で移植を行う。

* Factoryパターンにより条件制御をまとめる
* Facadeパターンにより条件に応じたデータ編集を行う
* 編集部品を定義し、単一責務化を図る
* Validation/整合性チェックを前フェーズの一括申請に委譲する
* 一括申請で行われているデータ編集処理の一部を引き受ける
* 後続処理のパターン処理に対して、データ編集役割を適切に分配する

== 2. 機能定義
=== 2.1. 機能概要
本サブセクションでは、一括申請で処理済のpickleファイルを使用し、Factoryによる条件制御を行う。Facadeによるデータ編集定義に基づきデータ編集（前処理）を実行し、編集部品を定義する。各種データレイアウト、Factoryで担当するデータ制御パターン、Facadeで担当するデータ編集定義パターン、およびデータ編集一覧は別紙に記載する。

=== 2.2. 処理フロー
==== 2.2.1. 処理フロー図
[plantuml]
----
@startuml
start
:一括申請で処理された統一フォーマットのデータをロード;
:Factoryにより条件に応じて適切なFacadeを選択;
if (例外ケース?) then (yes)
  :例外処理用のFacadeを呼び出し;
else (no)
  :通常処理用のFacadeを呼び出し;
endif
:Facadeで定義されている編集部品を呼び出し;
if (単独編集?) then (yes)
  :単独編集処理を実行;
else (no)
  :テーブルデータを取得;
  :取得したデータに基づいて値を設定;
endif
:編集後のデータを返却;
:処理後のデータを永続化（pickle）;
stop
@enduml
----

==== 2.2.2. 処理フローの説明
. 一括申請で処理された統一フォーマットのデータをロードする。
. Factoryにより、条件に応じて適切なFacadeを選択する。
. 例外ケースの場合は、例外処理用のFacadeを呼び出す。
. 通常のケースの場合は、通常処理用のFacadeを呼び出す。
. Facadeで定義されている編集部品を呼び出す。
. 単独編集の場合は、単独編集処理を実行する。
. テーブルデータに基づく編集の場合は、テーブルデータを取得し、取得したデータに基づいて値を設定する。
. 編集後のデータを返却する。
. 処理後のデータを永続化（pickle）する。

=== 2.3. 画面遷移
本サブセクションでは画面遷移は存在しない。

=== 2.4. 機能詳細
==== 2.4.1. 入力データ受領
本サブセクションでは直接入力データを受領しない。一括申請で処理済のpickleファイルを使用する。

==== 2.4.2. データバリデーション
本サブセクションでは直接データバリデーションは行わない。一括申請で処理済のpickleファイルを使用する。

==== 2.4.3. データ変換
本サブセクションでは直接データ変換は行わない。一括申請で処理済のpickleファイルを使用する。

==== 2.4.4. 例外処理
本サブセクションでは直接例外処理は行わない。一括申請で処理済のpickleファイルを使用する。

==== 2.4.5. データ永続化
===== 2.4.5.1. 変換後データの永続化方式
処理後のデータはpickleファイルとして永続化する。

===== 2.4.5.2. 永続化データのフォーマット
永続化データのフォーマットは、一括申請で処理済のpickleファイルと同様のフォーマットとする。

=== 2.5. インターフェース
==== 2.5.1. 外部インターフェース
本サブセクションでは直接外部インターフェースは存在しない。一括申請で処理済のpickleファイルを使用する。

==== 2.5.2. 内部インターフェース
===== 2.5.2.1. データ永続化インターフェース
処理後のデータをpickleファイルとして永続化するためのインターフェースを提供する。

===== 2.5.2.2. 後続処理への引継ぎインターフェース
処理後のデータを後続処理（パターン処理）に引き継ぐためのインターフェースを提供する。

== 3. システムデザイン
=== 3.1. コンポーネント構成
[cols="1,3"]
|===
|コンポーネント名 |説明

|UnifiedDataLoader
|一括申請で処理済のデータをロードする

|IfConditionFactory
|条件に応じて適切なFacadeを選択する

|EditingFacade
|データ編集定義に基づきデータ編集を実行する

|EditingComponent
|編集処理を担当する部品

|TableDataRetriever
|テーブルデータを取得する
|===

コンポーネント図::
[plantuml]
----
@startuml
package "受付" {
  [UnifiedDataLoader] -- [IfConditionFactory]
  [IfConditionFactory] -- [EditingFacade] 
  [EditingFacade] -- [EditingComponent]
  
  [TableDataRetriever]
  
  [UnifiedDataLoader] -right-> [TableDataRetriever]
  [EditingComponent] -right-> [TableDataRetriever]
}
@enduml
----

=== 3.2. シーケンス図
[plantuml]
----
@startuml
participant UnifiedDataLoader
participant IfConditionFactory
participant EditingFacade
participant EditingComponent
participant TableDataRetriever

UnifiedDataLoader -> IfConditionFactory: 統一フォーマットのデータをロード
IfConditionFactory -> EditingFacade: 条件に応じてFacadeを決定
EditingFacade -> EditingComponent: 編集部品を呼び出し
EditingComponent -> TableDataRetriever: 必要に応じてテーブルデータを取得
EditingComponent --> EditingFacade: 編集後のデータを返却
EditingFacade --> IfConditionFactory: 編集後のデータを返却
IfConditionFactory --> UnifiedDataLoader: 処理後のデータを返却
UnifiedDataLoader -> UnifiedDataLoader: 処理後のデータを永続化（pickle）
@enduml
----

=== 3.3. アクティビティ図
[plantuml]
----
@startuml
start
:一括申請で処理された統一フォーマットのデータをロード;
:Factoryにより条件に応じて適切なFacadeを選択;
if (例外ケース?) then (yes)
  :例外処理用のFacadeを呼び出し;
else (no)
  :通常処理用のFacadeを呼び出し;
endif
:Facadeで定義されている編集部品を呼び出し;
if (単独編集?) then (yes)
  :単独編集処理を実行;
else (no)
  :テーブルデータを取得;
  :取得したデータに基づいて値を設定;
endif
:編集後のデータを返却;
:処理後のデータを永続化（pickle）;
stop
@enduml
----

== 4. 入出力データ
=== 4.1. 入力データ
==== 4.1.1. pickleファイル(一括申請処理後の永続化データ)
一括申請で処理済のpickleファイルを入力として使用する。

==== 4.1.2. リファレンステーブル
編集処理で参照するリファレンステーブルの一覧は別紙に記載する。

==== 4.1.3. BPR部門コード一覧テーブル
編集処理で参照するBPR部門コード一覧テーブルの詳細は別紙に記載する。

=== 4.2. 出力データ
==== 4.2.1. pickleファイル（処理後の永続化データ）
処理後のデータをpickleファイルとして出力する。

== 5. 例外設計
=== 5.1. 例外一覧
例外一覧の詳細は別紙に記載する。

[cols="1,1,1,1"]
|===
|管理番号 |発生事象定義 |原因定義 |対処指針

|(別紙参照)
|(別紙参照) 
|(別紙参照)
|(別紙参照)
|===

=== 5.2. 例外処理方針
編集部品で発生した例外はthrowし、Facadeで例外処理を行う。これにより、例外発生時の影響範囲を限定し、適切な箇所でエラーハンドリングを行うことができる。

== 6. ロギング設計
=== 6.1. 受付処理でのエラー位置特定情報
ロギング設計の詳細は別紙に記載する。

[cols="1,3"]
|===
|ログ項目 |説明

|申請部署
|エラーが発生した申請部署

|行・列位置
|エラーが発生した行・列の位置

|値
|エラーとなった値

|正しい型想定・値
|期待される型や値
|===

エラー発生時には、上記の情報をログに出力することで、エラー位置の特定を容易にする。これにより、問題の原因特定と修正を迅速に行うことができる。

== 7. セキュリティ要件
本サブセクションでは、特別なセキュリティ要件は存在しない。ただし、入力データの取扱いには注意が必要である。一括申請で処理済のデータを使用するため、データの機密性と完全性は一括申請の段階で確保されていることが前提となる。

== 8. 運用記述
=== 8.1. リグレ環境での実施
受付処理はリグレッション環境で実施する。これにより、本番環境への影響を与えることなく、処理の正確性を確認することができる。

=== 8.2. データの取扱
==== 8.2.1. 処理結果の管理
処理結果となるpickleファイルはリポジトリで管理する。リポジトリでのバージョン管理により、データの履歴を追跡することができる。

=== 8.3. 実行スケジュール
==== 8.3.1. 自動スケジュール設定
受付処理の実行はJenkinsで自動スケジュール設定を行う。これにより、定期的かつ自動的に処理を実行することができる。

==== 8.3.2. 日次実行
受付処理は日次で実行する。日次実行により、日々の変更申請を確実に処理することができる。

==== 8.3.3. マニュアル実行
必要に応じて、マニュアル対応でJenkinsでの受付処理実行を行うことを想定する。これにより、緊急の変更申請にも柔軟に対応することができる。

== 9. 別紙
以下の資料は別紙として管理する。

* 各種データレイアウト
* Factoryで担当するデータ制御パターン
* Facadeで担当するデータ編集定義パターン
* データ編集一覧
* リファレンステーブル一覧 
* BPR部門コード一覧テーブル詳細
* 例外一覧詳細
* ロギング設計詳細
----