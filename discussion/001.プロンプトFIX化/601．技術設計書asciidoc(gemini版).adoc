= 技術設計書

== 1. はじめに 
=== 1.1. 目的 
本技術設計書は、銀行の部署情報を管理するシステムの技術設計を記述したものです。本システムは、人事部、国際事務企画部、関連会社からの部署情報変更申請を受け付け、行内BPRシステムや行内共通認証システムと連携して、部署情報の更新・管理を行います。本技術設計書は、システム開発者向けに、システムの構成、機能、動作、運用保守方法などを詳細に説明することを目的としています。

=== 1.2. 範囲 
本技術設計書は、銀行の部署情報を管理するシステムの技術設計について記述します。

=== 1.3. 用語定義

|===
| 用語 | 定義 
| 行内BPRシステム | 銀行の行員に対して、WindowsデスクトップをはじめとしたOA環境を提供するシステム
| 行内共通認証システム | 銀行の行員が各種業務システムをシングルサインオンで利用するための認証システム
| リファレンスDB | 銀行の部署情報を管理するデータベース
| 一括申請 | 人事部、国際事務企画部、関連会社から提出された部署情報の変更申請
| 受付処理 | 一括申請処理で作成された統一フォーマットのデータを受け取り、リファレンスDBから必要な情報と組み合わせて、変更情報テーブルを作成する処理
| パターン編集処理 | 受付処理で作成された変更情報テーブルから、リファレンスDBに登録する設定値を計算する処理
| 反映処理 | パターン編集処理で作成されたDB更新情報テーブルの内容を元に、リファレンスDBを更新する処理
| 送信処理 | リファレンスDBの更新内容を後続システムに送信する処理
| ULID | 普遍的に一意な識別子
| E-HUB | エラー検出・処理システム
|===

== 2. システム概要
=== 2.1. 処理概要
==== 2.1.1. 一括申請処理
===== 2.1.1.1 一括申請処理概要
一括申請処理は、人事部、国際事務企画部、関連会社から提出された部署情報の変更申請を、統一フォーマットに変換し、バリデーションと整合性チェックを行う処理です。

処理の流れは以下のとおりです。

. 申請元の部署から、部署情報の変更申請がExcelファイルで提出されます。
. 一括申請処理プログラムは、提出されたExcelファイルを読み込み、データのバリデーションと整合性チェックを行います。
. バリデーションと整合性チェックに問題なければ、Excelファイルを統一フォーマットに変換します。
. 変換されたデータは、一括申請テーブルとしてpickleファイルに永続化されます。

===== 2.1.1.2 一括申請処理定義
|===
| 処理名 | 処理内容 
| ファイル読み込み処理 | 提出されたExcelファイルを読み込み、データフレームに変換する。 
| バリデーション処理 | ファイル内のデータが正しい形式で入力されているか、データの範囲が正しいか、データ間の整合性などが正しいかを確認する。 
| 整合性チェック処理 | データフレーム内のデータと既存のデータとの整合性をチェックする。 
| フォーマット変換処理 | データフレームを統一フォーマットに変換する。 
| データ永続化処理 | データフレームをpickleファイルとして永続化する。 
|===

===== 2.1.1.3 一括申請処理定義一覧
|===
| 処理名 | 処理内容 | 実装方法 | 備考
| ファイル読み込み処理 | 提出されたExcelファイルを読み込み、データフレームに変換する。 | pandasライブラリを使用する。 |  
| バリデーション処理 | ファイル内のデータが正しい形式で入力されているか、データの範囲が正しいか、データ間の整合性などが正しいかを確認する。 | pydanticライブラリを使用する。 |  
| 整合性チェック処理 | データフレーム内のデータと既存のデータとの整合性をチェックする。 | pickleファイルから既存のデータを読み込み、比較を行う。 |  
| フォーマット変換処理 | データフレームを統一フォーマットに変換する。 | pandasライブラリを使用する。 |  
| データ永続化処理 | データフレームをpickleファイルとして永続化する。 | pickleライブラリを使用する。 |  
|===

===== 2.1.1.4 一括申請処理関連資料
- 一括申請処理仕様書（別紙）
- 一括申請処理プログラムソースコード（別紙）
- 一括申請処理テストケース（別紙）

==== 2.1.2. 受付処理
===== 2.1.2.1 受付処理概要
受付処理は、一括申請処理で作成された統一フォーマットのデータを受け取り、リファレンスDBから必要な情報と組み合わせて、変更情報テーブルを作成する処理です。
処理の流れは以下のとおりです。
1. 受付処理プログラムは、一括申請テーブルのpickleファイルを読み込みます。
2. 読み込んだデータに対して、リファレンスDBから必要な情報と組み合わせ、変更情報テーブルを作成します。
3. 変更情報テーブルは、pickleファイルとして永続化されます。

===== 2.1.2.2 受付処理定義
|===
| 処理名 | 処理内容 
| データ読み込み処理 | 一括申請テーブルのpickleファイルを読み込み、データフレームに変換する。 
| 情報補填処理 | リファレンスDBから必要となる情報を取得し、データフレームに補填する。 
| 変更情報テーブル作成処理 | 補填されたデータをもとに、変更情報テーブルを作成する。 
| データ永続化処理 | 作成された変更情報テーブルをpickleファイルとして永続化する。 
|===

===== 2.1.2.3 受付処理定義一覧
|===
| 処理名 | 処理内容 | 実装方法 | 備考 
| データ読み込み処理 | 一括申請テーブルのpickleファイルを読み込み、データフレームに変換する。 | pickleライブラリを使用する。 |  
| 情報補填処理 | リファレンスDBから必要となる情報を取得し、データフレームに補填する。 | pickleファイルからリファレンスDBのデータを読み込み、データフレームと結合する。 |  
| 変更情報テーブル作成処理 | 補填されたデータをもとに、変更情報テーブルを作成する。 | pandasライブラリを使用する。 |  
| データ永続化処理 | 作成された変更情報テーブルをpickleファイルとして永続化する。 | pickleライブラリを使用する。 |  
|===

===== 2.1.2.4 受付処理関連資料
- 受付処理仕様書（別紙）
- 受付処理プログラムソースコード（別紙）
- 受付処理テストケース（別紙）
==== 2.1.3. パターン編集処理
===== 2.1.3.1 パターン編集処理概要
パターン編集処理は、受付処理で作成された変更情報テーブルから、リファレンスDBに登録する設定値を計算する処理です。
処理の流れは以下のとおりです。
1. パターン編集処理プログラムは、変更情報テーブルのpickleファイルを読み込みます。
2. 読み込んだデータに対して、Facadeパターンを用いて条件判定を行い、適切なパターンを適用します。
3. 適用されたパターンに基づいて、設定値を計算します。
4. 計算された設定値は、DB更新情報テーブルとしてpickleファイルに永続化されます。

===== 2.1.3.2 パターン編集処理定義
|===
| 処理名 | 処理内容 
| データ読み込み処理 | 変更情報テーブルのpickleファイルを読み込み、データフレームに変換する。 
| パターン適用処理 | データフレームの各行に対して、Facadeパターンを用いて条件判定を行い、適切なパターンを適用する。 
| 設定値計算処理 | 適用されたパターンに基づいて、リファレンスDBに登録する設定値を計算する。 
| データ永続化処理 | 計算された設定値をDB更新情報テーブルとしてpickleファイルに永続化する。 
|===

===== 2.1.3.3 パターン編集処理定義一覧
|===
| 処理名 | 処理内容 | 実装方法 | 備考 
| データ読み込み処理 | 変更情報テーブルのpickleファイルを読み込み、データフレームに変換する。 | pickleライブラリを使用する。 |  
| パターン適用処理 | データフレームの各行に対して、Facadeパターンを用いて条件判定を行い、適切なパターンを適用する。 | ディシジョンテーブルを用いて条件判定を行う。 |  
| 設定値計算処理 | 適用されたパターンに基づいて、リファレンスDBに登録する設定値を計算する。 | Pythonの計算式を使用する。 |  
| データ永続化処理 | 計算された設定値をDB更新情報テーブルとしてpickleファイルに永続化する。 | pickleライブラリを使用する。 |  
|===

===== 2.1.3.4 パターン編集処理関連資料
- パターン編集処理仕様書（別紙）
- パターン編集処理プログラムソースコード（別紙）
- パターン編集処理テストケース（別紙）
- パターン定義一覧（別紙）

==== 2.1.4. 反映処理
===== 2.1.4.1 反映処理概要
反映処理は、パターン編集処理で作成されたDB更新情報テーブルの内容を元に、リファレンスDBを更新する処理です。
処理の流れは以下のとおりです。
1. 反映処理プログラムは、DB更新情報テーブルのpickleファイルを読み込みます。
2. 読み込んだデータをもとに、リファレンスDBを更新します。

===== 2.1.4.2 反映処理定義
|===
| データ読み込み処理 | DB更新情報テーブルのpickleファイルを読み込み、データフレームに変換する。 
| リファレンスDB更新処理 | データフレームの内容に基づいて、リファレンスDBを更新する。 
|===

===== 2.1.4.3 反映処理定義一覧
|===
| 処理名 | 処理内容 | 実装方法 | 備考 
| データ読み込み処理 | DB更新情報テーブルのpickleファイルを読み込み、データフレームに変換する。 | pickleライブラリを使用する。 |  
| リファレンスDB更新処理 | データフレームの内容に基づいて、リファレンスDBを更新する。 | pickleファイルからリファレンスDBのデータを読み込み、データフレームの内容で更新を行う。 |  
|===

===== 2.1.4.4 反映処理関連資料
- 反映処理仕様書（別紙）
- 反映処理プログラムソースコード（別紙）
- 反映処理テストケース（別紙）

==== 2.1.5. 送信処理
===== 2.1.5.1 送信処理概要
送信処理は、リファレンスDBの更新内容を後続システムに送信する処理です。
処理の流れは以下のとおりです。
1. 送信処理プログラムは、リファレンスDBのデータを読み込み、CSVファイルに変換します。
2. 変換されたCSVファイルを、SSH接続を用いて後続システムに送信します。

===== 2.1.5.2 送信処理定義
|===
| 処理名 | 処理内容 
|---|--- CSVファイル生成処理 | リファレンスDBのデータを読み込み、CSVファイルに変換する。 
| ファイル送信処理 | 生成されたCSVファイルを、SSH接続を用いて後続システムに送信する。 
|===

===== 2.1.5.3 送信処理定義一覧
|===
| 処理名 | 処理内容 | 実装方法 | 備考 
| CSVファイル生成処理 | リファレンスDBのデータを読み込み、CSVファイルに変換する。 | pandasライブラリを使用する。 |  
| ファイル送信処理 | 生成されたCSVファイルを、SSH接続を用いて後続システムに送信する。 | paramikoライブラリを使用する。 |  
|===

===== 2.1.5.4 送信処理関連資料
- 送信処理仕様書（別紙）
- 送信処理プログラムソースコード（別紙）
- 送信処理テストケース（別紙）

== 3. システム構成
=== 3.1. システム構成図
- システム構成図は別紙

=== 3.2. ソフトウェア構成
|===
| ソフトウェア名 | バージョン | 説明 
| Python | 3.9 | アプリケーション開発言語 
| pandas | 1.4.2 | データ分析ライブラリ 
| pydantic | 1.9.0 | データバリデーションライブラリ 
| pickle | 標準ライブラリ | データ永続化ライブラリ 
| paramiko | 2.10.0 | SSH接続ライブラリ 
| Jenkins | 2.365 | CI/CDツール 
|===

=== 3.3. ハードウェア構成
|===
| ハードウェア名 | 仕様 | 説明 
| サーバ |  |  
| ストレージ |  |  
|===

=== 3.4. ネットワーク構成
- ネットワーク構成図は別紙

== 4. テーブル設計
=== 4.1. テーブル一覧
- テーブル一覧は別紙

=== 4.2. テーブル構成／ER図
- ER図は別紙

=== 4.3. データ整合性
- データ整合性に関する詳細な仕様は別紙

== 5. アプリケーション設計
=== 5.1. アプリケーション構成
- pythonパッケージは利用しない
- pypi公開ライブラリは使用する
  - requestsファイルへ導入ライブラリ一覧記述
=== 5.2. バッチ処理設計
==== 5.2.1. バッチ処理フロー
===== 5.2.1.1 一括申請を起因とするバッチ処理フロー
一括申請を起因とするバッチ処理フローは、人事部、国際事務企画部、関連会社からの部署情報変更申請を受け付け、リファレンスDBを更新するまでの処理を指します。以下の図は、一括申請を起因とするバッチ処理フローを示しています。

[plantuml] 
---- 
@startuml
start
:一括申請処理プログラム起動;
:Excelファイルを読み込み;
:データのバリデーションと整合性チェック;
if (バリデーションエラー) then
  :エラーメッセージ出力;
  end
else
  :Excelファイルを統一フォーマットに変換;
  :一括申請テーブルをpickleファイルに永続化;
endif
:受付処理プログラム起動;
:一括申請テーブルのpickleファイルを読み込み;
:リファレンスDBから必要な情報を取得;
:変更情報テーブルを作成;
:変更情報テーブルをpickleファイルに永続化;
:パターン編集処理プログラム起動;
:変更情報テーブルのpickleファイルを読み込み;
:Facadeパターンを用いて条件判定;
:適切なパターンを適用;
:設定値を計算;
:DB更新情報テーブルをpickleファイルに永続化;
:反映処理プログラム起動;
:DB更新情報テーブルのpickleファイルを読み込み;
:リファレンスDBを更新;
:送信処理プログラム起動;
:リファレンスDBのデータをCSVファイルに変換;
:CSVファイルをSSH接続を用いて後続システムに送信;
stop
@enduml
---- 

===== 5.2.1.2 組織変更要件を起因とするバッチ処理フロー
組織変更要件を起因とするバッチ処理フローは、人事部、国際事務企画部、関連会社から提出された組織変更の申請を受け、リファレンスDBを更新するまでの処理を指します。以下の図は、組織変更要件を起因とするバッチ処理フローを示しています。

[plantuml] 
---- 
@startuml
start
:組織変更申請プログラム起動;
:組織変更申請データを受け取り;
:組織変更申請データのバリデーションと整合性チェック;
if (バリデーションエラー) then
  :エラーメッセージ出力;
  end
else
  :組織変更申請データを処理;
  :リファレンスDBを更新;
endif
stop
@enduml
---- 

==== 5.2.2. バッチ処理スケジュール
|===
| バッチ処理名 | 処理時間 | 頻度 
| 一括申請処理 |  | 日次（日中時間帯に実行） 
| 受付処理 |  | 日次（日中時間帯に実行） 
| パターン処理 |  | 日次（日中時間帯に実行） 
| 反映処理 |  | 日次（翌営業日、日中時間帯に実施） 
| 一括処理 |  | 日次（翌営業日、日中時間帯に実施） 
| 送信処理 |  | 日次（翌営業日、日中時間帯に実施） 
|===

=== 5.3. エラー処理設計
- Facadeで部品エラーをハンドリングする
- 部品はエラーをraiseして呼び出し元に対処を委ねる
- 各フェーズで編集処理があることから、トレース容易化のため一括申請時にULIDを項目追加する
- エラー検出で対応必須の事項はE-HUBにて検出する

== 6. 内部設計
各機能設計書で定義するため、技術設計書では省略する

== 7. 外部インターフェース設計
機能設計書で定義するため、技術設計書では省略する

== 8. 性能設計
=== 8.1. 性能目標
- バッチ性能
- 一括処理申請明細Max件数で評価する／過去の実績より条件設定
- １時間程度での処理完了を目処
=== 8.2. 負荷試験
- 組織変更対応時の変更要件データ量で評価する

== 9. セキュリティ設計
=== 9.1. アクセス制御
=== 9.2. データ暗号化
=== 9.3. 監査ログ
=== 9.4. データ保守ガバナンス
=== 9.5. ダイレクト修正パッチ実行時のログ長期保管

== 10. 運用設計
=== 10.1. 運用スケジュール
=== 10.2. リグレでの稼働範囲／本番での稼働範囲
=== 10.3. 一括申請受付〜反映スケジュール
- 先行提供
- 本反映

=== 10.4. エラー検出
=== 10.5. バックアップ・リカバリ
=== 10.6. ダイレクト修正方針
- マニュアル作業でなくパッチコードを書く

=== 10.7. 異例操作ログ長期保管

== 11. テスト設計
=== 11.1. 単体テスト
- pytestを使用しテストコードを書く
- 開発フェーズを通じて終始Jenkinsによるデグレ検出を行う

=== 11.2. 結合テスト
=== 11.3. システムテスト

== 12. 移行設計
=== 12.1 外部テーブル化対応
- 現行ではコード内に保有されているテーブルを外部テーブル保有し永続化する
- 対象一覧

=== 12.2 現行テーブルデータ洗い上げ処理
- これまでの保守曖昧さによる問題を解決するため現行テーブルデータの洗い上げを行う
- 対象一覧

=== 12.3 現新平行稼働／処理結果比較
- 実現方法概略記述
- データ取得／管理方法
- データ比較運営方法

== 13. 運用保守
=== 13.1. 保守計画
- 通常の組織定義メンテナンス
- 組織変更要件／半期での対応

=== 13.2. 手順一覧
- 通常の組織定義メンテナンス
- 組織変更要件／半期での対応

== 14. リリース計画
=== 14.1. リリーススケジュール／新システムへの移行日
=== 14.2. リリースタイムチャート
=== 14.4. リリース手順

== 15. 障害対策
=== 15.1. 障害発生時の対応手順
=== 15.2. 障害発生時の連絡体制
=== 15.3. 障害復旧手順

== 16. 添付資料
=== 16.1 添付資料一覧
=== 16.2. 開発規約一覧

