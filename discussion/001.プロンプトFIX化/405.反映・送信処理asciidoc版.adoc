= 反映・送信サブセクション

== 1. 要件定義

=== 1.1. 要求分析

==== 1.1.1. 反映・送信サブセクションの要件概略
反映・送信サブセクションは、パターン編集処理後のDB更新情報明細を元にリファレンスDBへの反映を行い、関連システムへのデータ送信を行う機能を提供する。主な要件は以下の通り。

- DB更新情報明細の受領とリファレンスDBの更新
- ダミー課Grテーブルの作成
- 休職・本部詰の部署情報の作成・削除の一括処理
- リファレンスDBとダミー課Grテーブルからの情報取得
- CSVファイルの作成とバリデーションチェック
- 関連システムへの送信と部店新規・廃止時のメール送信
- テーブル更新前の物理コピー作成

本サブセクションは、反映処理、一括処理、送信処理の3つの主要な処理で構成される。反映処理ではDB更新情報明細に基づきリファレンスDBとダミー課Grテーブルを更新する。一括処理では休職・本部詰の部署情報の作成・削除を行う。送信処理ではリファレンスDBとダミー課Grテーブルから情報を取得し、CSVファイルを作成して関連システムに送信する。また、部店新規・廃止時にはメール送信を行う。

=== 1.2. 移植での改善方針

==== 1.2.1. 単一責務化
反映処理、一括処理、送信処理をそれぞれ独立したコンポーネントとして設計し、単一責務の原則に従って機能を分割する。これにより、保守性と拡張性を向上させる。

==== 1.2.2. データ反映制御
DB更新情報明細の反映日をキーとして、運用パラメータ制御により反映指定日前にデータ仮反映を行う。銀行カレンダーを取得し、営業日での制御を行う。

==== 1.2.3. 一括処理
リファレンスDBに対し、休職・本部詰の部署情報を作成・削除する一括処理を行う。「休職・本部詰の親部店」に該当する部署の配下に休職・本部詰部署がなければ作成し、該当しない部署の配下に休職・本部詰部署があれば削除する。

==== 1.2.4. データ送信
後続システムに連携するためのCSVファイルと制御ファイルを作成し、更新日にSFTP送信する。仮反映データおよび本反映データを送信する。

== 2. 機能定義

=== 2.1. 機能要件

==== 2.1.1. 反映処理

===== 2.1.1.1. DB更新情報明細の受領
パターン編集処理後のDB更新情報明細を受領する。明細が持つ反映日をキーとして処理を行う。

===== 2.1.1.2. リファレンスDBの更新
DB更新情報明細に基づき、リファレンスDBを更新する。更新の種類はCreate、Update、Deleteの3種類がある。

===== 2.1.1.3. ダミー課Grテーブルの作成
DB更新情報明細からダミー課Gr情報を取得し、ダミー課Grテーブルを作成する。

==== 2.1.2. 一括処理

===== 2.1.2.1. 休職・本部詰の部署情報の作成・削除
リファレンスDBに対し、休職・本部詰の部署情報を作成・削除する。「休職・本部詰の親部店」に該当する部署の配下に休職・本部詰部署がなければ作成し、該当しない部署の配下に休職・本部詰部署があれば削除する。

==== 2.1.3. 送信処理

===== 2.1.3.1. リファレンスDBからの情報取得
リファレンスDBから、後続システムに連携するための情報を取得する。

===== 2.1.3.2. ダミー課Grテーブルからの情報取得
ダミー課Grテーブルから、後続システムに連携するための情報を取得する。

===== 2.1.3.3. CSVファイルの作成
取得した情報を元に、後続システムに連携するためのCSVファイルを作成する。

===== 2.1.3.4. バリデーションチェック
作成したCSVファイルに対し、バリデーションチェックを行う。

===== 2.1.3.5. 関連システムへの送信
作成したCSVファイルと制御ファイルを、更新日にSFTP送信する。仮反映データおよび本反映データを送信する。

===== 2.1.3.6. 部店新規・廃止時のメール送信
部店新規・廃止の場合、リファレンスDBの更新連絡とともに、部店情報.txtを作成しメール添付する。

===== 2.1.3.7. テーブル更新前の物理コピー作成
リファレンスDBのテーブル更新前に、テーブルファイルの物理コピーを作成し履歴として保存する。

== 3. システムデザイン

=== 3.1. システム構成

==== 3.1.1. コンポーネント構成
反映・送信サブセクションは、反映処理、一括処理、送信処理の3つの主要なコンポーネントで構成される。これらのコンポーネントはそれぞれリファレンスDBやダミー課Gr情報などのデータソースとやり取りを行う。

[plantuml, component-diagram, png]
----
@startuml
skinparam componentStyle uml2

package "反映・送信" {
  [反映処理] as Deployment
  [一括処理] as Batch
  [送信処理] as Send
  
  database "リファレンスDB" as RefDB
  database "ダミー課Gr情報" as DummyGr
  database "物理コピー" as Physical

  Deployment -> RefDB
  Deployment -> DummyGr
  Batch -> RefDB
  Send -> RefDB
  Send -> DummyGr
  Send -> Physical
}
@enduml
----

==== 3.1.2. インターフェース情報
反映・送信サブセクションは、上流のパターン編集処理からDB更新情報明細を受領し、下流の関連システムにCSVファイルを送信する。また、リファレンスDBとダミー課Gr情報に対してCRUD操作を行う。

=== 3.2. 処理フロー

==== 3.2.1. 反映処理フロー
1. DB更新情報明細を受領する。
2. リファレンスDBを更新する。
3. ダミー課Grテーブルを作成する。

==== 3.2.2. 一括処理フロー
1. 休職・本部詰の部署情報を作成・削除する。

==== 3.2.3. 送信処理フロー
1. リファレンスDBから情報を取得する。
2. ダミー課Grテーブルから情報を取得する。
3. CSVファイルを作成する。
4. バリデーションチェックを行う。
5. 関連システムへ送信する。
6. 部店新規・廃止時にメール送信する。
7. テーブル更新前に物理コピーを作成する。

=== 3.3. UML

==== 3.3.1. コンポーネント図
[plantuml, component-diagram-2, png]
----
@startuml
skinparam componentStyle uml2

package "反映・送信" {
  [反映処理] as Deployment
  [一括処理] as Batch
  [送信処理] as Send
  
  database "リファレンスDB" as RefDB
  database "ダミー課Gr情報" as DummyGr
  database "物理コピー" as Physical

  Deployment -> RefDB
  Deployment -> DummyGr
  Batch -> RefDB
  Send -> RefDB
  Send -> DummyGr
  Send -> Physical
}
@enduml
----

==== 3.3.2. シーケンス図
[plantuml, sequence-diagram, png]
----
@startuml
actor User

box "反映・送信"
  participant "反映処理" as Deployment
  participant "一括処理" as Batch
  participant "送信処理" as Send
  participant "リファレンスDB" as RefDB
  participant "ダミー課Gr情報" as DummyGr
end box

User -> Deployment: DB更新情報明細を受領
activate Deployment
Deployment -> RefDB: リファレンスDBを更新
Deployment -> DummyGr: ダミー課Grテーブルを作成
Deployment --> User: 反映完了通知
deactivate Deployment

User -> Batch: 一括処理依頼
activate Batch
Batch -> RefDB: 休職・本部詰の部署情報を作成・削除
Batch --> User: 一括処理完了通知  
deactivate Batch

User -> Send: 送信依頼
activate Send
Send -> RefDB: リファレンスDBから情報取得
Send -> DummyGr: ダミー課Grテーブルから情報取得 
Send -> Send: CSVファイル作成
Send -> Send: バリデーションチェック
Send -> User: 各関連システムへ送信
Send -> Send: 部店新規・廃止時にメール送信
Send -> RefDB: テーブル更新前に物理コピーを作成
Send --> User: 送信完了通知
deactivate Send
@enduml
----

==== 3.3.3. アクティビティ図
[plantuml, activity-diagram, png]
----
@startuml
start
:DB更新情報明細を受領;

fork
  :反映処理;
  :リファレンスDBを更新;
  :ダミー課Grテーブルを作成;
fork again
  :一括処理;
  :休職・本部詰の部署情報を作成・削除;
fork again
  :送信処理;
  :リファレンスDBから情報取得;
  :ダミー課Grテーブルから情報取得;
  :CSVファイル作成;
  :バリデーションチェック;
  :各関連システムへ送信;
  if (部店新規・廃止?) then (はい)
    :メール送信;
  else (いいえ)
  endif
  :テーブル更新前に物理コピーを作成;
end fork

stop
@enduml
----

==== 3.3.4. クラス図
[plantuml, class-diagram, png]
----
@startuml
class Deployment {
  processDeployment()
  updateReferenceDB()
  createDummyGrTable()
}

class Batch {
  processBatch()
  manageDormantAndSecondedDept()
}

class Send {
  processSend()
  getReferenceData()
  getDummyGrData()
  createCSVFile()
  validateData()
  sendToRelatedSystems()
  sendEmail()
  createPhysicalCopy()
}

class ReferenceDB {
  data
  update()
  read()
  copy()
}

class DummyGrInfo {
  data
  read()
}

Deployment --> ReferenceDB
Deployment --> DummyGrInfo
Batch --> ReferenceDB
Send --> ReferenceDB
Send --> DummyGrInfo
@enduml
----

=== 3.4. クラス定義

[cols="1,3", options="header"]
|===
| クラス名      | 説明
| Deployment    | 反映処理を行うクラス。リファレンスDBとダミー課Grテーブルを更新する。
| Batch         | 一括処理を行うクラス。休職・本部詰の部署情報を作成・削除する。
| Send          | 送信処理を行うクラス。CSVファイルを作成し、関連システムへ送信する。
| ReferenceDB   | リファレンスDBを表すクラス。データの更新、読み取り、コピーを行う。
| DummyGrInfo   | ダミー課Gr情報を表すクラス。データの読み取りを行う。
|===

== 4. 入出力データ

=== 4.1. 入力

==== 4.1.1. pickleファイル（パターン処理後の永続化データ）
- パターン編集処理の出力であるDB更新情報明細を含むpickleファイルを入力とする。

=== 4.2. 出力

==== 4.2.1. pickleファイル（反映処理前の永続化データ）
- 反映処理前のリファレンスDBとダミー課Grテーブルの情報を含むpickleファイルを出力する。

==== 4.2.2. pickleファイル（反映処理後の永続化データ）
- 反映処理後のリファレンスDBとダミー課Grテーブルの情報を含むpickleファイルを出力する。

==== 4.2.3. csvファイル
- 関連システムに連携するためのCSVファイルを出力する。

==== 4.2.4. 制御ファイル
- 関連システムに連携するための制御ファイルを出力する。

== 5. エラー処理

=== 5.1. 反映処理のエラーパターンと対処方法
- リファレンスDBの更新に失敗した場合、エラーログを出力し、管理者に通知する。
- ダミー課Grテーブルの作成に失敗した場合、エラーログを出力し、管理者に通知する。

=== 5.2. 一括処理のエラーパターンと対処方法
- 休職・本部詰の部署情報の作成・削除に失敗した場合、エラーログを出力し、管理者に通知する。

=== 5.3. 送信処理のエラーパターンと対処方法
- CSVファイルの作成に失敗した場合、エラーログを出力し、管理者に通知する。
- バリデーションチェックで異常が検出された場合、エラーログを出力し、管理者に通知する。
- 関連システムへの送信に失敗した場合、エラーログを出力し、管理者に通知する。
- メール送信に失敗した場合、エラーログを出力し、管理者に通知する。

== 6. 例外設計

=== 6.1. 例外一覧

[cols="1,2,2,2", options="header"]
|===
| 管理番号 | 発生事象定義 | 原因定義 | 対処指針
| E-001    | リファレンスDBの更新失敗 | ネットワーク障害、DBサーバ障害など | エラーログ出力、管理者通知
| E-002    | ダミー課Grテーブルの作成失敗 | ネットワーク障害、DBサーバ障害など | エラーログ出力、管理者通知
| E-003    | 休職・本部詰の部署情報の作成・削除失敗 | ネットワーク障害、DBサーバ障害など | エラーログ出力、管理者通知
| E-004    | CSVファイルの作成失敗 | ディスク容量不足、ファイルシステム障害など | エラーログ出力、管理者通知
| E-005    | バリデーションチェックの異常検出 | 不正なデータ、フォーマット不一致など | エラーログ出力、管理者通知
| E-006    | 関連システムへの送信失敗 | ネットワーク障害、関連システムの障害など | エラーログ出力、管理者通知
| E-007    | メール送信失敗 | メールサーバ障害、ネットワーク障害など | エラーログ出力、管理者通知
|===

== 7. ロギング設計

=== 7.1. ファイル取り込み記録
- 取り込んだファイル名、取り込み日時、取り込み結果（成功/失敗）をログに記録する。

=== 7.2. Validation/整合性チェックエラーのエラー位置特定情報
- エラーが発生したCSVファイル名、行番号、列番号、エラー内容をログに記録する。

== 8. 運用記述

=== 8.1. 本番環境での実施
- 本番環境で反映・送信処理を実施する。

=== 8.2. データの取扱

==== 8.2.1. データ反映前のpickleファイルの物理コピー
- データ反映前に、リファレンスDBとダミー課Grテーブルのpickleファイルを物理コピーし、バックアップを取得する。

==== 8.2.2. コピーファイルのリテンション
- バックアップとして取得したpickleファイルのリテンションは、システム設定に従う。

=== 8.3. 実行スケジュール

==== 8.3.1. JP1での自動スケジュール設定
- 反映・送信処理の実行スケジュールをJP1で自動設定する。

==== 8.3.2. 日次実行
- 反映・送信処理は日次で実行する。

== 9. 別紙
- データレイアウト一覧
- データ制御パターン一覧
- 一括処理内容一覧
- CSV出力後のValidation／整合性チェック事項一覧
----
