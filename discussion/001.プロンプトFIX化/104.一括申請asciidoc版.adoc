= 一括申請フェーズ

== 1. 要件定義

=== 1.1. 要求分析
本サブセクションでは、会社の部署情報（部署コード、部署名など）が入っているデータを保持し、それに対する変更申請を管理するシステムの要求分析を行います。システムは、一括申請、受付、パターン処理、反映・送信の4つのフェーズを持ち、各フェーズにおいて必要な機能を実装します。一括申請フェーズでは、申請部署からExcelによる部署情報更新データの提供を受け、新設・変更・廃止の3パターンに対応します。また、申請データに対するValidation／整合性チェックを行い、申請データのフォーマットを統一します。

=== 1.2. 移植での改善方針

==== 1.2.1. 一括利用申請ファイルの項目見直し
一括利用申請ファイルの項目を見直し、必要な情報のみを含めるようにします。これにより、データ処理の効率化と品質向上を図ります。

==== 1.2.2. 一括利用申請ファイル取り込み後、統一レイアウトへ変換
一括利用申請ファイルを取り込んだ後、統一レイアウトへ変換することで、後続処理でのデータ扱いを容易にします。

==== 1.2.3. 単一責務化
各機能の責務を明確化し、単一責務の原則に従ってシステムを設計します。これにより、保守性と拡張性を向上させます。

==== 1.2.4. 編集処理の委譲
一括申請フェーズでは、編集処理を行わず、後続の受付処理やパターン処理に委譲します。これにより、各フェーズの責務を明確にし、システムの保守性を向上させます。

==== 1.2.5. Validation/整合性チェックの引き受け
受付処理で行われているValidation/整合性チェックを一括申請フェーズで引き受けることで、データ品質を早期に担保し、後続処理の効率化を図ります。

== 2. 機能定義

=== 2.1. 機能概要
一括申請フェーズは、申請部署からのExcelファイルによる部署情報更新データを受領し、データの取り込み、バリデーションチェック、整合性チェック、データ変換、および永続化を行います。本フェーズは、システム全体のデータ品質を確保し、後続フェーズの処理を円滑に進めるための重要な役割を担っています。

=== 2.2. 機能要件

[cols="1,1,3", options="header"]
|===
| No. | 機能要件 | 説明
| 2.2.1. | Excelデータ入力 | 申請部署からのExcelファイルを入力として受け取ります。Excelファイルには、新設・変更・廃止の3種類の申請パターンが含まれています。
| 2.2.2. | Validationチェック | 入力されたExcelデータに対して、項目単体の型や範囲のチェックを行います。これにより、データの品質を確保します。
| 2.2.3. | 整合性チェック | Validationチェックに加えて、別項目との連携チェックや、他のテーブルデータとの整合性チェックを行います。
| 2.2.4. | DataFrameへ変換 | チェックに合格したExcelデータをDataFrameへ変換します。これにより、データ処理の効率化を図ります。
| 2.2.5. | 統合フォーマットへ変換 | DataFrameを統合フォーマットへ変換します。統合フォーマットは、後続処理で扱いやすいように設計されています。
| 2.2.6. | データ永続化(pickle) | 統合フォーマットへ変換したデータをpickle形式で永続化します。これにより、後続処理で効率的にデータを利用できるようにします。
|===

=== 2.3. 業務ルール

申請パターンには、新設、変更、廃止の3種類がある。
部署コードと課コードは変更されない。
部に対する変更申請が行われた場合、その配下の課のレコードが持つ部名も最新化する。

=== 2.4. エラー処理

Validationチェックでエラーが発生した場合、エラーを記録し、該当のデータを除外して処理を継続する。
整合性チェックでエラーが発生した場合、エラーを記録し、該当のデータを除外して処理を継続する。
エラー発生時には、適切なログを出力し、管理者へ通知する。

=== 2.5. 機能詳細

一括申請フェーズの機能詳細については、「資料セクション」を参照してください。

=== 2.6. 処理フロー図

以下は、一括申請フェーズの処理フロー図です。

[plantuml, target=process_flow]
@startuml
start
:Excelデータ入力;
:Validationチェック;
if (項目単体の型、範囲チェックOK?) then (yes)
:整合性チェック;
if (別項目との連携チェック、他テーブルデータ保有値とのチェックOK?) then (yes)
:DataFrameへ変換;
:統合フォーマットへ変換;
:データ永続化(pickle);
stop
else (no)
stop
endif
else (no)
stop
endif
@enduml

== 3. システム方式設計

=== 3.1. システム構成

以下は、一括申請フェーズのシステム構成図です。

[plantuml, target=system_configuration]
----
@startuml
package "一括申請" {
[Excelデータ入力] as input
[Validationチェック] as validation
[整合性チェック] as consistency
[DataFrameへ変換] as df_convert
[統合フォーマットへ変換] as format_convert
[データ永続化(pickle)] as persistence
input --> validation
validation --> consistency
consistency --> df_convert
df_convert --> format_convert
format_convert --> persistence
}
@enduml
----

=== 3.2. ソフトウェア構成

一括申請フェーズのソフトウェア構成については、「資料セクション」を参照してください。

=== 3.3. インターフェース設計

==== 3.3.1. 内部インターフェース

一括申請フェーズの内部インターフェースについては、「資料セクション」を参照してください。

==== 3.3.2. 外部インターフェース

一括申請フェーズの外部インターフェースについては、「資料セクション」を参照してください。

=== 3.4. データ設計

==== 3.4.1. ER図

一括申請フェーズのER図については、「資料セクション」を参照してください。

==== 3.4.2. テーブル定義

一括申請フェーズのテーブル定義については、「資料セクション」を参照してください。

=== 3.5. アーキテクチャ設計

一括申請フェーズのアーキテクチャ設計については、「資料セクション」を参照してください。

== 4. 入出力データ

=== 4.1. 入力 Excelファイル

申請部署から提供されるExcelファイルが入力データとなります。Excelファイルの詳細については、「資料セクション」を参照してください。

=== 4.2. 出力 pickleファイル
一括申請フェーズの処理結果は、pickle形式で永続化されます。pickleファイルの詳細については、「資料セクション」を参照してください。

== 5. 例外設計

=== 5.1. 例外一覧

一括申請フェーズで発生する可能性のある例外は、以下の通りです。
[cols="1,1,1,2", options="header"]
|===
| 管理番号 | 発生事象 | 原因 | 対処指針
| E001 | Validationエラー | 入力データの型不一致 | エラーを記録し、該当のデータを除外して処理を継続
| E002 | 整合性エラー | データ間の不整合 | エラーを記録し、該当のデータを除外して処理を継続
|===
詳細については、「資料セクション」を参照してください。

== 6. ロギング設計

=== 6.1. 取り込み記録
一括申請フェーズでは、処理したExcelファイルの取り込み記録を残します。取り込み記録の詳細については、「資料セクション」を参照してください。

=== 6.2. エラー位置特定情報

==== 6.2.1. Excelファイル、シート名、行・列位置、値、正しい型や値の期待値など

Validationエラーや整合性エラーが発生した場合、エラーが発生したExcelファイル名、シート名、行・列位置、値、および期待される型や値を記録します。詳細については、「資料セクション」を参照してください。

== 7. セキュリティ要件

一括申請フェーズのセキュリティ要件については、「資料セクション」を参照してください。

== 8. 運用記述

=== 8.1. 実行環境

==== 8.1.1. リグレ環境で実施

一括申請フェーズの処理は、リグレッション環境で実施します。

=== 8.2. データの取扱

==== 8.2.1. 受付データの破棄

一括申請フェーズで受け付けたデータは保管せず、処理後は破棄します。

==== 8.2.2. 処理済結果のリポジトリ管理

一括申請フェーズの処理済結果は、リポジトリで管理します。

=== 8.3. 実行スケジュール

==== 8.3.1. Jenkinsによる自動スケジュール設定

一括申請フェーズの処理は、Jenkinsを用いて自動スケジュールで実行します。

==== 8.3.2. 日次実行

一括申請フェーズの処理は、日次で実行します。

==== 8.3.3. マニュアル実行

必要に応じて、マニュアルでJenkinsを実行することもできます。

== 9. 別紙

一括申請フェーズの詳細な資料については、「資料セクション」を参照してください。

