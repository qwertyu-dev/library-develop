= 部店・課グループ情報管理機能 設計書

== 1. 機能概要
=== 1.1. 目的
本機能は、人事、海外、関連の3部門から申請されるExcelファイルを受信し、部店及び配下の課Gr情報の管理を行うことを目的とする。申請データのチェック、統一レイアウトへの変換、変換結果の保存を行い、各部門からの申請を一元的に管理する。これにより、部店・課Gr情報の整合性を確保し、効率的な情報管理を実現する。

=== 1.2. 機能範囲
- 社内の文書承認回付システムからExcelファイルを受信する
- 受信したファイルを一時ストレージに保存する
- 申請データのバリデーションと整合性チェックを行う
- エラーがある場合は報告書を生成する
- 異なるフォーマットを統一レイアウトに変換する
- 変換結果をpickle形式で出力する
- 変換結果をEC2内のストレージに保存する

=== 1.3. 業務フロー
[plantuml]
----
@startuml
start
:Excelファイル受信;
:一時ストレージに保存;
if (データ検証) then (OK)
  :統一レイアウトに変換;
  :pickle形式で出力;
  :EC2ストレージに保存;
else (NG)
  :エラー報告書生成;
endif
stop
@enduml
----

== 2. 機能要件
=== 2.1. ファイル受信・一時保存層

[cols="1,1,3"]
|===
| 機能ID | 機能名 | 説明
| 2.1.1 | Excelファイルの受信 | 社内の文書承認回付システムからExcelファイルを受信する。人事、海外、関連の3部門からそれぞれ異なるフォーマットのファイルが送信される。ファイル受信の際、送信元部門を識別し、適切な処理を行う。
| 2.1.2 | 一時ストレージへの保存 | 受信したExcelファイルを一時ストレージに保存する。一時ストレージは、EC2インスタンス内に用意し、一定期間経過後に自動的に削除される。
|===

=== 2.2. データ検証層

[cols="1,1,3"]
|===
| 機能ID | 機能名 | 説明
| 2.2.1 | データのバリデーション | 受信したExcelファイルのデータに対して、pydanticを使用してバリデーションを行う。各項目の型、必須項目、文字列長、値の範囲などをチェックする。バリデーション一覧は別紙に記載する。
| 2.2.2 | 整合性チェック | バリデーションに加えて、データの整合性チェックを行う。複数項目の組み合わせによる整合性や、外部データを利用したチェックを実施する。整合性チェック一覧は別紙に記載する。
| 2.2.3 | エラー報告書の生成 | バリデーションや整合性チェックでエラーが発生した場合、エラー報告書を生成する。エラー報告書は、ログから確認できるようにし、特別な加工は行わない。
|===

=== 2.3. データ変換層

[cols="1,1,3"]
|===
| 機能ID | 機能名 | 説明
| 2.3.1 | 統一レイアウトへの変換 | 人事、海外、関連それぞれの申請データを、統一レイアウトに変換する。変換処理は、別紙に記載するマッピング定義に従って行う。
| 2.3.2 | pickle形式での出力 | 変換後のデータをpandas DataFrameに格納し、pickle形式で出力する。
|===

=== 2.4. 結果保存層

[cols="1,1,3"]
|===
| 機能ID | 機能名 | 説明
| 2.4.1 | 変換結果のEC2ストレージへの保存 | pickle形式で出力された変換結果を、EC2インスタンス内のストレージに保存する。保存先のパスは、日付や部門などの情報を含むものとし、一意に識別できるようにする。
|===

== 3. インターフェース設計
=== 3.1. 外部インターフェース

[cols="1,1,3"]
|===
| インターフェースID | インターフェース名 | 説明
| 3.1.1 | 社内文書承認回付システムとのインターフェース | 人事、海外、関連それぞれの申請ファイルのレイアウト定義は以下の通りとする。 +
- 人事部門：別紙A +
- 海外部門：別紙B +
- 関連部門：別紙C
|===

=== 3.2. 内部インターフェース

[cols="1,1,3"]
|===
| インターフェースID | インターフェース名 | 説明
| 3.2.1 | レイヤー間インターフェース | 各層間のデータ受け渡しは、pickle形式で行う。データ構造は、4章のデータ設計に記載する。
|===

== 4. データ設計
本機能で扱うデータは、以下の3種類に分類される。

[cols="1,3"]
|===
| データ種類 | 説明
| 入力データ | 人事、海外、関連の3部門から受信するExcelファイルのデータ。各部門のレイアウト定義に従う。
| 中間データ | 統一レイアウトに変換後のデータ。pandas DataFrameに格納される。
| 出力データ | pickle形式で出力されるデータ。中間データと同一の構造を持つ。
|===