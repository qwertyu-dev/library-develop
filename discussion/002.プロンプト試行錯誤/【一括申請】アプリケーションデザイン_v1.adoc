:toc:
:toclevels: 5

== 機能詳細（約11000文字）

=== データ検証モジュール

==== 処理概要

データ検証モジュールは、文書回付システムからアップロードされたExcelファイルに対して、データの整合性と妥当性を検証する機能を提供します。このモジュールは、pydanticライブラリを使用して、データの型、範囲、相関関係などのルールに基づいて検証を行います。検証対象には、単一項目の型や範囲のチェックだけでなく、複数項目間の相関関係や外部データを利用した検証も含まれます。検証の結果、エラーが発見された場合は、エラーの内容と位置を特定し、適切なエラーメッセージを生成します。検証に合格したデータは、次のフォーマット変換モジュールに受け渡されます。

==== インターフェース

[cols="1,1,1,1"]
|===
|インターフェース名 |説明 |I/O |データ型

|validate_data
|アップロードされたExcelファイルのデータを検証する
|I
|pandas.DataFrame

|
|
|O
|ValidationResult
|===

==== 処理フロー

[plantuml]
----
@startuml
start
:Excelファイルを読み込む;
:データをDataFrameに変換する;
:pydanticを使用してデータを検証する;
if (検証に合格?) then (はい)
  :検証結果をValidationResultに設定する;
  :次のモジュールに渡す;
else (いいえ)
  :エラー内容と位置を特定する;
  :エラーメッセージを生成する;
  :検証結果をValidationResultに設定する;
  stop
endif
stop
@enduml
----

==== エラー処理

データ検証モジュールでは、以下のようなエラーが発生する可能性があります。

1. データ型のエラー：期待される型と実際のデータの型が一致しない場合。
2. 範囲エラー：データが定義された範囲内に収まっていない場合。
3. 相関エラー：複数の項目間で期待される相関関係が満たされていない場合。
4. 外部データとの不整合：外部データを利用した検証で、データの整合性が取れていない場合。

エラーが発生した場合、エラーの内容と位置を特定し、適切なエラーメッセージを生成します。エラーメッセージには、エラーの種類、発生した場所（行と列）、およびエラーの詳細が含まれます。これらの情報は、ValidationResult オブジェクトに格納され、呼び出し元に返されます。

==== 検証ルール

[cols="1,1,1,1"]
|===
|ルール名 |説明 |対象項目 |条件

|データ型チェック
|各項目のデータ型が期待される型と一致すること
|全項目
|項目ごとに定義された型

|必須チェック
|必須項目が空でないこと
|必須項目
|値が存在する

|範囲チェック
|数値項目が定義された範囲内であること
|数値項目
|項目ごとに定義された最小値と最大値

|相関チェック
|複数項目間の相関関係が満たされていること
|関連項目
|項目間の関係性

|外部データチェック
|外部データを利用した整合性チェック
|関連項目
|外部データとの整合性
|===

=== フォーマット変換モジュール

==== 処理概要

フォーマット変換モジュールは、データ検証モジュールで検証されたデータを、システム内で統一された形式に変換する機能を提供します。変換対象のデータは、pandas.DataFrameオブジェクトとして受け取ります。変換処理では、事前に定義された変換ルールに従って、各項目のデータ型や表現形式を変換します。変換後のデータは、再びpandas.DataFrameオブジェクトとして、次のデータ永続化モジュールに受け渡されます。

==== インターフェース

[cols="1,1,1,1"]
|===
|インターフェース名 |説明 |I/O |データ型

|convert_format
|検証済みのデータを統一フォーマットに変換する
|I
|pandas.DataFrame

|
|
|O
|pandas.DataFrame
|===

==== 処理フロー

[plantuml]
----
@startuml
start
:検証済みのデータを受け取る;
:変換ルールを読み込む;
:各項目のデータ型を変換する;
:各項目の表現形式を変換する;
:変換後のデータをDataFrameに格納する;
:次のモジュールに渡す;
stop
@enduml
----

==== エラー処理

フォーマット変換モジュールでは、以下のようなエラーが発生する可能性があります。

1. 変換ルールの不備：変換ルールが適切に定義されていない場合。
2. データ型の不整合：変換先のデータ型に適合しないデータが存在する場合。

エラーが発生した場合、エラーの内容と位置を特定し、適切なエラーメッセージを生成します。エラーメッセージには、エラーの種類、発生した場所（行と列）、およびエラーの詳細が含まれます。これらの情報は、呼び出し元に返されます。

==== 変換ルール

[cols="1,1,1,1,1"]
|===
|項目名 |変換前のデータ型 |変換後のデータ型 |変換前の表現形式 |変換後の表現形式

|項目A
|string
|integer
|"1"
|1

|項目B
|string
|datetime
|"2023/04/01"
|datetime(2023, 4, 1)

|項目C
|integer
|string
|1000
|"1,000"
|===

=== データ永続化モジュール

==== 処理概要

データ永続化モジュールは、フォーマット変換モジュールで変換されたデータを、システムで永続的に保存するための機能を提供します。保存対象のデータは、pandas.DataFrameオブジェクトとして受け取ります。データの保存先は、AWS EC2インスタンス内のストレージであり、データはpickle形式で保存されます。保存処理では、データの整合性を確保するために、一時ファイルへの書き込みと、書き込み完了後のファイル名の変更を行います。

==== インターフェース

[cols="1,1,1,1"]
|===
|インターフェース名 |説明 |I/O |データ型

|save_data
|変換済みのデータをpickle形式で保存する
|I
|pandas.DataFrame
|===

==== 処理フロー

[plantuml]
----
@startuml
start
:変換済みのデータを受け取る;
:一時ファイル名を生成する;
:一時ファイルにデータをpickle形式で書き込む;
:書き込みが完了したら、一時ファイルを目的のファイル名にリネームする;
stop
@enduml
----

==== エラー処理

データ永続化モジュールでは、以下のようなエラーが発生する可能性があります。

1. ディスク容量不足：データの保存先のストレージの空き容量が不足している場合。
2. ファイル書き込みエラー：ファイルの書き込み中に、何らかの理由でエラーが発生した場合。

エラーが発生した場合、エラーの内容をログに記録し、適切なエラーメッセージを呼び出し元に返します。

==== データ構造

データ永続化モジュールでは、フォーマット変換モジュールから受け取ったpandas.DataFrameオブジェクトを、pickle形式で保存します。pickle形式は、Pythonのオブジェクトを直列化し、バイナリ形式で保存するための標準的な方法です。これにより、データの読み込み時に、元のDataFrameオブジェクトを容易に復元することができます。

== 外部インターフェース

=== 文書回付システム

文書回付システムは、申請者からのExcelファイルを受領するための外部システムです。申請者は、文書回付システムを通じて、所定のフォーマットで作成したExcelファイルを提出します。文書回付システムは、受領したファイルを一時的に保存し、定期的にまとめて、本システムのExcelアップロードモジュールに引き渡します。

== 課題と対応方針

=== 現状の課題

1. 申請フォーマットの不統一
現在、各部門からの申請書のフォーマットがバラバラであるため、データの取り込みや処理に手間がかかっています。統一されたフォーマットを導入することで、効率的なデータ処理が可能になります。

2. 手作業によるデータ検証
現状では、申請データの検証を手作業で行っているため、作業に時間がかかり、ミスも発生しやすくなっています。自動化された検証機能を導入することで、作業効率の向上と品質の向上が期待できます。

3. データ変換の負荷
異なるフォーマットから統一フォーマットへのデータ変換処理に、現状では大きな負荷がかかっています。変換処理の効率化と、変換ルールの管理方法の改善が必要です。

=== 対応方針

1. 統一フォーマットの導入
各部門に対して、統一された申請フォーマットを導入します。フォーマットの設計には、各部門の要件を考慮しつつ、データ処理の効率化を重視します。導入に際しては、十分な説明と移行期間を設けることで、円滑な移行を図ります。

2. 自動データ検証の実装
pydanticライブラリを活用し、申請データの自動検証機能を実装します。検証ルールは、各項目のデータ型や範囲、相関関係などを考慮して設計します。検証結果はわかりやすいレポート形式で出力し、申請者にフィードバックできるようにします。

3. 変換処理の効率化
データ変換処理のボトルネックを分析し、処理の並列化や、変換ライブラリの活用などにより、処理速度の改善を図ります。また、変換ルールの管理方法を見直し、ルールの更新や保守が容易になるような仕組みを導入します。

== 付録

=== テーブル定義書

（省略）

=== 外部インターフェース仕様書

（省略）