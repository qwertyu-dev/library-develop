Here is the document output in asciidoc format:

= 機能設計書: ３部門からの申請に基づく部店及び配下の課Gr情報の管理機能

== 1. はじめに
=== 1.1. 目的
本ドキュメントは、３部門からの申請に基づく部店及び配下の課Gr情報の管理機能における、移植システムの機能設計について記述したものである。本機能は、人事、海外、関連の３部門からExcelで申請を受け付け、申請データのチェック、統一レイアウトへの変換、変換後データの保存を行う。本ドキュメントでは、機能概要、機能詳細、インターフェース要件、入出力データ、例外設計、ロギング設計、設計上の制約事項、運用記述について説明する。

=== 1.2. 適用範囲
本ドキュメントが適用される範囲は、３部門からの申請に基づく部店及び配下の課Gr情報の管理機能における、移植システムの機能設計とする。

== 2. 要件定義
=== 2.1. 要求分析
３部門（人事、海外、関連）からExcelで申請があり、各部門の申請シートフォーマットが異なっている。Excelファイルは社内の文書承認回付システム経由で受領し、Excelをやり取りするためのWebインターフェースは不要である。申請データに対してValidation及び整合性チェックを行い、統一レイアウトに変換する。変換後のデータはpickle形式で出力し、OS下のフォルダに保存する。申請データ件数は高々数百件程度であり、申請区分は新設・変更・廃止となる。マスターデータへの反映は本機能では担当しない。

=== 2.2. 移植での改善方針
移植での改善方針は以下の通りである。

- 一括利用申請ファイルの項目見直し
- 一括利用申請ファイル取り込み後、統一レイアウトへ変換する
- 単一責務化
- 編集処理を後続フェーズの受付処理やパターン処理に委譲する
- 受付処理で行われているValidation/整合性チェックを引き受ける

== 3. 機能概要
=== 3.1. 機能一覧
本機能の機能一覧を以下に示す。

- Excelデータ取り込み
- Validation/整合性チェック
- 統一レイアウト変換
- 統一レイアウトデータ保存
- pickle形式でのデータ保存

=== 3.2. 機能概要図
本機能の機能概要図を以下に示す。各層の役割と関連性が明確になるよう、コンポーネント図で表現する。

[plantuml]
----
@startuml
package "データ取り込み層" {
  [Excelデータ取り込み]
  [Validation/整合性チェック]
  [統一レイアウト変換]
}

package "データ保存層" {
  [統一レイアウトデータ保存]
  [pickle形式でのデータ保存]  
}

package "アプリケーション層" {
  [データ取り込み制御]
  [データ保存制御]
}

[アプリケーション層] -right-> [データ取り込み層]
[アプリケーション層] -right-> [データ保存層]
@enduml
----

== 4. 機能詳細
=== 4.1. データ取り込み層
データ取り込み層では、各部門からのExcelファイルを読み込み、Validation/整合性チェックを実施し、統一レイアウトに変換する。

==== 4.1.1. Excelデータ取り込み
各部門からのExcelファイルを読み込む。読み込み対象のファイルは、社内の文書承認回付システム経由で受領する。

==== 4.1.2. Validation/整合性チェック
読み込んだExcelデータに対して、Validation及び整合性チェックを行う。Validationでは、単一項目の型、範囲チェックを行う。整合性チェックでは、複数項目による型・範囲・相関チェック、外部データを利用してのチェックを行う。Validation/整合性チェックにはpythonのpydanticライブラリを使用し、部品作成に注力できるようにする。

==== 4.1.3. 統一レイアウト変換
Validation/整合性チェックが完了したデータを、統一レイアウトに変換する。統一レイアウトは、移植システムで定義された共通のデータレイアウトである。

=== 4.2. データ保存層 
データ保存層では、統一レイアウトに変換されたデータを保存する。

==== 4.2.1. 統一レイアウトデータ保存
統一レイアウトに変換されたデータを保存する。

==== 4.2.2. pickle形式でのデータ保存
統一レイアウトに変換されたデータをpickle形式で保存する。保存先はOS下のフォルダとし、外部保有は想定しない。

=== 4.3. アプリケーション層
アプリケーション層では、データ取り込み層とデータ保存層の制御を行う。

==== 4.3.1. データ取り込み制御
データ取り込み層のExcelデータ取り込み、Validation/整合性チェック、統一レイアウト変換を制御する。

==== 4.3.2. データ保存制御
データ保存層の統一レイアウトデータ保存、pickle形式でのデータ保存を制御する。

== 5. インターフェース要件
=== 5.1. 外部インターフェース
本機能の外部インターフェースは存在しない。管理者は既存の運用管理システムを介して本機能を利用する。

=== 5.2. 内部インターフェース
==== 5.2.1. データ取り込み層 - アプリケーション層間インターフェース
データ取り込み層とアプリケーション層間のインターフェースを以下に示す。

[cols="1,1,4"]
|===
|No. |インターフェース名 |説明

|1
|Excelデータ取り込み
|アプリケーション層からExcelデータ取り込みを指示する

|2
|Validation/整合性チェック
|アプリケーション層からValidation/整合性チェックを指示する

|3
|統一レイアウト変換
|アプリケーション層から統一レイアウト変換を指示する
|===

==== 5.2.2. データ保存層 - アプリケーション層間インターフェース
データ保存層とアプリケーション層間のインターフェースを以下に示す。

[cols="1,1,4"]
|===
|No. |インターフェース名 |説明

|1
|統一レイアウトデータ保存
|アプリケーション層から統一レイアウトデータ保存を指示する

|2
|pickle形式でのデータ保存
|アプリケーション層からpickle形式でのデータ保存を指示する
|===

== 6. 入出力データ
=== 6.1. 入力 Excelファイル
入力は、各部門から提出されるExcelファイルである。Excelファイルのフォーマットは各部門で異なる。各部門のフォーマットについては、別紙「Excelファイルフォーマット定義書」を参照。

=== 6.2. 出力 pickleファイル
出力は、統一レイアウトに変換されたデータをpickle形式で保存したファイルである。統一レイアウトの詳細については、別紙「統一レイアウト定義書」を参照。

== 7. 例外設計
=== 7.1. 例外一覧 
例外一覧を以下に示す。例外発生時には、適切なエラーメッセージをログに出力し、処理を中断する。

[cols="1,1,4"]
|===
|No. |例外名 |説明

|1
|Validationエラー
|Validationでエラーが検出された場合に発生する

|2
|整合性チェックエラー
|整合性チェックでエラーが検出された場合に発生する

|3
|ファイル読み込みエラー
|Excelファイルの読み込みに失敗した場合に発生する

|4
|ファイル保存エラー
|pickle形式でのデータ保存に失敗した場合に発生する
|===

== 8. ロギング設計
ロギング設計を以下に示す。

- どのファイルをいつ取り込みしたかの記録を行う
- Validation/整合性チェックエラーが発生した場合、エラー位置特定情報をログに出力する
  - 該当のExcelファイル名、シート名、行・列位置、値、正しい型想定・値など

== 9. 設計上の制約事項
=== 9.1. 使用するライブラリ・フレームワーク
使用するライブラリ・フレームワークは以下の通りとする。

- pydantic: データValidation/整合性チェックに使用
- openpyxl: Excelファイルの読み込みに使用
- pytest: ユニットテストに使用

== 10. 運用記述
運用記述を以下に示す。

=== 10.1. リグレ環境で実施する
本機能のテストはリグレッション環境で実施する。

=== 10.2. データの取扱
受付データは保管せず、処理済結果はリポジトリ管理する。セキュリティ上の理由から、受付データの長期保管は行わない。

=== 10.3. 実行スケジュール
実行スケジュールはJenkinsで自動スケジュール設定する。スケジュールの詳細については、別途定義する。

=== 10.4. マニュアル対応
マニュアル対応は行わない。本機能の利用方法については、関連部門への説明会を実施する。

== 11. 別紙
- Excelファイルフォーマット定義書
- 統一レイアウト定義書

[plantuml]
----
@startuml
control アプリケーション層
entity データ取り込み層
entity データ保存層

アプリケーション層 -> データ取り込み層: Excelデータ取り込み
データ取り込み層 -> データ取り込み層: Validation/整合性チェック
データ取り込み層 -> データ取り込み層: 統一レイアウト変換
アプリケーション層 -> データ保存層: 統一レイアウトデータ保存
データ保存層 -> データ保存層: pickle形式でのデータ保存
@enduml
----

本シーケンス図は、アプリケーション層からデータ取り込み層、データ保存層への制御フローを表現している。データ取り込み層では、Excelデータの取り込み、Validation/整合性チェック、統一レイアウト変換が行われる。データ保存層では、統一レイアウトデータの保存とpickle形式でのデータ保存が行われる。

[plantuml]
----
@startuml
start
:Excelデータ取り込み;
:Validation/整合性チェック;
if (チェック結果OK?) then (yes)
  :統一レイアウト変換;
  :統一レイアウトデータ保存;
  :pickle形式でのデータ保存;
else (no)
  :エラー処理;
endif
stop
@enduml
----

本アクティビティ図は、本機能の処理フローを表現している。まず、Excelデータを取り込み、Validation/整合性チェックを行う。チェック結果がOKであれば、統一レイアウト変換、統一レイアウトデータ保存、pickle形式でのデータ保存を行う。チェック結果がNGであれば、エラー処理を行う。
